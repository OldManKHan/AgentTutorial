# ç¬¬ä¸€ç« ï¼šä¸Šä¸‹æ–‡å·¥ç¨‹

> ğŸ¯ æœ¬ç« ç›®æ ‡ï¼šæŒæ¡ä¸Šä¸‹æ–‡çª—å£ç®¡ç†æŠ€æœ¯ï¼Œå­¦ä¼šåœ¨æœ‰é™çš„ Token é¢„ç®—å†…é«˜æ•ˆç»„ç»‡ä¿¡æ¯

## ä¸ºä»€ä¹ˆéœ€è¦ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼Ÿ

æƒ³è±¡ä½ æ­£åœ¨å’Œä¸€ä¸ªè®°å¿†åŠ›æœ‰é™çš„åŠ©æ‰‹å¯¹è¯ã€‚æ¯æ¬¡å¯¹è¯ï¼Œä»–åªèƒ½è®°ä½æœ€è¿‘çš„ N ä¸ªå­—ã€‚å¦‚æœå¯¹è¯å¤ªé•¿ï¼Œæ—©æœŸçš„å†…å®¹å°±ä¼šè¢«"é—å¿˜"ã€‚

è¿™å°±æ˜¯ LLM é¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜â€”â€”**ä¸Šä¸‹æ–‡çª—å£é™åˆ¶**ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸Šä¸‹æ–‡çª—å£ç¤ºæ„å›¾                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              ä¸Šä¸‹æ–‡çª—å£ (Context Window)             â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚ System  â”‚ â”‚ å†å²    â”‚ â”‚ å½“å‰    â”‚ â”‚ è¾“å‡º    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚ Prompt  â”‚ â”‚ å¯¹è¯    â”‚ â”‚ è¾“å…¥    â”‚ â”‚ é¢„ç•™    â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ€» Token é™åˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  é—®é¢˜ï¼šå½“å†å²å¯¹è¯è¶Šæ¥è¶Šé•¿ï¼Œå¦‚ä½•åœ¨æœ‰é™ç©ºé—´å†…ä¿ç•™å…³é”®ä¿¡æ¯ï¼Ÿ   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸Šä¸‹æ–‡å·¥ç¨‹**å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„æŠ€æœ¯é›†åˆï¼šå¦‚ä½•åœ¨æœ‰é™çš„ä¸Šä¸‹æ–‡çª—å£ä¸­ï¼Œé«˜æ•ˆåœ°ç»„ç»‡å’Œç®¡ç†ä¿¡æ¯ï¼Œè®© Agent æ—¢èƒ½"è®°ä½"é‡è¦å†…å®¹ï¼Œåˆä¸è¶…å‡º Token é™åˆ¶ã€‚

---

## 1. Token åŸºç¡€

### ä»€ä¹ˆæ˜¯ Tokenï¼Ÿ

Token æ˜¯ LLM å¤„ç†æ–‡æœ¬çš„åŸºæœ¬å•ä½ã€‚å®ƒä¸æ˜¯å­—ç¬¦ï¼Œä¹Ÿä¸æ˜¯å•è¯ï¼Œè€Œæ˜¯ä»‹äºä¸¤è€…ä¹‹é—´çš„"å­è¯"å•å…ƒã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Token åˆ‡åˆ†ç¤ºä¾‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  è‹±æ–‡ç¤ºä¾‹ï¼š                                                 â”‚
â”‚  "Hello, world!" â†’ ["Hello", ",", " world", "!"]           â”‚
â”‚                     4 ä¸ª Token                              â”‚
â”‚                                                             â”‚
â”‚  ä¸­æ–‡ç¤ºä¾‹ï¼š                                                 â”‚
â”‚  "ä½ å¥½ä¸–ç•Œ" â†’ ["ä½ ", "å¥½", "ä¸–", "ç•Œ"]                      â”‚
â”‚               4 ä¸ª Tokenï¼ˆä¸­æ–‡é€šå¸¸ 1 å­— = 1-2 Tokenï¼‰       â”‚
â”‚                                                             â”‚
â”‚  ä»£ç ç¤ºä¾‹ï¼š                                                 â”‚
â”‚  "function hello()" â†’ ["function", " hello", "(", ")"]     â”‚
â”‚                        4 ä¸ª Token                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç»éªŒæ³•åˆ™**ï¼š
- è‹±æ–‡ï¼šçº¦ 4 ä¸ªå­—ç¬¦ = 1 ä¸ª Token
- ä¸­æ–‡ï¼šçº¦ 1-2 ä¸ªå­—ç¬¦ = 1 ä¸ª Token
- ä»£ç ï¼šå˜åŒ–è¾ƒå¤§ï¼Œå–å†³äºè¯­è¨€å’Œæ ¼å¼

### Token è®¡ç®—åŸç†

OpenCode ä½¿ç”¨ç®€å•çš„ä¼°ç®—æ–¹æ³•ï¼š

```typescript
// packages/opencode/src/util/token.ts
export namespace Token {
  const CHARS_PER_TOKEN = 4  // ç»éªŒå€¼ï¼š4 ä¸ªå­—ç¬¦çº¦ç­‰äº 1 ä¸ª Token

  export function estimate(input: string) {
    return Math.max(0, Math.round((input || "").length / CHARS_PER_TOKEN))
  }
}
```

è¿™æ˜¯ä¸€ä¸ª**å¿«é€Ÿä¼°ç®—**æ–¹æ³•ï¼Œå®é™… Token æ•°é‡å–å†³äºå…·ä½“çš„ Tokenizerï¼ˆå¦‚ GPT ä½¿ç”¨ tiktokenï¼ŒClaude ä½¿ç”¨è‡ªå·±çš„ Tokenizerï¼‰ã€‚

### ä¸»æµæ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£

| æ¨¡å‹ | ä¸Šä¸‹æ–‡çª—å£ | è¾“å‡ºé™åˆ¶ | ç‰¹ç‚¹ |
|------|-----------|----------|------|
| GPT-4o | 128K | 16K | å¹³è¡¡æ€§èƒ½ä¸æˆæœ¬ |
| GPT-4 Turbo | 128K | 4K | é•¿ä¸Šä¸‹æ–‡æ”¯æŒ |
| Claude 3.5 Sonnet | 200K | 8K | è¶…é•¿ä¸Šä¸‹æ–‡ |
| Claude 3 Opus | 200K | 4K | æœ€å¼ºæ¨ç†èƒ½åŠ› |
| Gemini 1.5 Pro | 1M | 8K | è¶…å¤§ä¸Šä¸‹æ–‡çª—å£ |
| DeepSeek V3 | 64K | 8K | é«˜æ€§ä»·æ¯” |

---

## 2. æˆæœ¬ä¼˜åŒ–ç­–ç•¥

### Token å®šä»·æ¨¡å‹

LLM API é€šå¸¸æŒ‰ Token è®¡è´¹ï¼Œåˆ†ä¸ºè¾“å…¥å’Œè¾“å‡ºä¸¤éƒ¨åˆ†ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Token æˆæœ¬æ„æˆ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ€»æˆæœ¬ = è¾“å…¥ Token Ã— è¾“å…¥å•ä»· + è¾“å‡º Token Ã— è¾“å‡ºå•ä»·     â”‚
â”‚                                                             â”‚
â”‚  ç¤ºä¾‹ï¼ˆClaude 3.5 Sonnetï¼‰ï¼š                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¾“å…¥ï¼š$3 / 1M Token                                â”‚   â”‚
â”‚  â”‚  è¾“å‡ºï¼š$15 / 1M Token                               â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  ä¸€æ¬¡å¯¹è¯ï¼š                                         â”‚   â”‚
â”‚  â”‚  - è¾“å…¥ 10K Token = $0.03                           â”‚   â”‚
â”‚  â”‚  - è¾“å‡º 2K Token = $0.03                            â”‚   â”‚
â”‚  â”‚  - æ€»è®¡ = $0.06                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æ³¨æ„ï¼šè¾“å‡º Token é€šå¸¸æ¯”è¾“å…¥è´µ 3-5 å€ï¼                     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æˆæœ¬ä¼˜åŒ–åŸåˆ™

1. **å‡å°‘è¾“å…¥ Token**ï¼šå‹ç¼©å†å²å¯¹è¯ã€è£å‰ªå·¥å…·è¾“å‡º
2. **æ§åˆ¶è¾“å‡º Token**ï¼šè®¾ç½®åˆç†çš„ max_tokens
3. **åˆ©ç”¨ç¼“å­˜**ï¼šPrompt Caching å¯å¤§å¹…é™ä½é‡å¤å†…å®¹æˆæœ¬
4. **é€‰æ‹©åˆé€‚æ¨¡å‹**ï¼šç®€å•ä»»åŠ¡ç”¨å°æ¨¡å‹ï¼Œå¤æ‚ä»»åŠ¡ç”¨å¤§æ¨¡å‹

---

## 3. ä¸Šä¸‹æ–‡å‹ç¼©ç­–ç•¥

å½“å¯¹è¯å†å²è¶…å‡ºä¸Šä¸‹æ–‡çª—å£æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å‹ç¼©ç­–ç•¥ã€‚å¸¸è§çš„æ–¹æ³•æœ‰ï¼š

### 3.1 æ‘˜è¦å‹ç¼©ï¼ˆSummarizationï¼‰

å°†é•¿å¯¹è¯å‹ç¼©æˆç®€çŸ­æ‘˜è¦ï¼Œä¿ç•™å…³é”®ä¿¡æ¯ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ‘˜è¦å‹ç¼©ç¤ºæ„å›¾                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å‹ç¼©å‰ï¼ˆ5000 Tokenï¼‰ï¼š                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ User: å¸®æˆ‘åˆ†æè¿™ä¸ª React ç»„ä»¶çš„æ€§èƒ½é—®é¢˜...          â”‚   â”‚
â”‚  â”‚ Assistant: æˆ‘æ¥çœ‹çœ‹è¿™ä¸ªç»„ä»¶ã€‚é¦–å…ˆ...                â”‚   â”‚
â”‚  â”‚ User: é‚£ä¸ª useEffect çš„ä¾èµ–æ•°ç»„å¯¹å—ï¼Ÿ               â”‚   â”‚
â”‚  â”‚ Assistant: è®©æˆ‘æ£€æŸ¥ä¸€ä¸‹ä¾èµ–æ•°ç»„...                  â”‚   â”‚
â”‚  â”‚ ... (å¤§é‡å¯¹è¯)                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                                  â”‚
â”‚                          â–¼                                  â”‚
â”‚  å‹ç¼©åï¼ˆ500 Tokenï¼‰ï¼š                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ [æ‘˜è¦] ç”¨æˆ·è¯·æ±‚åˆ†æ React ç»„ä»¶æ€§èƒ½ã€‚å·²å®Œæˆï¼š        â”‚   â”‚
â”‚  â”‚ 1. è¯†åˆ«äº† useEffect ä¾èµ–é—®é¢˜                        â”‚   â”‚
â”‚  â”‚ 2. å»ºè®®ä½¿ç”¨ useMemo ä¼˜åŒ–                            â”‚   â”‚
â”‚  â”‚ 3. æ­£åœ¨å¤„ç†é‡æ¸²æŸ“é—®é¢˜                               â”‚   â”‚
â”‚  â”‚ å½“å‰ä»»åŠ¡ï¼šä¼˜åŒ– UserList ç»„ä»¶çš„æ¸²æŸ“æ€§èƒ½              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  å‹ç¼©æ¯”ï¼š10:1                                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼šå‹ç¼©æ¯”é«˜ï¼Œä¿ç•™è¯­ä¹‰
**ç¼ºç‚¹**ï¼šå¯èƒ½ä¸¢å¤±ç»†èŠ‚ï¼Œéœ€è¦é¢å¤– LLM è°ƒç”¨

### 3.2 æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰

åªä¿ç•™æœ€è¿‘ N è½®å¯¹è¯ï¼Œä¸¢å¼ƒæ›´æ—©çš„å†…å®¹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ»‘åŠ¨çª—å£ç¤ºæ„å›¾                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å¯¹è¯å†å²ï¼š[M1, M2, M3, M4, M5, M6, M7, M8]                 â”‚
â”‚                                                             â”‚
â”‚  çª—å£å¤§å° = 4                                               â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¸¢å¼ƒ        â”‚        ä¿ç•™ï¼ˆæ»‘åŠ¨çª—å£ï¼‰              â”‚   â”‚
â”‚  â”‚  [M1, M2, M3, M4]  â”‚  [M5, M6, M7, M8]              â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æ–°æ¶ˆæ¯ M9 åˆ°æ¥åï¼š                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä¸¢å¼ƒ             â”‚        ä¿ç•™                     â”‚   â”‚
â”‚  â”‚  [M1, M2, M3, M4, M5]  â”‚  [M6, M7, M8, M9]          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼šå®ç°ç®€å•ï¼Œæ— é¢å¤–æˆæœ¬
**ç¼ºç‚¹**ï¼šå¯èƒ½ä¸¢å¤±é‡è¦çš„æ—©æœŸä¸Šä¸‹æ–‡

### 3.3 é€‰æ‹©æ€§ä¿ç•™ï¼ˆSelective Retentionï¼‰

æ ¹æ®é‡è¦æ€§é€‰æ‹©ä¿ç•™å“ªäº›å†…å®¹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é€‰æ‹©æ€§ä¿ç•™ç­–ç•¥                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  é‡è¦æ€§è¯„ä¼°ç»´åº¦ï¼š                                           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  é«˜ä¼˜å…ˆçº§ï¼ˆå§‹ç»ˆä¿ç•™ï¼‰ï¼š                             â”‚   â”‚
â”‚  â”‚  â€¢ System Prompt                                    â”‚   â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·çš„åŸå§‹éœ€æ±‚                                   â”‚   â”‚
â”‚  â”‚  â€¢ å…³é”®å†³ç­–ç‚¹                                       â”‚   â”‚
â”‚  â”‚  â€¢ æœ€è¿‘çš„å·¥å…·è°ƒç”¨ç»“æœ                               â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  ä¸­ä¼˜å…ˆçº§ï¼ˆå°½é‡ä¿ç•™ï¼‰ï¼š                             â”‚   â”‚
â”‚  â”‚  â€¢ é‡è¦çš„ä¸­é—´ç»“è®º                                   â”‚   â”‚
â”‚  â”‚  â€¢ æ–‡ä»¶ä¿®æ”¹è®°å½•                                     â”‚   â”‚
â”‚  â”‚  â€¢ é”™è¯¯å’Œä¿®å¤å†å²                                   â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚  ä½ä¼˜å…ˆçº§ï¼ˆå¯å‹ç¼©/ä¸¢å¼ƒï¼‰ï¼š                          â”‚   â”‚
â”‚  â”‚  â€¢ å†—é•¿çš„å·¥å…·è¾“å‡º                                   â”‚   â”‚
â”‚  â”‚  â€¢ é‡å¤çš„ç¡®è®¤å¯¹è¯                                   â”‚   â”‚
â”‚  â”‚  â€¢ å·²å®Œæˆä»»åŠ¡çš„è¯¦ç»†è¿‡ç¨‹                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 å·¥å…·è¾“å‡ºè£å‰ªï¼ˆTool Output Pruningï¼‰

å·¥å…·è°ƒç”¨çš„è¾“å‡ºå¾€å¾€å¾ˆé•¿ï¼ˆå¦‚è¯»å–å¤§æ–‡ä»¶ï¼‰ï¼Œä½†å¤§éƒ¨åˆ†å†…å®¹åœ¨åç»­å¯¹è¯ä¸­ä¸å†éœ€è¦ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å·¥å…·è¾“å‡ºè£å‰ª                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  åŸå§‹å·¥å…·è¾“å‡ºï¼ˆ10000 Tokenï¼‰ï¼š                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Tool: read_file                                     â”‚   â”‚
â”‚  â”‚ Output: [å®Œæ•´çš„ 500 è¡Œä»£ç æ–‡ä»¶å†…å®¹]                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                                  â”‚
â”‚                          â–¼                                  â”‚
â”‚  è£å‰ªåï¼ˆ10 Tokenï¼‰ï¼š                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Tool: read_file                                     â”‚   â”‚
â”‚  â”‚ Output: [TOOL OUTPUT PRUNED]                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ç­–ç•¥ï¼šä¿ç•™æœ€è¿‘ N ä¸ªå·¥å…·è°ƒç”¨çš„å®Œæ•´è¾“å‡ºï¼Œ                    â”‚
â”‚        æ›´æ—©çš„å·¥å…·è¾“å‡ºç”¨å ä½ç¬¦æ›¿ä»£                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | å‹ç¼©æ¯” | ä¿¡æ¯ä¿ç•™ | å®ç°å¤æ‚åº¦ | é¢å¤–æˆæœ¬ |
|------|--------|----------|------------|----------|
| æ‘˜è¦å‹ç¼© | é«˜ (10:1) | è¯­ä¹‰çº§ | ä¸­ | éœ€è¦ LLM è°ƒç”¨ |
| æ»‘åŠ¨çª—å£ | ä¸­ (2:1) | æœ€è¿‘å†…å®¹ | ä½ | æ—  |
| é€‰æ‹©æ€§ä¿ç•™ | ä¸­ (3:1) | é‡è¦å†…å®¹ | é«˜ | æ—  |
| å·¥å…·è¾“å‡ºè£å‰ª | é«˜ (100:1) | ç»“æ„ä¿ç•™ | ä½ | æ—  |

**æœ€ä½³å®è·µ**ï¼šç»„åˆä½¿ç”¨å¤šç§ç­–ç•¥ã€‚OpenCode å°±æ˜¯è¿™æ ·åšçš„â€”â€”å…ˆè£å‰ªå·¥å…·è¾“å‡ºï¼Œå†åœ¨å¿…è¦æ—¶ç”Ÿæˆæ‘˜è¦ã€‚

---

## 4. é•¿å¯¹è¯ç®¡ç†

### ä¸Šä¸‹æ–‡æº¢å‡ºæ£€æµ‹

å½“å¯¹è¯æ¥è¿‘ä¸Šä¸‹æ–‡çª—å£é™åˆ¶æ—¶ï¼Œéœ€è¦è§¦å‘å‹ç¼©ã€‚OpenCode çš„æ£€æµ‹é€»è¾‘ï¼š

```typescript
// åˆ¤æ–­æ˜¯å¦éœ€è¦å‹ç¼©
export async function isOverflow(input: { 
  tokens: MessageV2.Assistant["tokens"]
  model: Provider.Model 
}) {
  const config = await Config.get()
  // å¦‚æœç”¨æˆ·ç¦ç”¨äº†è‡ªåŠ¨å‹ç¼©ï¼Œç›´æ¥è¿”å› false
  if (config.compaction?.auto === false) return false
  
  const context = input.model.limit.context  // æ¨¡å‹çš„ä¸Šä¸‹æ–‡çª—å£å¤§å°
  if (context === 0) return false  // 0 è¡¨ç¤ºæ— é™åˆ¶
  
  // è®¡ç®—å·²ä½¿ç”¨çš„ Token æ•°
  const count = input.tokens.input + input.tokens.cache.read + input.tokens.output
  
  // é¢„ç•™è¾“å‡ºç©ºé—´
  const output = Math.min(input.model.limit.output, OUTPUT_TOKEN_MAX) || OUTPUT_TOKEN_MAX
  const usable = context - output  // å¯ç”¨äºè¾“å…¥çš„ Token æ•°
  
  return count > usable  // å¦‚æœå·²ä½¿ç”¨è¶…è¿‡å¯ç”¨ç©ºé—´ï¼Œéœ€è¦å‹ç¼©
}
```

**å…³é”®ç‚¹**ï¼š
- éœ€è¦ä¸ºè¾“å‡ºé¢„ç•™ç©ºé—´ï¼ˆé€šå¸¸ 8K-32Kï¼‰
- ä½¿ç”¨ Token åŒ…æ‹¬ï¼šè¾“å…¥ + ç¼“å­˜è¯»å– + è¾“å‡º

### å¢é‡æ‘˜è¦

å½“æ£€æµ‹åˆ°æº¢å‡ºæ—¶ï¼ŒOpenCode ä¼šç”Ÿæˆä¸€ä¸ªæ‘˜è¦æ¶ˆæ¯ï¼Œæ€»ç»“ä¹‹å‰çš„å¯¹è¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¢é‡æ‘˜è¦æµç¨‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. æ£€æµ‹åˆ°ä¸Šä¸‹æ–‡æº¢å‡º                                        â”‚
â”‚     â”‚                                                       â”‚
â”‚     â–¼                                                       â”‚
â”‚  2. åˆ›å»ºå‹ç¼©è¯·æ±‚                                            â”‚
â”‚     â”‚                                                       â”‚
â”‚     â–¼                                                       â”‚
â”‚  3. è°ƒç”¨ LLM ç”Ÿæˆæ‘˜è¦                                       â”‚
â”‚     â”‚  Prompt: "æ€»ç»“ä¸Šè¿°å¯¹è¯ï¼Œå…³æ³¨ï¼š                        â”‚
â”‚     â”‚  - æˆ‘ä»¬åšäº†ä»€ä¹ˆ                                       â”‚
â”‚     â”‚  - æ­£åœ¨åšä»€ä¹ˆ                                         â”‚
â”‚     â”‚  - æ¥ä¸‹æ¥è¦åšä»€ä¹ˆ                                     â”‚
â”‚     â”‚  - æ¶‰åŠå“ªäº›æ–‡ä»¶"                                      â”‚
â”‚     â”‚                                                       â”‚
â”‚     â–¼                                                       â”‚
â”‚  4. æ‘˜è¦æ¶ˆæ¯æ ‡è®°ä¸º summary: true                            â”‚
â”‚     â”‚                                                       â”‚
â”‚     â–¼                                                       â”‚
â”‚  5. åç»­å¯¹è¯ä»æ‘˜è¦å¼€å§‹ï¼Œä¸¢å¼ƒæ›´æ—©çš„è¯¦ç»†å†…å®¹                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Prompt Caching

### ä»€ä¹ˆæ˜¯ Prompt Cachingï¼Ÿ

Prompt Caching æ˜¯ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œå…è®¸ç¼“å­˜é‡å¤çš„ Prompt å‰ç¼€ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Prompt Caching åŸç†                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä¼ ç»Ÿæ–¹å¼ï¼ˆæ¯æ¬¡éƒ½å®Œæ•´å¤„ç†ï¼‰ï¼š                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è¯·æ±‚ 1: [System Prompt] + [å†å²] + [æ–°æ¶ˆæ¯]         â”‚   â”‚
â”‚  â”‚         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚   â”‚
â”‚  â”‚         å…¨éƒ¨é‡æ–°è®¡ç®—                                â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚ è¯·æ±‚ 2: [System Prompt] + [å†å²] + [æ–°æ¶ˆæ¯]         â”‚   â”‚
â”‚  â”‚         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚   â”‚
â”‚  â”‚         å…¨éƒ¨é‡æ–°è®¡ç®—                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä½¿ç”¨ Prompt Cachingï¼š                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ è¯·æ±‚ 1: [System Prompt] + [å†å²] + [æ–°æ¶ˆæ¯]         â”‚   â”‚
â”‚  â”‚         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â•â•â•â•â•â•â•â•         â”‚   â”‚
â”‚  â”‚         ç¼“å­˜ï¼ˆé¦–æ¬¡è®¡ç®—ï¼‰           æ–°è®¡ç®—           â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚ è¯·æ±‚ 2: [System Prompt] + [å†å²] + [æ–°æ¶ˆæ¯]         â”‚   â”‚
â”‚  â”‚         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•â•â•â•â•â•â•â•         â”‚   â”‚
â”‚  â”‚         ä»ç¼“å­˜è¯»å–ï¼ˆä¾¿å®œï¼‰         æ–°è®¡ç®—           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æˆæœ¬èŠ‚çœï¼šç¼“å­˜è¯»å–é€šå¸¸åªéœ€åŸä»·çš„ 10%                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Anthropic Prompt Caching

Anthropic çš„ Claude æ¨¡å‹æ”¯æŒæ˜¾å¼çš„ Prompt Cachingï¼š

```typescript
// ä½¿ç”¨ cache_control æ ‡è®°å¯ç¼“å­˜çš„å†…å®¹
const messages = [
  {
    role: "user",
    content: [
      {
        type: "text",
        text: systemPrompt,
        cache_control: { type: "ephemeral" }  // æ ‡è®°ä¸ºå¯ç¼“å­˜
      }
    ]
  },
  // ... å…¶ä»–æ¶ˆæ¯
]
```

**ç¼“å­˜å®šä»·ï¼ˆClaude 3.5 Sonnetï¼‰**ï¼š
- ç¼“å­˜å†™å…¥ï¼š$3.75 / 1M Tokenï¼ˆæ¯”æ™®é€šè¾“å…¥è´µ 25%ï¼‰
- ç¼“å­˜è¯»å–ï¼š$0.30 / 1M Tokenï¼ˆæ¯”æ™®é€šè¾“å…¥ä¾¿å®œ 90%ï¼‰

### ç¼“å­˜ç­–ç•¥è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¼“å­˜ç­–ç•¥å»ºè®®                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  é€‚åˆç¼“å­˜çš„å†…å®¹ï¼š                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âœ… System Promptï¼ˆå‡ ä¹ä¸å˜ï¼‰                        â”‚   â”‚
â”‚  â”‚ âœ… å¤§å‹å‚è€ƒæ–‡æ¡£ï¼ˆå¦‚ API æ–‡æ¡£ï¼‰                      â”‚   â”‚
â”‚  â”‚ âœ… ä»£ç åº“ç»“æ„è¯´æ˜                                   â”‚   â”‚
â”‚  â”‚ âœ… æ—©æœŸå¯¹è¯å†å²ï¼ˆå·²ç¨³å®šï¼‰                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä¸é€‚åˆç¼“å­˜çš„å†…å®¹ï¼š                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ âŒ é¢‘ç¹å˜åŒ–çš„å†…å®¹                                   â”‚   â”‚
â”‚  â”‚ âŒ æœ€è¿‘çš„å¯¹è¯ï¼ˆå¯èƒ½è¢«ä¿®æ”¹ï¼‰                         â”‚   â”‚
â”‚  â”‚ âŒ åŠ¨æ€ç”Ÿæˆçš„ä¸Šä¸‹æ–‡                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æœ€ä½³å®è·µï¼š                                                 â”‚
â”‚  â€¢ å°†ç¨³å®šå†…å®¹æ”¾åœ¨ Prompt å‰é¢                              â”‚
â”‚  â€¢ ç¼“å­˜æ–­ç‚¹è®¾ç½®åœ¨ç¨³å®š/åŠ¨æ€å†…å®¹çš„è¾¹ç•Œ                       â”‚
â”‚  â€¢ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡ï¼Œä¼˜åŒ–ç¼“å­˜ç­–ç•¥                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```



---

## 6. OpenCode å®è·µæ¡ˆä¾‹

è®©æˆ‘ä»¬çœ‹çœ‹ OpenCode æ˜¯å¦‚ä½•å®ç°ä¸Šä¸‹æ–‡ç®¡ç†çš„ã€‚

### 6.1 ä¸Šä¸‹æ–‡å‹ç¼©å®ç°

OpenCode çš„å‹ç¼©é€»è¾‘åœ¨ `packages/opencode/src/session/compaction.ts` ä¸­ï¼š

```typescript
// packages/opencode/src/session/compaction.tsï¼ˆç®€åŒ–ç‰ˆï¼‰

export namespace SessionCompaction {
  // å‹ç¼©é˜ˆå€¼é…ç½®
  export const PRUNE_MINIMUM = 20_000   // æœ€å°‘éœ€è¦è£å‰ª 20K Token
  export const PRUNE_PROTECT = 40_000   // ä¿æŠ¤æœ€è¿‘ 40K Token çš„å·¥å…·è¾“å‡º

  // å—ä¿æŠ¤çš„å·¥å…·ï¼ˆä¸è£å‰ªå…¶è¾“å‡ºï¼‰
  const PRUNE_PROTECTED_TOOLS = ["skill"]

  // å·¥å…·è¾“å‡ºè£å‰ªå‡½æ•°
  // æ ¸å¿ƒæ€æƒ³ï¼šä»åå¾€å‰æ‰«æï¼Œä¿æŠ¤æœ€è¿‘çš„å·¥å…·è¾“å‡ºï¼Œè£å‰ªæ›´æ—©çš„
  export async function prune(input: { sessionID: string }) {
    const config = await Config.get()
    if (config.compaction?.prune === false) return  // ç”¨æˆ·å¯ç¦ç”¨è£å‰ª
    
    const msgs = await Session.messages({ sessionID: input.sessionID })
    let total = 0      // æ‰«æåˆ°çš„å·¥å…·è¾“å‡ºæ€» Token
    let pruned = 0     // å°†è¢«è£å‰ªçš„ Token
    const toPrune = [] // å¾…è£å‰ªçš„å·¥å…·è°ƒç”¨
    let turns = 0      // å¯¹è¯è½®æ¬¡è®¡æ•°

    // ä»åå¾€å‰éå†æ¶ˆæ¯
    loop: for (let msgIndex = msgs.length - 1; msgIndex >= 0; msgIndex--) {
      const msg = msgs[msgIndex]
      if (msg.info.role === "user") turns++
      if (turns < 2) continue  // ä¿æŠ¤æœ€è¿‘ 2 è½®å¯¹è¯
      
      // å¦‚æœé‡åˆ°æ‘˜è¦æ¶ˆæ¯ï¼Œåœæ­¢æ‰«æï¼ˆæ‘˜è¦ä¹‹å‰çš„å†…å®¹å·²è¢«å‹ç¼©ï¼‰
      if (msg.info.role === "assistant" && msg.info.summary) break loop
      
      // æ‰«æå·¥å…·è°ƒç”¨
      for (let partIndex = msg.parts.length - 1; partIndex >= 0; partIndex--) {
        const part = msg.parts[partIndex]
        if (part.type === "tool" && part.state.status === "completed") {
          // è·³è¿‡å—ä¿æŠ¤çš„å·¥å…·
          if (PRUNE_PROTECTED_TOOLS.includes(part.tool)) continue
          // å¦‚æœå·²ç»è¢«å‹ç¼©è¿‡ï¼Œåœæ­¢
          if (part.state.time.compacted) break loop
          
          // ä¼°ç®—å·¥å…·è¾“å‡ºçš„ Token æ•°
          const estimate = Token.estimate(part.state.output)
          total += estimate
          
          // è¶…è¿‡ä¿æŠ¤é˜ˆå€¼çš„éƒ¨åˆ†å°†è¢«è£å‰ª
          if (total > PRUNE_PROTECT) {
            pruned += estimate
            toPrune.push(part)
          }
        }
      }
    }
    
    // åªæœ‰è£å‰ªé‡è¶…è¿‡æœ€å°é˜ˆå€¼æ‰æ‰§è¡Œ
    if (pruned > PRUNE_MINIMUM) {
      for (const part of toPrune) {
        if (part.state.status === "completed") {
          part.state.time.compacted = Date.now()  // æ ‡è®°å‹ç¼©æ—¶é—´
          await Session.updatePart(part)
        }
      }
    }
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
1. **åŒé˜ˆå€¼ä¿æŠ¤**ï¼š`PRUNE_PROTECT` ä¿æŠ¤æœ€è¿‘çš„å·¥å…·è¾“å‡ºï¼Œ`PRUNE_MINIMUM` é¿å…é¢‘ç¹å°é‡è£å‰ª
2. **ä»åå¾€å‰æ‰«æ**ï¼šä¼˜å…ˆä¿ç•™æœ€è¿‘çš„å†…å®¹
3. **æ‘˜è¦è¾¹ç•Œ**ï¼šé‡åˆ°æ‘˜è¦æ¶ˆæ¯å°±åœæ­¢ï¼Œé¿å…é‡å¤å¤„ç†
4. **å·¥å…·ç™½åå•**ï¼šæŸäº›é‡è¦å·¥å…·çš„è¾“å‡ºä¸è£å‰ª

### 6.2 ä¼šè¯æ‘˜è¦ç”Ÿæˆ

å½“éœ€è¦æ›´æ¿€è¿›çš„å‹ç¼©æ—¶ï¼ŒOpenCode ä¼šç”Ÿæˆæ‘˜è¦ã€‚æ ¸å¿ƒé€»è¾‘åœ¨ `packages/opencode/src/session/summary.ts`ï¼š

```typescript
// packages/opencode/src/session/summary.tsï¼ˆç®€åŒ–ç‰ˆï¼‰

export namespace SessionSummary {
  // ä¸ºæ¶ˆæ¯ç”Ÿæˆæ‘˜è¦
  async function summarizeMessage(input: { 
    messageID: string
    messages: MessageV2.WithParts[] 
  }) {
    const messages = input.messages.filter(/* ç›¸å…³æ¶ˆæ¯ */)
    const userMsg = /* ç”¨æˆ·æ¶ˆæ¯ */
    const assistantMsg = /* åŠ©æ‰‹æ¶ˆæ¯ */
    
    // è·å–ä¸€ä¸ªå°æ¨¡å‹ç”¨äºç”Ÿæˆæ‘˜è¦ï¼ˆèŠ‚çœæˆæœ¬ï¼‰
    const small = await Provider.getSmallModel(assistantMsg.providerID)
      ?? await Provider.getModel(assistantMsg.providerID, assistantMsg.modelID)

    // ç”Ÿæˆæ ‡é¢˜
    if (!userMsg.summary?.title) {
      const agent = await Agent.get("title")
      const stream = await LLM.stream({
        agent,
        model: small,
        messages: [{
          role: "user",
          content: `
            The following is the text to summarize:
            <text>
            ${textPart?.text ?? ""}
            </text>
          `,
        }],
        // ... å…¶ä»–é…ç½®
      })
      userMsg.summary.title = await stream.text
    }

    // ç”Ÿæˆè¯¦ç»†æ‘˜è¦
    if (diffs.length > 0) {
      // å…ˆè£å‰ªå·¥å…·è¾“å‡ºï¼Œå‡å°‘æ‘˜è¦è¾“å…¥
      for (const msg of messages) {
        for (const part of msg.parts) {
          if (part.type === "tool" && part.state.status === "completed") {
            part.state.output = "[TOOL OUTPUT PRUNED]"  // ç”¨å ä½ç¬¦æ›¿ä»£
          }
        }
      }
      
      const summaryAgent = await Agent.get("summary")
      const stream = await LLM.stream({
        agent: summaryAgent,
        model: small,
        messages: [
          ...MessageV2.toModelMessage(messages),
          {
            role: "user",
            content: `Summarize the above conversation according to your system prompts.`,
          },
        ],
        // ... å…¶ä»–é…ç½®
      })
      userMsg.summary.body = await stream.text
    }
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
1. **ä½¿ç”¨å°æ¨¡å‹**ï¼šæ‘˜è¦ç”Ÿæˆç”¨å°æ¨¡å‹ï¼ŒèŠ‚çœæˆæœ¬
2. **å…ˆè£å‰ªå†æ‘˜è¦**ï¼šå‡å°‘æ‘˜è¦è¾“å…¥çš„ Token æ•°
3. **åˆ†å±‚æ‘˜è¦**ï¼šæ ‡é¢˜ï¼ˆçŸ­ï¼‰+ è¯¦ç»†æ‘˜è¦ï¼ˆé•¿ï¼‰

### 6.3 å‹ç¼©æµç¨‹è§¦å‘

åœ¨ä¸»å¾ªç¯ä¸­ï¼ŒOpenCode ä¼šæ£€æµ‹å¹¶è§¦å‘å‹ç¼©ï¼š

```typescript
// packages/opencode/src/session/prompt.tsï¼ˆç®€åŒ–ç‰ˆï¼‰

export const loop = fn(Identifier.schema("session"), async (sessionID) => {
  while (true) {
    // ... è·å–æ¶ˆæ¯å†å²
    
    // æ£€æµ‹ä¸Šä¸‹æ–‡æº¢å‡º
    if (
      lastFinished &&
      lastFinished.summary !== true &&  // ä¸æ˜¯æ‘˜è¦æ¶ˆæ¯
      await SessionCompaction.isOverflow({ tokens: lastFinished.tokens, model })
    ) {
      // è§¦å‘å‹ç¼©
      await SessionCompaction.create({
        sessionID,
        agent: lastUser.agent,
        model: lastUser.model,
        auto: true,
      })
      continue  // å‹ç¼©åç»§ç»­å¾ªç¯
    }
    
    // ... æ­£å¸¸å¤„ç†
  }
  
  // å¾ªç¯ç»“æŸåï¼Œæ‰§è¡Œå·¥å…·è¾“å‡ºè£å‰ª
  SessionCompaction.prune({ sessionID })
})
```

### 6.4 å‹ç¼© Prompt è®¾è®¡

OpenCode ä½¿ç”¨ä¸“é—¨çš„ Prompt æ¥ç”Ÿæˆé«˜è´¨é‡æ‘˜è¦ï¼š

```typescript
// å‹ç¼© Promptï¼ˆç®€åŒ–ç‰ˆï¼‰
const defaultPrompt = `
Provide a detailed prompt for continuing our conversation above. 
Focus on information that would be helpful for continuing the conversation, including:
- what we didï¼ˆæˆ‘ä»¬åšäº†ä»€ä¹ˆï¼‰
- what we're doingï¼ˆæ­£åœ¨åšä»€ä¹ˆï¼‰
- which files we're working onï¼ˆæ¶‰åŠå“ªäº›æ–‡ä»¶ï¼‰
- what we're going to do nextï¼ˆæ¥ä¸‹æ¥è¦åšä»€ä¹ˆï¼‰

Note: The new session will not have access to our conversation.
ï¼ˆæ³¨æ„ï¼šæ–°ä¼šè¯æ— æ³•è®¿é—®æˆ‘ä»¬çš„å¯¹è¯å†å²ï¼‰
`
```

è¿™ä¸ª Prompt çš„è®¾è®¡éå¸¸å…³é”®ï¼Œå®ƒç¡®ä¿æ‘˜è¦åŒ…å«ç»§ç»­å¯¹è¯æ‰€éœ€çš„æ‰€æœ‰å…³é”®ä¿¡æ¯ã€‚



---

## 7. åŠ¨æ‰‹å®éªŒ

### å®éªŒ 1ï¼šToken ä¼°ç®—

**ç›®æ ‡**ï¼šç†è§£ Token è®¡ç®—çš„åŸºæœ¬åŸç†

**æ­¥éª¤**ï¼š

1. åˆ›å»ºä¸€ä¸ªç®€å•çš„ Token ä¼°ç®—å‡½æ•°ï¼š

```typescript
// token-experiment.ts
function estimateTokens(text: string): number {
  // ç®€å•ä¼°ç®—ï¼š4 ä¸ªå­—ç¬¦ â‰ˆ 1 ä¸ª Token
  return Math.round(text.length / 4)
}

// æµ‹è¯•ä¸åŒç±»å‹çš„æ–‡æœ¬
const samples = [
  "Hello, world!",                           // è‹±æ–‡çŸ­å¥
  "ä½ å¥½ï¼Œä¸–ç•Œï¼",                             // ä¸­æ–‡çŸ­å¥
  "function calculateSum(a, b) { return a + b; }",  // ä»£ç 
  "The quick brown fox jumps over the lazy dog.",   // è‹±æ–‡é•¿å¥
]

for (const sample of samples) {
  console.log(`"${sample}"`)
  console.log(`  å­—ç¬¦æ•°: ${sample.length}`)
  console.log(`  ä¼°ç®— Token: ${estimateTokens(sample)}`)
  console.log()
}
```

2. è¿è¡Œå¹¶è§‚å¯Ÿç»“æœï¼š

```bash
bun run token-experiment.ts
```

3. æ€è€ƒï¼šä¸ºä»€ä¹ˆä¸­æ–‡å’Œè‹±æ–‡çš„ Token æ•ˆç‡ä¸åŒï¼Ÿ

### å®éªŒ 2ï¼šä¸Šä¸‹æ–‡æº¢å‡ºæ¨¡æ‹Ÿ

**ç›®æ ‡**ï¼šç†è§£ä¸Šä¸‹æ–‡çª—å£é™åˆ¶çš„å½±å“

**æ­¥éª¤**ï¼š

1. åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿä¸Šä¸‹æ–‡ç®¡ç†çš„ç±»ï¼š

```typescript
// context-manager.ts
class ContextManager {
  private maxTokens: number
  private messages: { role: string; content: string; tokens: number }[] = []
  
  constructor(maxTokens: number) {
    this.maxTokens = maxTokens
  }
  
  // ä¼°ç®— Token æ•°
  private estimateTokens(text: string): number {
    return Math.round(text.length / 4)
  }
  
  // è®¡ç®—å½“å‰æ€» Token
  getTotalTokens(): number {
    return this.messages.reduce((sum, m) => sum + m.tokens, 0)
  }
  
  // æ·»åŠ æ¶ˆæ¯
  addMessage(role: string, content: string): boolean {
    const tokens = this.estimateTokens(content)
    
    // æ£€æŸ¥æ˜¯å¦ä¼šæº¢å‡º
    if (this.getTotalTokens() + tokens > this.maxTokens) {
      console.log(`âš ï¸ ä¸Šä¸‹æ–‡æº¢å‡ºï¼å½“å‰: ${this.getTotalTokens()}, æ–°å¢: ${tokens}, é™åˆ¶: ${this.maxTokens}`)
      return false
    }
    
    this.messages.push({ role, content, tokens })
    console.log(`âœ… æ·»åŠ æ¶ˆæ¯ [${role}]: ${tokens} tokens, æ€»è®¡: ${this.getTotalTokens()}/${this.maxTokens}`)
    return true
  }
  
  // è·å–æ‰€æœ‰æ¶ˆæ¯
  getMessages() {
    return this.messages
  }
}

// æµ‹è¯•
const manager = new ContextManager(100)  // æ¨¡æ‹Ÿ 100 Token çš„å°çª—å£

manager.addMessage("system", "You are a helpful assistant.")
manager.addMessage("user", "Hello!")
manager.addMessage("assistant", "Hi there! How can I help you today?")
manager.addMessage("user", "Can you explain quantum computing in detail?")
manager.addMessage("assistant", "Quantum computing is a type of computation that harnesses quantum mechanical phenomena...")
```

2. è¿è¡Œå¹¶è§‚å¯Ÿæº¢å‡ºè¡Œä¸º

3. æ€è€ƒï¼šå½“æº¢å‡ºå‘ç”Ÿæ—¶ï¼Œåº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ

### å®éªŒ 3ï¼šæ»‘åŠ¨çª—å£å®ç°

**ç›®æ ‡**ï¼šå®ç°ç®€å•çš„æ»‘åŠ¨çª—å£å‹ç¼©

**æ­¥éª¤**ï¼š

1. æ‰©å±•ä¸Šé¢çš„ ContextManagerï¼š

```typescript
// sliding-window.ts
class SlidingWindowManager {
  private maxTokens: number
  private messages: { role: string; content: string; tokens: number }[] = []
  
  constructor(maxTokens: number) {
    this.maxTokens = maxTokens
  }
  
  private estimateTokens(text: string): number {
    return Math.round(text.length / 4)
  }
  
  getTotalTokens(): number {
    return this.messages.reduce((sum, m) => sum + m.tokens, 0)
  }
  
  // æ»‘åŠ¨çª—å£ï¼šç§»é™¤æœ€æ—©çš„æ¶ˆæ¯ç›´åˆ°æœ‰è¶³å¤Ÿç©ºé—´
  private slideWindow(neededTokens: number) {
    while (this.messages.length > 0 && 
           this.getTotalTokens() + neededTokens > this.maxTokens) {
      const removed = this.messages.shift()!
      console.log(`ğŸ—‘ï¸ ç§»é™¤æ¶ˆæ¯ [${removed.role}]: "${removed.content.slice(0, 20)}..."`)
    }
  }
  
  addMessage(role: string, content: string): void {
    const tokens = this.estimateTokens(content)
    
    // å¦‚æœå•æ¡æ¶ˆæ¯å°±è¶…è¿‡é™åˆ¶ï¼Œæˆªæ–­å®ƒ
    if (tokens > this.maxTokens) {
      console.log(`âš ï¸ æ¶ˆæ¯è¿‡é•¿ï¼Œæˆªæ–­å¤„ç†`)
      content = content.slice(0, this.maxTokens * 4)
    }
    
    // æ»‘åŠ¨çª—å£
    this.slideWindow(tokens)
    
    this.messages.push({ role, content, tokens: this.estimateTokens(content) })
    console.log(`âœ… æ·»åŠ æ¶ˆæ¯ [${role}]: ${this.estimateTokens(content)} tokens, æ€»è®¡: ${this.getTotalTokens()}/${this.maxTokens}`)
  }
  
  getMessages() {
    return this.messages
  }
}

// æµ‹è¯•æ»‘åŠ¨çª—å£
const swManager = new SlidingWindowManager(80)

swManager.addMessage("system", "You are helpful.")
swManager.addMessage("user", "Hi")
swManager.addMessage("assistant", "Hello!")
swManager.addMessage("user", "Tell me about AI")
swManager.addMessage("assistant", "AI is artificial intelligence...")
swManager.addMessage("user", "More details please")
swManager.addMessage("assistant", "AI encompasses machine learning, deep learning, and more...")

console.log("\næœ€ç»ˆæ¶ˆæ¯åˆ—è¡¨:")
console.log(swManager.getMessages())
```

2. è§‚å¯Ÿå“ªäº›æ¶ˆæ¯è¢«ç§»é™¤äº†

3. æ€è€ƒï¼šæ»‘åŠ¨çª—å£çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ

---

## 8. å®æˆ˜é¡¹ç›®ï¼šå¸¦ä¸Šä¸‹æ–‡å‹ç¼©çš„é•¿å¯¹è¯ Agent

### é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ªèƒ½å¤Ÿå¤„ç†é•¿å¯¹è¯çš„ Agentï¼Œå®ç°ï¼š
1. Token è®¡æ•°å’Œç›‘æ§
2. ä¸Šä¸‹æ–‡æº¢å‡ºæ£€æµ‹
3. å¤šç§å‹ç¼©ç­–ç•¥ï¼ˆæ»‘åŠ¨çª—å£ + æ‘˜è¦ï¼‰
4. æˆæœ¬è¿½è¸ª

### é¡¹ç›®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é•¿å¯¹è¯ Agent æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Agent Core                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚  Token    â”‚  â”‚  Context  â”‚  â”‚   Cost    â”‚       â”‚   â”‚
â”‚  â”‚  â”‚  Counter  â”‚  â”‚  Manager  â”‚  â”‚  Tracker  â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â”‚        â”‚              â”‚              â”‚              â”‚   â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                       â”‚                              â”‚   â”‚
â”‚  â”‚                       â–¼                              â”‚   â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚   â”‚
â”‚  â”‚              â”‚   Compaction  â”‚                       â”‚   â”‚
â”‚  â”‚              â”‚    Engine     â”‚                       â”‚   â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚  â”‚                      â”‚                               â”‚   â”‚
â”‚  â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚  â”‚        â–¼             â–¼             â–¼                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚ Sliding  â”‚ â”‚ Summary  â”‚ â”‚  Tool    â”‚            â”‚   â”‚
â”‚  â”‚  â”‚ Window   â”‚ â”‚ Compress â”‚ â”‚  Prune   â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°æ­¥éª¤

#### æ­¥éª¤ 1ï¼šåˆ›å»ºé¡¹ç›®ç»“æ„

```bash
mkdir context-agent
cd context-agent
bun init -y
bun add openai  # æˆ– @anthropic-ai/sdk
```

```
context-agent/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts           # å…¥å£
â”‚   â”œâ”€â”€ token.ts           # Token è®¡æ•°
â”‚   â”œâ”€â”€ context-manager.ts # ä¸Šä¸‹æ–‡ç®¡ç†
â”‚   â”œâ”€â”€ compaction.ts      # å‹ç¼©ç­–ç•¥
â”‚   â””â”€â”€ agent.ts           # Agent ä¸»é€»è¾‘
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

#### æ­¥éª¤ 2ï¼šå®ç° Token è®¡æ•°å™¨

```typescript
// src/token.ts
export class TokenCounter {
  private static CHARS_PER_TOKEN = 4
  
  // ä¼°ç®—æ–‡æœ¬çš„ Token æ•°
  static estimate(text: string): number {
    return Math.max(0, Math.round((text || "").length / this.CHARS_PER_TOKEN))
  }
  
  // ä¼°ç®—æ¶ˆæ¯æ•°ç»„çš„æ€» Token
  static estimateMessages(messages: { role: string; content: string }[]): number {
    return messages.reduce((sum, msg) => {
      // æ¯æ¡æ¶ˆæ¯æœ‰é¢å¤–å¼€é”€ï¼ˆrole æ ‡è®°ç­‰ï¼‰
      const overhead = 4
      return sum + this.estimate(msg.content) + overhead
    }, 0)
  }
}
```

#### æ­¥éª¤ 3ï¼šå®ç°ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```typescript
// src/context-manager.ts
import { TokenCounter } from "./token"

export interface Message {
  role: "system" | "user" | "assistant"
  content: string
  tokens: number
  timestamp: number
  compressed?: boolean  // æ˜¯å¦å·²å‹ç¼©
}

export interface ContextConfig {
  maxTokens: number        // ä¸Šä¸‹æ–‡çª—å£å¤§å°
  reserveOutput: number    // é¢„ç•™è¾“å‡ºç©ºé—´
  compactionThreshold: number  // è§¦å‘å‹ç¼©çš„é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰
}

export class ContextManager {
  private messages: Message[] = []
  private config: ContextConfig
  
  constructor(config: ContextConfig) {
    this.config = config
  }
  
  // è·å–å¯ç”¨ Token æ•°
  getAvailableTokens(): number {
    return this.config.maxTokens - this.config.reserveOutput
  }
  
  // è·å–å½“å‰ä½¿ç”¨çš„ Token æ•°
  getCurrentTokens(): number {
    return this.messages.reduce((sum, m) => sum + m.tokens, 0)
  }
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©
  needsCompaction(): boolean {
    const usage = this.getCurrentTokens() / this.getAvailableTokens()
    return usage > this.config.compactionThreshold
  }
  
  // æ·»åŠ æ¶ˆæ¯
  addMessage(role: Message["role"], content: string): void {
    const tokens = TokenCounter.estimate(content)
    this.messages.push({
      role,
      content,
      tokens,
      timestamp: Date.now(),
    })
  }
  
  // è·å–æ¶ˆæ¯ï¼ˆç”¨äºå‘é€ç»™ LLMï¼‰
  getMessages(): { role: string; content: string }[] {
    return this.messages.map(m => ({
      role: m.role,
      content: m.content,
    }))
  }
  
  // æ›¿æ¢æ¶ˆæ¯åˆ—è¡¨ï¼ˆå‹ç¼©åä½¿ç”¨ï¼‰
  setMessages(messages: Message[]): void {
    this.messages = messages
  }
  
  // è·å–ç»Ÿè®¡ä¿¡æ¯
  getStats() {
    return {
      messageCount: this.messages.length,
      currentTokens: this.getCurrentTokens(),
      availableTokens: this.getAvailableTokens(),
      usage: (this.getCurrentTokens() / this.getAvailableTokens() * 100).toFixed(1) + "%",
    }
  }
}
```

#### æ­¥éª¤ 4ï¼šå®ç°å‹ç¼©ç­–ç•¥

```typescript
// src/compaction.ts
import { Message, ContextManager } from "./context-manager"
import { TokenCounter } from "./token"

export interface CompactionStrategy {
  name: string
  compact(messages: Message[], targetTokens: number): Promise<Message[]>
}

// ç­–ç•¥ 1ï¼šæ»‘åŠ¨çª—å£
export class SlidingWindowStrategy implements CompactionStrategy {
  name = "sliding-window"
  
  async compact(messages: Message[], targetTokens: number): Promise<Message[]> {
    const result: Message[] = []
    let totalTokens = 0
    
    // å§‹ç»ˆä¿ç•™ system æ¶ˆæ¯
    const systemMsg = messages.find(m => m.role === "system")
    if (systemMsg) {
      result.push(systemMsg)
      totalTokens += systemMsg.tokens
    }
    
    // ä»åå¾€å‰æ·»åŠ æ¶ˆæ¯ï¼Œç›´åˆ°è¾¾åˆ°ç›®æ ‡
    for (let i = messages.length - 1; i >= 0; i--) {
      const msg = messages[i]
      if (msg.role === "system") continue
      
      if (totalTokens + msg.tokens <= targetTokens) {
        result.unshift(msg)
        totalTokens += msg.tokens
      }
    }
    
    console.log(`[SlidingWindow] å‹ç¼©: ${messages.length} -> ${result.length} æ¡æ¶ˆæ¯`)
    return result
  }
}

// ç­–ç•¥ 2ï¼šæ‘˜è¦å‹ç¼©ï¼ˆéœ€è¦ LLMï¼‰
export class SummaryStrategy implements CompactionStrategy {
  name = "summary"
  private summarize: (text: string) => Promise<string>
  
  constructor(summarize: (text: string) => Promise<string>) {
    this.summarize = summarize
  }
  
  async compact(messages: Message[], targetTokens: number): Promise<Message[]> {
    const result: Message[] = []
    let totalTokens = 0
    
    // ä¿ç•™ system æ¶ˆæ¯
    const systemMsg = messages.find(m => m.role === "system")
    if (systemMsg) {
      result.push(systemMsg)
      totalTokens += systemMsg.tokens
    }
    
    // å°†æ—©æœŸå¯¹è¯å‹ç¼©æˆæ‘˜è¦
    const earlyMessages = messages.filter(m => m.role !== "system").slice(0, -4)
    const recentMessages = messages.filter(m => m.role !== "system").slice(-4)
    
    if (earlyMessages.length > 0) {
      // ç”Ÿæˆæ‘˜è¦
      const conversationText = earlyMessages
        .map(m => `${m.role}: ${m.content}`)
        .join("\n")
      
      const summary = await this.summarize(conversationText)
      const summaryMsg: Message = {
        role: "assistant",
        content: `[å¯¹è¯æ‘˜è¦]\n${summary}`,
        tokens: TokenCounter.estimate(summary),
        timestamp: Date.now(),
        compressed: true,
      }
      result.push(summaryMsg)
      totalTokens += summaryMsg.tokens
    }
    
    // æ·»åŠ æœ€è¿‘çš„æ¶ˆæ¯
    for (const msg of recentMessages) {
      result.push(msg)
      totalTokens += msg.tokens
    }
    
    console.log(`[Summary] å‹ç¼©: ${messages.length} -> ${result.length} æ¡æ¶ˆæ¯`)
    return result
  }
}

// å‹ç¼©å¼•æ“ï¼šç»„åˆå¤šç§ç­–ç•¥
export class CompactionEngine {
  private strategies: CompactionStrategy[]
  
  constructor(strategies: CompactionStrategy[]) {
    this.strategies = strategies
  }
  
  async compact(
    messages: Message[], 
    targetTokens: number,
    preferredStrategy?: string
  ): Promise<Message[]> {
    // é€‰æ‹©ç­–ç•¥
    const strategy = preferredStrategy
      ? this.strategies.find(s => s.name === preferredStrategy)
      : this.strategies[0]
    
    if (!strategy) {
      throw new Error(`Strategy not found: ${preferredStrategy}`)
    }
    
    return strategy.compact(messages, targetTokens)
  }
}
```

#### æ­¥éª¤ 5ï¼šå®ç° Agent ä¸»é€»è¾‘

```typescript
// src/agent.ts
import OpenAI from "openai"
import { ContextManager, ContextConfig, Message } from "./context-manager"
import { CompactionEngine, SlidingWindowStrategy, SummaryStrategy } from "./compaction"
import { TokenCounter } from "./token"

export class LongConversationAgent {
  private client: OpenAI
  private contextManager: ContextManager
  private compactionEngine: CompactionEngine
  private model: string
  private totalCost: number = 0
  
  constructor(config: {
    apiKey: string
    model?: string
    contextConfig?: Partial<ContextConfig>
  }) {
    this.client = new OpenAI({ apiKey: config.apiKey })
    this.model = config.model || "gpt-4o-mini"
    
    // é»˜è®¤é…ç½®
    const defaultConfig: ContextConfig = {
      maxTokens: 128000,      // GPT-4o çš„ä¸Šä¸‹æ–‡çª—å£
      reserveOutput: 4096,    // é¢„ç•™ 4K è¾“å‡º
      compactionThreshold: 0.8,  // 80% æ—¶è§¦å‘å‹ç¼©
    }
    
    this.contextManager = new ContextManager({
      ...defaultConfig,
      ...config.contextConfig,
    })
    
    // åˆå§‹åŒ–å‹ç¼©å¼•æ“
    this.compactionEngine = new CompactionEngine([
      new SlidingWindowStrategy(),
      new SummaryStrategy(this.generateSummary.bind(this)),
    ])
  }
  
  // ä½¿ç”¨ LLM ç”Ÿæˆæ‘˜è¦
  private async generateSummary(text: string): Promise<string> {
    const response = await this.client.chat.completions.create({
      model: this.model,
      messages: [
        {
          role: "system",
          content: "è¯·ç®€æ´åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯ï¼Œä¿ç•™å…³é”®ä¿¡æ¯å’Œå†³ç­–ç‚¹ã€‚",
        },
        {
          role: "user",
          content: text,
        },
      ],
      max_tokens: 500,
    })
    return response.choices[0].message.content || ""
  }
  
  // è®¾ç½® System Prompt
  setSystemPrompt(prompt: string): void {
    this.contextManager.addMessage("system", prompt)
  }
  
  // å‘é€æ¶ˆæ¯å¹¶è·å–å›å¤
  async chat(userMessage: string): Promise<string> {
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    this.contextManager.addMessage("user", userMessage)
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©
    if (this.contextManager.needsCompaction()) {
      console.log("âš ï¸ è§¦å‘ä¸Šä¸‹æ–‡å‹ç¼©...")
      const messages = this.contextManager.getMessages() as Message[]
      const targetTokens = this.contextManager.getAvailableTokens() * 0.6
      const compacted = await this.compactionEngine.compact(messages, targetTokens, "summary")
      this.contextManager.setMessages(compacted)
      console.log("âœ… å‹ç¼©å®Œæˆ")
    }
    
    // è°ƒç”¨ LLM
    const response = await this.client.chat.completions.create({
      model: this.model,
      messages: this.contextManager.getMessages(),
    })
    
    const assistantMessage = response.choices[0].message.content || ""
    
    // æ·»åŠ åŠ©æ‰‹å›å¤
    this.contextManager.addMessage("assistant", assistantMessage)
    
    // æ›´æ–°æˆæœ¬ï¼ˆç®€åŒ–è®¡ç®—ï¼‰
    const usage = response.usage
    if (usage) {
      // GPT-4o-mini å®šä»·ï¼š$0.15/1M input, $0.60/1M output
      const inputCost = (usage.prompt_tokens / 1_000_000) * 0.15
      const outputCost = (usage.completion_tokens / 1_000_000) * 0.60
      this.totalCost += inputCost + outputCost
    }
    
    return assistantMessage
  }
  
  // è·å–çŠ¶æ€
  getStatus() {
    return {
      ...this.contextManager.getStats(),
      totalCost: `$${this.totalCost.toFixed(4)}`,
    }
  }
}
```

#### æ­¥éª¤ 6ï¼šåˆ›å»ºå…¥å£æ–‡ä»¶

```typescript
// src/index.ts
import { LongConversationAgent } from "./agent"
import * as readline from "readline"

async function main() {
  const agent = new LongConversationAgent({
    apiKey: process.env.OPENAI_API_KEY!,
    model: "gpt-4o-mini",
    contextConfig: {
      maxTokens: 16000,  // ä½¿ç”¨è¾ƒå°çš„çª—å£ä¾¿äºæµ‹è¯•
      compactionThreshold: 0.7,
    },
  })
  
  agent.setSystemPrompt("ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ï¼Œæ“…é•¿è¿›è¡Œé•¿å¯¹è¯å¹¶è®°ä½é‡è¦ä¿¡æ¯ã€‚")
  
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  })
  
  console.log("ğŸ¤– é•¿å¯¹è¯ Agent å·²å¯åŠ¨ï¼è¾“å…¥ 'status' æŸ¥çœ‹çŠ¶æ€ï¼Œ'quit' é€€å‡ºã€‚\n")
  
  const prompt = () => {
    rl.question("You: ", async (input) => {
      if (input.toLowerCase() === "quit") {
        console.log("\næœ€ç»ˆçŠ¶æ€:", agent.getStatus())
        rl.close()
        return
      }
      
      if (input.toLowerCase() === "status") {
        console.log("\nğŸ“Š çŠ¶æ€:", agent.getStatus(), "\n")
        prompt()
        return
      }
      
      try {
        const response = await agent.chat(input)
        console.log(`\nAssistant: ${response}\n`)
      } catch (error) {
        console.error("Error:", error)
      }
      
      prompt()
    })
  }
  
  prompt()
}

main()
```

### è¿è¡Œé¡¹ç›®

```bash
# è®¾ç½® API Key
export OPENAI_API_KEY="your-api-key"

# è¿è¡Œ
bun run src/index.ts
```

### æ‰©å±•æ€è€ƒ

1. **å¦‚ä½•å®ç°æ›´æ™ºèƒ½çš„å‹ç¼©è§¦å‘ï¼Ÿ** 
   - è€ƒè™‘å¯¹è¯çš„"é‡è¦æ€§"è€Œä¸ä»…ä»…æ˜¯ Token æ•°é‡

2. **å¦‚ä½•ä¼˜åŒ–æ‘˜è¦è´¨é‡ï¼Ÿ**
   - ä½¿ç”¨æ›´å¥½çš„ Prompt
   - ä¿ç•™å…³é”®å®ä½“å’Œå†³ç­–ç‚¹

3. **å¦‚ä½•å®ç° Prompt Cachingï¼Ÿ**
   - ç ”ç©¶ Anthropic çš„ cache_control API
   - è®¾è®¡ç¼“å­˜è¾¹ç•Œ

4. **å¦‚ä½•å¤„ç†å¤šè½®å·¥å…·è°ƒç”¨ï¼Ÿ**
   - å·¥å…·è¾“å‡ºçš„é€‰æ‹©æ€§ä¿ç•™
   - å·¥å…·è°ƒç”¨é“¾çš„æ‘˜è¦



---

## 9. çŸ¥è¯†è¡¥å……

### ç›¸å…³è®ºæ–‡

| è®ºæ–‡ | ä¸»é¢˜ | å…³é”®è´¡çŒ® |
|------|------|----------|
| [Lost in the Middle](https://arxiv.org/abs/2307.03172) | é•¿ä¸Šä¸‹æ–‡ç†è§£ | å‘ç° LLM å¯¹ä¸­é—´ä½ç½®ä¿¡æ¯çš„åˆ©ç”¨ç‡è¾ƒä½ |
| [LongLoRA](https://arxiv.org/abs/2309.12307) | é•¿ä¸Šä¸‹æ–‡å¾®è°ƒ | é«˜æ•ˆæ‰©å±•ä¸Šä¸‹æ–‡çª—å£çš„æ–¹æ³• |
| [Scaling Transformer to 1M tokens](https://arxiv.org/abs/2304.11062) | è¶…é•¿ä¸Šä¸‹æ–‡ | Ring Attention ç­‰æŠ€æœ¯ |
| [MemGPT](https://arxiv.org/abs/2310.08560) | è™šæ‹Ÿä¸Šä¸‹æ–‡ç®¡ç† | æ“ä½œç³»ç»Ÿå¼çš„å†…å­˜ç®¡ç†æ€æƒ³ |

### æ¨èé˜…è¯»

1. **Anthropic Prompt Caching æ–‡æ¡£**
   - https://docs.anthropic.com/en/docs/build-with-claude/prompt-caching
   - å®˜æ–¹çš„ Prompt Caching ä½¿ç”¨æŒ‡å—

2. **OpenAI Tokenizer**
   - https://platform.openai.com/tokenizer
   - åœ¨çº¿ Token è®¡ç®—å·¥å…·ï¼Œç†è§£ Token åˆ‡åˆ†

3. **LangChain Memory æ¨¡å—**
   - https://python.langchain.com/docs/modules/memory/
   - å„ç§å¯¹è¯è®°å¿†ç­–ç•¥çš„å®ç°å‚è€ƒ

4. **LlamaIndex ä¸Šä¸‹æ–‡ç®¡ç†**
   - https://docs.llamaindex.ai/en/stable/
   - RAG åœºæ™¯ä¸‹çš„ä¸Šä¸‹æ–‡ä¼˜åŒ–

### å¼€æºé¡¹ç›®å‚è€ƒ

| é¡¹ç›® | ç‰¹ç‚¹ | é“¾æ¥ |
|------|------|------|
| OpenCode | ç”Ÿäº§çº§ Agentï¼Œå®Œæ•´çš„å‹ç¼©å®ç° | æœ¬æ•™ç¨‹ä¸»è¦å‚è€ƒ |
| MemGPT | è™šæ‹Ÿå†…å­˜ç®¡ç† | https://github.com/cpacker/MemGPT |
| AutoGPT | é•¿æœŸè®°å¿†å®éªŒ | https://github.com/Significant-Gravitas/AutoGPT |

---

## 10. æœ¬ç« å°ç»“

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸Šä¸‹æ–‡å·¥ç¨‹æ ¸å¿ƒæ¦‚å¿µ                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Token åŸºç¡€                                                 â”‚
â”‚  â”œâ”€â”€ Token æ˜¯ LLM å¤„ç†æ–‡æœ¬çš„åŸºæœ¬å•ä½                       â”‚
â”‚  â”œâ”€â”€ çº¦ 4 ä¸ªè‹±æ–‡å­—ç¬¦ = 1 ä¸ª Token                          â”‚
â”‚  â””â”€â”€ ä¸åŒæ¨¡å‹æœ‰ä¸åŒçš„ä¸Šä¸‹æ–‡çª—å£é™åˆ¶                        â”‚
â”‚                                                             â”‚
â”‚  æˆæœ¬ä¼˜åŒ–                                                   â”‚
â”‚  â”œâ”€â”€ è¾“å‡º Token æ¯”è¾“å…¥è´µ 3-5 å€                            â”‚
â”‚  â”œâ”€â”€ Prompt Caching å¯èŠ‚çœ 90% é‡å¤å†…å®¹æˆæœ¬                â”‚
â”‚  â””â”€â”€ é€‰æ‹©åˆé€‚çš„æ¨¡å‹å’Œå‹ç¼©ç­–ç•¥                              â”‚
â”‚                                                             â”‚
â”‚  å‹ç¼©ç­–ç•¥                                                   â”‚
â”‚  â”œâ”€â”€ æ‘˜è¦å‹ç¼©ï¼šé«˜å‹ç¼©æ¯”ï¼Œä¿ç•™è¯­ä¹‰                          â”‚
â”‚  â”œâ”€â”€ æ»‘åŠ¨çª—å£ï¼šç®€å•é«˜æ•ˆï¼Œå¯èƒ½ä¸¢å¤±æ—©æœŸä¸Šä¸‹æ–‡                â”‚
â”‚  â”œâ”€â”€ é€‰æ‹©æ€§ä¿ç•™ï¼šæ ¹æ®é‡è¦æ€§ç­›é€‰                            â”‚
â”‚  â””â”€â”€ å·¥å…·è¾“å‡ºè£å‰ªï¼šé’ˆå¯¹å·¥å…·è°ƒç”¨çš„ä¼˜åŒ–                      â”‚
â”‚                                                             â”‚
â”‚  é•¿å¯¹è¯ç®¡ç†                                                 â”‚
â”‚  â”œâ”€â”€ æº¢å‡ºæ£€æµ‹ï¼šç›‘æ§ Token ä½¿ç”¨ç‡                           â”‚
â”‚  â”œâ”€â”€ å¢é‡æ‘˜è¦ï¼šåœ¨å…³é”®ç‚¹ç”Ÿæˆæ‘˜è¦                            â”‚
â”‚  â””â”€â”€ ç»„åˆç­–ç•¥ï¼šå¤šç§æ–¹æ³•é…åˆä½¿ç”¨                            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OpenCode ä»£ç å¯¹ç…§è¡¨

| æ¦‚å¿µ | OpenCode æ–‡ä»¶ | å…³é”®å‡½æ•°/ç±» |
|------|---------------|-------------|
| Token ä¼°ç®— | `src/util/token.ts` | `Token.estimate()` |
| æº¢å‡ºæ£€æµ‹ | `src/session/compaction.ts` | `isOverflow()` |
| å·¥å…·è¾“å‡ºè£å‰ª | `src/session/compaction.ts` | `prune()` |
| æ‘˜è¦ç”Ÿæˆ | `src/session/summary.ts` | `summarizeMessage()` |
| å‹ç¼©æµç¨‹ | `src/session/compaction.ts` | `process()` |
| ä¸»å¾ªç¯é›†æˆ | `src/session/prompt.ts` | `loop()` |

### æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šä»€ä¹ˆæ˜¯ Token ä»¥åŠå¦‚ä½•ä¼°ç®— Token æ•°é‡
- [ ] ç†è§£ä¸Šä¸‹æ–‡çª—å£é™åˆ¶å¯¹ Agent çš„å½±å“
- [ ] æè¿°è‡³å°‘ 3 ç§ä¸Šä¸‹æ–‡å‹ç¼©ç­–ç•¥åŠå…¶ä¼˜ç¼ºç‚¹
- [ ] è§£é‡Š Prompt Caching çš„åŸç†å’Œæˆæœ¬èŠ‚çœæœºåˆ¶
- [ ] é˜…è¯»å¹¶ç†è§£ OpenCode çš„å‹ç¼©å®ç°ä»£ç 
- [ ] å®ç°ä¸€ä¸ªç®€å•çš„æ»‘åŠ¨çª—å£ä¸Šä¸‹æ–‡ç®¡ç†å™¨
- [ ] è®¾è®¡ä¸€ä¸ªå¸¦å‹ç¼©åŠŸèƒ½çš„é•¿å¯¹è¯ Agent

### å¸¸è§é—®é¢˜

**Q: ä»€ä¹ˆæ—¶å€™åº”è¯¥è§¦å‘å‹ç¼©ï¼Ÿ**

A: é€šå¸¸åœ¨ Token ä½¿ç”¨ç‡è¾¾åˆ° 70-80% æ—¶è§¦å‘ã€‚å¤ªæ—©ä¼šä¸¢å¤±æœ‰ç”¨ä¿¡æ¯ï¼Œå¤ªæ™šå¯èƒ½å¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚

**Q: æ‘˜è¦å‹ç¼©ä¼šä¸¢å¤±é‡è¦ä¿¡æ¯å—ï¼Ÿ**

A: å¯èƒ½ä¼šã€‚å…³é”®æ˜¯è®¾è®¡å¥½æ‘˜è¦ Promptï¼Œç¡®ä¿ä¿ç•™ï¼šç”¨æˆ·åŸå§‹éœ€æ±‚ã€å…³é”®å†³ç­–ã€å½“å‰ä»»åŠ¡çŠ¶æ€ã€æ¶‰åŠçš„æ–‡ä»¶ã€‚

**Q: å¦‚ä½•é€‰æ‹©å‹ç¼©ç­–ç•¥ï¼Ÿ**

A: 
- ç®€å•å¯¹è¯ï¼šæ»‘åŠ¨çª—å£è¶³å¤Ÿ
- å¤æ‚ä»»åŠ¡ï¼šæ‘˜è¦å‹ç¼©æ›´å¥½
- å·¥å…·å¯†é›†ï¼šä¼˜å…ˆè£å‰ªå·¥å…·è¾“å‡º
- æœ€ä½³å®è·µï¼šç»„åˆä½¿ç”¨

**Q: Prompt Caching é€‚ç”¨äºæ‰€æœ‰åœºæ™¯å—ï¼Ÿ**

A: ä¸æ˜¯ã€‚åªæœ‰å½“ Prompt å‰ç¼€ç¨³å®šä¸”é‡å¤ä½¿ç”¨æ—¶æ‰æœ‰æ•ˆã€‚é¢‘ç¹å˜åŒ–çš„å†…å®¹ä¸é€‚åˆç¼“å­˜ã€‚

---

## å¯¼èˆª

- [â† ä¸Šä¸€ç« ï¼šå¯¼è¨€](./00-introduction.md)
- [ä¸‹ä¸€ç« ï¼šMulti-Agent ç³»ç»Ÿ â†’](./02-multi-agent.md)
- [è¿”å›ç›®å½•](./00-introduction.md#ç›®å½•)

