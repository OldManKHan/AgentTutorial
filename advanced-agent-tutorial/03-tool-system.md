# ç¬¬ä¸‰ç« ï¼šå·¥å…·ç³»ç»Ÿè®¾è®¡

> ğŸ¯ æœ¬ç« ç›®æ ‡ï¼šæŒæ¡ Agent å·¥å…·ç³»ç»Ÿçš„è®¾è®¡åŸåˆ™ï¼Œå­¦ä¼šæ„å»ºå®‰å…¨ã€å¯æ‰©å±•çš„å·¥å…·ï¼Œç†è§£ MCP åè®®

## ä¸ºä»€ä¹ˆå·¥å…·ç³»ç»Ÿå¦‚æ­¤é‡è¦ï¼Ÿ

å¦‚æœè¯´ LLM æ˜¯ Agent çš„"å¤§è„‘"ï¼Œé‚£ä¹ˆå·¥å…·å°±æ˜¯ Agent çš„"æ‰‹è„š"ã€‚æ²¡æœ‰å·¥å…·ï¼ŒAgent åªèƒ½"çº¸ä¸Šè°ˆå…µ"ï¼›æœ‰äº†å·¥å…·ï¼ŒAgent æ‰èƒ½çœŸæ­£ä¸ä¸–ç•Œäº¤äº’ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent èƒ½åŠ›è¾¹ç•Œ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ²¡æœ‰å·¥å…·çš„ Agentï¼š                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç”¨æˆ·: å¸®æˆ‘åˆ›å»ºä¸€ä¸ªæ–‡ä»¶                             â”‚   â”‚
â”‚  â”‚  Agent: å¥½çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤...                 â”‚   â”‚
â”‚  â”‚         ï¼ˆåªèƒ½ç»™å»ºè®®ï¼Œæ— æ³•æ‰§è¡Œï¼‰                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æœ‰å·¥å…·çš„ Agentï¼š                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç”¨æˆ·: å¸®æˆ‘åˆ›å»ºä¸€ä¸ªæ–‡ä»¶                             â”‚   â”‚
â”‚  â”‚  Agent: [è°ƒç”¨ write å·¥å…·] æ–‡ä»¶å·²åˆ›å»º âœ…             â”‚   â”‚
â”‚  â”‚         ï¼ˆç›´æ¥æ‰§è¡Œï¼Œç«‹å³ç”Ÿæ•ˆï¼‰                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  å·¥å…·å†³å®šäº† Agent çš„èƒ½åŠ›è¾¹ç•Œï¼š                              â”‚
â”‚  â€¢ æ–‡ä»¶æ“ä½œ â†’ read, write, edit å·¥å…·                       â”‚
â”‚  â€¢ å‘½ä»¤æ‰§è¡Œ â†’ bash, shell å·¥å…·                             â”‚
â”‚  â€¢ ç½‘ç»œè¯·æ±‚ â†’ fetch, search å·¥å…·                           â”‚
â”‚  â€¢ ä»£ç ç†è§£ â†’ lsp, codesearch å·¥å…·                         â”‚
â”‚  â€¢ å­ä»»åŠ¡å§”æ´¾ â†’ task å·¥å…·                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä½†å·¥å…·ä¹Ÿæ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼š
- **èƒ½åŠ›è¶Šå¤§ï¼Œé£é™©è¶Šå¤§**ï¼šä¸€ä¸ªèƒ½æ‰§è¡Œä»»æ„å‘½ä»¤çš„å·¥å…·å¯èƒ½è¢«æ»¥ç”¨
- **è®¾è®¡ä¸å½“ï¼Œæ•ˆç‡ä½ä¸‹**ï¼šå·¥å…·æè¿°ä¸æ¸…ä¼šå¯¼è‡´ LLM è¯¯ç”¨
- **ç¼ºä¹æ ‡å‡†ï¼Œéš¾ä»¥æ‰©å±•**ï¼šæ¯ä¸ªé¡¹ç›®éƒ½è¦é‡æ–°å®ç°å·¥å…·ç³»ç»Ÿ

æœ¬ç« å°†æ·±å…¥æ¢è®¨å¦‚ä½•è®¾è®¡ä¼˜ç§€çš„å·¥å…·ç³»ç»Ÿï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨ MCP åè®®å®ç°æ ‡å‡†åŒ–çš„å·¥å…·æ‰©å±•ã€‚

---

## 1. å·¥å…·è®¾è®¡åŸåˆ™

### 1.1 å•ä¸€èŒè´£åŸåˆ™

æ¯ä¸ªå·¥å…·åº”è¯¥åªåšä¸€ä»¶äº‹ï¼Œå¹¶æŠŠå®ƒåšå¥½ã€‚


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å•ä¸€èŒè´£ vs å¤šèŒè´£                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  âŒ ä¸å¥½çš„è®¾è®¡ï¼šä¸€ä¸ªå·¥å…·åšå¤ªå¤šäº‹                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  file_tool(action, path, content, ...)              â”‚   â”‚
â”‚  â”‚  â€¢ action="read" â†’ è¯»å–æ–‡ä»¶                         â”‚   â”‚
â”‚  â”‚  â€¢ action="write" â†’ å†™å…¥æ–‡ä»¶                        â”‚   â”‚
â”‚  â”‚  â€¢ action="delete" â†’ åˆ é™¤æ–‡ä»¶                       â”‚   â”‚
â”‚  â”‚  â€¢ action="list" â†’ åˆ—å‡ºç›®å½•                         â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  é—®é¢˜ï¼š                                             â”‚   â”‚
â”‚  â”‚  â€¢ å‚æ•°å¤æ‚ï¼ŒLLM å®¹æ˜“æ··æ·†                           â”‚   â”‚
â”‚  â”‚  â€¢ æƒé™éš¾ä»¥ç»†ç²’åº¦æ§åˆ¶                               â”‚   â”‚
â”‚  â”‚  â€¢ æè¿°å†—é•¿ï¼Œå ç”¨ä¸Šä¸‹æ–‡                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  âœ… å¥½çš„è®¾è®¡ï¼šæ¯ä¸ªå·¥å…·ä¸“æ³¨ä¸€ä»¶äº‹                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  read(filePath, offset?, limit?)    â†’ è¯»å–æ–‡ä»¶      â”‚   â”‚
â”‚  â”‚  write(filePath, content)           â†’ å†™å…¥æ–‡ä»¶      â”‚   â”‚
â”‚  â”‚  edit(filePath, oldStr, newStr)     â†’ ç¼–è¾‘æ–‡ä»¶      â”‚   â”‚
â”‚  â”‚  list(path, depth?)                 â†’ åˆ—å‡ºç›®å½•      â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  ä¼˜ç‚¹ï¼š                                             â”‚   â”‚
â”‚  â”‚  â€¢ å‚æ•°ç®€å•ï¼ŒLLM æ˜“äºç†è§£                           â”‚   â”‚
â”‚  â”‚  â€¢ æƒé™å¯ä»¥æŒ‰å·¥å…·æ§åˆ¶                               â”‚   â”‚
â”‚  â”‚  â€¢ æè¿°ç®€æ´ï¼ŒèŠ‚çœä¸Šä¸‹æ–‡                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ç²’åº¦é€‰æ‹©

å·¥å…·çš„ç²’åº¦éœ€è¦åœ¨"å¤ªç»†"å’Œ"å¤ªç²—"ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚

| ç²’åº¦ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| ç»†ç²’åº¦ | çµæ´»ã€å¯ç»„åˆ | è°ƒç”¨æ¬¡æ•°å¤šã€æ•ˆç‡ä½ | åŸºç¡€æ“ä½œ |
| ç²—ç²’åº¦ | æ•ˆç‡é«˜ã€ä¸€æ­¥åˆ°ä½ | ä¸çµæ´»ã€éš¾ä»¥å¤ç”¨ | å¸¸è§ä»»åŠ¡ |
| ä¸­ç­‰ç²’åº¦ | å¹³è¡¡çµæ´»æ€§å’Œæ•ˆç‡ | éœ€è¦ä»”ç»†è®¾è®¡ | å¤§å¤šæ•°åœºæ™¯ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç²’åº¦é€‰æ‹©ç¤ºä¾‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä»»åŠ¡ï¼šåœ¨æ–‡ä»¶ä¸­æŸ¥æ‰¾å¹¶æ›¿æ¢æ–‡æœ¬                               â”‚
â”‚                                                             â”‚
â”‚  ç»†ç²’åº¦æ–¹æ¡ˆï¼ˆ3 æ¬¡è°ƒç”¨ï¼‰ï¼š                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. read(file) â†’ è·å–å†…å®¹                           â”‚   â”‚
â”‚  â”‚  2. [LLM å¤„ç†] â†’ è®¡ç®—æ›¿æ¢                           â”‚   â”‚
â”‚  â”‚  3. write(file, newContent) â†’ å†™å…¥                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä¸­ç­‰ç²’åº¦æ–¹æ¡ˆï¼ˆ1 æ¬¡è°ƒç”¨ï¼‰ï¼š                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  edit(file, oldStr, newStr) â†’ ç›´æ¥æ›¿æ¢              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ç²—ç²’åº¦æ–¹æ¡ˆï¼ˆ1 æ¬¡è°ƒç”¨ï¼Œä½†ä¸çµæ´»ï¼‰ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  refactor(file, pattern, replacement) â†’ æ‰¹é‡é‡æ„    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  OpenCode çš„é€‰æ‹©ï¼šæä¾›å¤šç§ç²’åº¦çš„å·¥å…·                        â”‚
â”‚  â€¢ read/writeï¼šåŸºç¡€æ“ä½œï¼Œæœ€å¤§çµæ´»æ€§                        â”‚
â”‚  â€¢ editï¼šä¸­ç­‰ç²’åº¦ï¼Œå¸¸ç”¨åœºæ™¯                                â”‚
â”‚  â€¢ multieditï¼šæ‰¹é‡ç¼–è¾‘ï¼Œé«˜æ•ˆå¤„ç†                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å‚æ•°è®¾è®¡

å¥½çš„å‚æ•°è®¾è®¡è®© LLM æ›´å®¹æ˜“æ­£ç¡®ä½¿ç”¨å·¥å…·ã€‚

**å‚æ•°è®¾è®¡åŸåˆ™**ï¼š

1. **å¿…éœ€ vs å¯é€‰**ï¼šæ ¸å¿ƒå‚æ•°å¿…éœ€ï¼Œå¢å¼ºå‚æ•°å¯é€‰
2. **ç±»å‹æ˜ç¡®**ï¼šä½¿ç”¨ schema å®šä¹‰ç±»å‹ï¼Œé¿å…æ­§ä¹‰
3. **é»˜è®¤å€¼åˆç†**ï¼šå¯é€‰å‚æ•°åº”æœ‰åˆç†çš„é»˜è®¤å€¼
4. **å‘½åæ¸…æ™°**ï¼šå‚æ•°ååº”è¯¥è‡ªè§£é‡Š

```typescript
// OpenCode read å·¥å…·çš„å‚æ•°è®¾è®¡ç¤ºä¾‹
const parameters = z.object({
  // å¿…éœ€å‚æ•°ï¼šæ–‡ä»¶è·¯å¾„
  filePath: z.string()
    .describe("The path to the file to read"),
  
  // å¯é€‰å‚æ•°ï¼šèµ·å§‹è¡Œï¼ˆé»˜è®¤ 0ï¼‰
  offset: z.coerce.number()
    .describe("The line number to start reading from (0-based)")
    .optional(),
  
  // å¯é€‰å‚æ•°ï¼šè¯»å–è¡Œæ•°ï¼ˆé»˜è®¤ 2000ï¼‰
  limit: z.coerce.number()
    .describe("The number of lines to read (defaults to 2000)")
    .optional(),
})
```

### 1.4 è¿”å›å€¼è®¾è®¡

è¿”å›å€¼åº”è¯¥ç»“æ„åŒ–ã€ä¿¡æ¯ä¸°å¯Œï¼Œä¾¿äº LLM ç†è§£å’Œåç»­å¤„ç†ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è¿”å›å€¼è®¾è®¡æ¨¡å¼                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  åŸºæœ¬ç»“æ„ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  {                                                  â”‚   â”‚
â”‚  â”‚    title: string,      // ç®€çŸ­æ ‡é¢˜ï¼Œç”¨äº UI æ˜¾ç¤º    â”‚   â”‚
â”‚  â”‚    output: string,     // ä¸»è¦è¾“å‡ºï¼ŒLLM ä¼šçœ‹åˆ°      â”‚   â”‚
â”‚  â”‚    metadata: object,   // å…ƒæ•°æ®ï¼Œç”¨äº UI å’Œè°ƒè¯•    â”‚   â”‚
â”‚  â”‚    attachments?: [],   // é™„ä»¶ï¼ˆå¦‚å›¾ç‰‡ã€æ–‡ä»¶ï¼‰      â”‚   â”‚
â”‚  â”‚  }                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ç¤ºä¾‹ï¼ˆread å·¥å…·ï¼‰ï¼š                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  {                                                  â”‚   â”‚
â”‚  â”‚    title: "src/index.ts",                           â”‚   â”‚
â”‚  â”‚    output: "<file>\n00001| import ...\n</file>",    â”‚   â”‚
â”‚  â”‚    metadata: {                                      â”‚   â”‚
â”‚  â”‚      preview: "import { App } from './app'..."      â”‚   â”‚
â”‚  â”‚    }                                                â”‚   â”‚
â”‚  â”‚  }                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  è®¾è®¡è¦ç‚¹ï¼š                                                 â”‚
â”‚  â€¢ titleï¼šç®€æ´ï¼Œä¾¿äºç”¨æˆ·å¿«é€Ÿäº†è§£æ“ä½œ                       â”‚
â”‚  â€¢ outputï¼šå®Œæ•´ï¼ŒåŒ…å« LLM éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯                   â”‚
â”‚  â€¢ metadataï¼šä¸°å¯Œï¼Œæ”¯æŒ UI å±•ç¤ºå’Œè°ƒè¯•                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. å·¥å…·æè¿°çš„ Prompt Engineering

å·¥å…·æè¿°æ˜¯ LLM ç†è§£å·¥å…·çš„å”¯ä¸€é€”å¾„ã€‚å¥½çš„æè¿°èƒ½æ˜¾è‘—æé«˜å·¥å…·ä½¿ç”¨çš„å‡†ç¡®æ€§ã€‚

### 2.1 æè¿°ç»“æ„

ä¸€ä¸ªå®Œæ•´çš„å·¥å…·æè¿°åº”åŒ…å«ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å·¥å…·æè¿°ç»“æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. åŠŸèƒ½æ¦‚è¿°ï¼ˆWhatï¼‰                                        â”‚
â”‚     â””â”€â”€ ä¸€å¥è¯è¯´æ˜å·¥å…·åšä»€ä¹ˆ                               â”‚
â”‚                                                             â”‚
â”‚  2. ä½¿ç”¨åœºæ™¯ï¼ˆWhenï¼‰                                        â”‚
â”‚     â””â”€â”€ ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨è¿™ä¸ªå·¥å…·                         â”‚
â”‚                                                             â”‚
â”‚  3. å‚æ•°è¯´æ˜ï¼ˆHowï¼‰                                         â”‚
â”‚     â””â”€â”€ æ¯ä¸ªå‚æ•°çš„å«ä¹‰å’Œæ ¼å¼                               â”‚
â”‚                                                             â”‚
â”‚  4. ä½¿ç”¨ç¤ºä¾‹ï¼ˆExampleï¼‰                                     â”‚
â”‚     â””â”€â”€ å…·ä½“çš„è°ƒç”¨ç¤ºä¾‹                                     â”‚
â”‚                                                             â”‚
â”‚  5. æ³¨æ„äº‹é¡¹ï¼ˆCautionï¼‰                                     â”‚
â”‚     â””â”€â”€ è¾¹ç•Œæ¡ä»¶ã€é™åˆ¶ã€å¸¸è§é”™è¯¯                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æè¿°ç¤ºä¾‹

ä»¥ OpenCode çš„ `read` å·¥å…·ä¸ºä¾‹ï¼š

```markdown
Read the contents of a file from the local filesystem.

## When to use
- When you need to examine the contents of an existing file
- When you need to understand code structure or implementation
- When you need to verify file contents before making changes

## Parameters
- filePath: The path to the file to read (relative or absolute)
- offset: (optional) Line number to start reading from (0-based)
- limit: (optional) Number of lines to read (defaults to 2000)

## Output format
The file contents are returned with line numbers:
```
00001| first line
00002| second line
...
```

## Important notes
- Cannot read binary files (images, executables, etc.)
- Cannot read .env files for security reasons
- Large files are automatically truncated
- Use offset/limit for very large files
```

### 2.3 å¸¸è§é”™è¯¯é¿å…

| é”™è¯¯ç±»å‹ | é”™è¯¯ç¤ºä¾‹ | æ­£ç¡®ç¤ºä¾‹ |
|----------|----------|----------|
| æè¿°æ¨¡ç³Š | "å¤„ç†æ–‡ä»¶" | "è¯»å–æ–‡ä»¶å†…å®¹å¹¶è¿”å›å¸¦è¡Œå·çš„æ–‡æœ¬" |
| ç¼ºå°‘è¾¹ç•Œ | "è¯»å–æ–‡ä»¶" | "è¯»å–æ–‡ä»¶ï¼ˆä¸æ”¯æŒäºŒè¿›åˆ¶æ–‡ä»¶ï¼‰" |
| å‚æ•°ä¸æ¸… | "path: è·¯å¾„" | "filePath: æ–‡ä»¶çš„ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„" |
| ç¼ºå°‘ç¤ºä¾‹ | æ—  | "ç¤ºä¾‹ï¼šread('src/index.ts')" |

---

## 3. æƒé™ä¸å®‰å…¨è®¾è®¡

å·¥å…·ç³»ç»Ÿçš„å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚ä¸€ä¸ªè®¾è®¡ä¸å½“çš„å·¥å…·å¯èƒ½å¯¼è‡´ï¼š
- æ•æ„Ÿæ–‡ä»¶æ³„éœ²
- ç³»ç»Ÿè¢«æ¶æ„å‘½ä»¤ç ´å
- ç”¨æˆ·æ•°æ®è¢«æ„å¤–åˆ é™¤

### 3.1 æƒé™æ¨¡å‹è®¾è®¡


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OpenCode æƒé™æ¨¡å‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æƒé™è§„åˆ™ç»“æ„ï¼š                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  {                                                  â”‚   â”‚
â”‚  â”‚    permission: "bash",     // æƒé™ç±»å‹              â”‚   â”‚
â”‚  â”‚    pattern: "git *",       // åŒ¹é…æ¨¡å¼              â”‚   â”‚
â”‚  â”‚    action: "allow"         // åŠ¨ä½œï¼šallow/deny/ask  â”‚   â”‚
â”‚  â”‚  }                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æƒé™åŠ¨ä½œï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  allow  â†’ è‡ªåŠ¨å…è®¸ï¼Œæ— éœ€ç¡®è®¤                        â”‚   â”‚
â”‚  â”‚  deny   â†’ è‡ªåŠ¨æ‹’ç»ï¼ŒæŠ›å‡ºé”™è¯¯                        â”‚   â”‚
â”‚  â”‚  ask    â†’ è¯¢é—®ç”¨æˆ·ï¼Œç­‰å¾…ç¡®è®¤                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æƒé™è¯„ä¼°æµç¨‹ï¼š                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  å·¥å…·è°ƒç”¨ â†’ æå–æƒé™è¯·æ±‚ â†’ åŒ¹é…è§„åˆ™ â†’ æ‰§è¡ŒåŠ¨ä½œ      â”‚   â”‚
â”‚  â”‚                              â”‚                      â”‚   â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚  â”‚              â–¼               â–¼               â–¼      â”‚   â”‚
â”‚  â”‚           allow           deny            ask       â”‚   â”‚
â”‚  â”‚              â”‚               â”‚               â”‚      â”‚   â”‚
â”‚  â”‚              â–¼               â–¼               â–¼      â”‚   â”‚
â”‚  â”‚           æ‰§è¡Œ            æ‹’ç»           ç­‰å¾…ç”¨æˆ·   â”‚   â”‚
â”‚  â”‚                                              â”‚      â”‚   â”‚
â”‚  â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚                              â–¼               â–¼   â–¼  â”‚   â”‚
â”‚  â”‚                           once          always rejectâ”‚   â”‚
â”‚  â”‚                              â”‚               â”‚   â”‚  â”‚   â”‚
â”‚  â”‚                              â–¼               â–¼   â–¼  â”‚   â”‚
â”‚  â”‚                           æ‰§è¡Œä¸€æ¬¡      è®°ä½å¹¶æ‰§è¡Œ æ‹’ç»â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•æ„Ÿæ“ä½œä¿æŠ¤

æŸäº›æ“ä½œéœ€è¦ç‰¹åˆ«ä¿æŠ¤ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•æ„Ÿæ“ä½œåˆ†ç±»                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  é«˜é£é™©æ“ä½œï¼ˆé»˜è®¤ deny æˆ– askï¼‰ï¼š                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ åˆ é™¤æ–‡ä»¶/ç›®å½•ï¼šrm, rmdir                         â”‚   â”‚
â”‚  â”‚  â€¢ ä¿®æ”¹æƒé™ï¼šchmod, chown                           â”‚   â”‚
â”‚  â”‚  â€¢ ç½‘ç»œæ“ä½œï¼šcurl, wgetï¼ˆæŸäº›åœºæ™¯ï¼‰                 â”‚   â”‚
â”‚  â”‚  â€¢ ç³»ç»Ÿå‘½ä»¤ï¼šsudo, su                               â”‚   â”‚
â”‚  â”‚  â€¢ è¯»å–æ•æ„Ÿæ–‡ä»¶ï¼š.env, credentials                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä¸­é£é™©æ“ä½œï¼ˆé»˜è®¤ askï¼‰ï¼š                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ å†™å…¥æ–‡ä»¶ï¼šwrite, edit                            â”‚   â”‚
â”‚  â”‚  â€¢ æ‰§è¡Œå‘½ä»¤ï¼šbashï¼ˆéç™½åå•å‘½ä»¤ï¼‰                   â”‚   â”‚
â”‚  â”‚  â€¢ è®¿é—®å¤–éƒ¨ç›®å½•ï¼šé¡¹ç›®ç›®å½•å¤–çš„æ–‡ä»¶                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä½é£é™©æ“ä½œï¼ˆå¯ä»¥ allowï¼‰ï¼š                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ è¯»å–æ–‡ä»¶ï¼šreadï¼ˆéæ•æ„Ÿæ–‡ä»¶ï¼‰                     â”‚   â”‚
â”‚  â”‚  â€¢ åˆ—å‡ºç›®å½•ï¼šlist, glob                             â”‚   â”‚
â”‚  â”‚  â€¢ æœç´¢ä»£ç ï¼šgrep, codesearch                       â”‚   â”‚
â”‚  â”‚  â€¢ å®‰å…¨å‘½ä»¤ï¼šgit status, npm list                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 OpenCode çš„å®‰å…¨å®è·µ

OpenCode åœ¨å·¥å…·å®ç°ä¸­é‡‡ç”¨äº†å¤šå±‚å®‰å…¨æªæ–½ï¼š

```typescript
// 1. æ–‡ä»¶è¯»å–ä¿æŠ¤ï¼šé˜»æ­¢è¯»å– .env æ–‡ä»¶
const block = iife(() => {
  const basename = path.basename(filepath)
  const whitelist = [".env.sample", ".env.example"]
  
  if (whitelist.some((w) => basename.endsWith(w))) return false
  // é˜»æ­¢ .env, .env.local, .env.production ç­‰
  if (/^\.env(\.|$)/.test(basename)) return true
  
  return false
})

if (block) {
  throw new Error(`The user has blocked you from reading ${filepath}`)
}

// 2. å¤–éƒ¨ç›®å½•è®¿é—®ä¿æŠ¤
if (!Filesystem.contains(Instance.directory, filepath)) {
  await ctx.ask({
    permission: "external_directory",
    patterns: [parentDir],
    // ...
  })
}

// 3. å‘½ä»¤æ‰§è¡Œä¿æŠ¤ï¼šè§£æå‘½ä»¤å¹¶è¯·æ±‚æƒé™
const tree = await parser().then((p) => p.parse(params.command))
// è§£æå‡ºå…·ä½“å‘½ä»¤ï¼Œå¦‚ "rm -rf /tmp/test"
// ç„¶åè¯·æ±‚å¯¹åº”æƒé™
await ctx.ask({
  permission: "bash",
  patterns: Array.from(patterns),
  // ...
})
```

---

## 4. é”™è¯¯å¤„ç†ç­–ç•¥

å·¥å…·æ‰§è¡Œå¯èƒ½å¤±è´¥ï¼Œå¥½çš„é”™è¯¯å¤„ç†èƒ½å¸®åŠ© Agent ä»é”™è¯¯ä¸­æ¢å¤ã€‚

### 4.1 é”™è¯¯åˆ†ç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é”™è¯¯ç±»å‹åˆ†ç±»                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å‚æ•°é”™è¯¯ï¼ˆå¯æ¢å¤ï¼‰                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  â€¢ æ–‡ä»¶è·¯å¾„ä¸å­˜åœ¨                               â”‚    â”‚
â”‚     â”‚  â€¢ å‚æ•°æ ¼å¼é”™è¯¯                                 â”‚    â”‚
â”‚     â”‚  â€¢ ç¼ºå°‘å¿…éœ€å‚æ•°                                 â”‚    â”‚
â”‚     â”‚                                                 â”‚    â”‚
â”‚     â”‚  å¤„ç†ï¼šè¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼Œè®© LLM ä¿®æ­£åé‡è¯•    â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  2. æƒé™é”™è¯¯ï¼ˆéœ€è¦ç”¨æˆ·ä»‹å…¥ï¼‰                                â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  â€¢ ç”¨æˆ·æ‹’ç»æƒé™                                 â”‚    â”‚
â”‚     â”‚  â€¢ é…ç½®ç¦æ­¢çš„æ“ä½œ                               â”‚    â”‚
â”‚     â”‚                                                 â”‚    â”‚
â”‚     â”‚  å¤„ç†ï¼šåœæ­¢æ‰§è¡Œï¼Œå‘ŠçŸ¥ç”¨æˆ·åŸå›                    â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  3. æ‰§è¡Œé”™è¯¯ï¼ˆå¯èƒ½å¯æ¢å¤ï¼‰                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  â€¢ å‘½ä»¤æ‰§è¡Œå¤±è´¥                                 â”‚    â”‚
â”‚     â”‚  â€¢ ç½‘ç»œè¯·æ±‚è¶…æ—¶                                 â”‚    â”‚
â”‚     â”‚  â€¢ èµ„æºä¸å¯ç”¨                                   â”‚    â”‚
â”‚     â”‚                                                 â”‚    â”‚
â”‚     â”‚  å¤„ç†ï¼šè¿”å›é”™è¯¯è¯¦æƒ…ï¼Œè®© LLM å†³å®šæ˜¯å¦é‡è¯•        â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚  4. ç³»ç»Ÿé”™è¯¯ï¼ˆä¸å¯æ¢å¤ï¼‰                                    â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚  â€¢ å†…å­˜ä¸è¶³                                     â”‚    â”‚
â”‚     â”‚  â€¢ ç£ç›˜ç©ºé—´ä¸è¶³                                 â”‚    â”‚
â”‚     â”‚  â€¢ ç³»ç»Ÿå´©æºƒ                                     â”‚    â”‚
â”‚     â”‚                                                 â”‚    â”‚
â”‚     â”‚  å¤„ç†ï¼šç»ˆæ­¢æ‰§è¡Œï¼Œè®°å½•æ—¥å¿—                       â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 é”™è¯¯ä¿¡æ¯è®¾è®¡

å¥½çš„é”™è¯¯ä¿¡æ¯åº”è¯¥ï¼š
1. **è¯´æ˜å‘ç”Ÿäº†ä»€ä¹ˆ**ï¼šæ¸…æ™°æè¿°é”™è¯¯
2. **è¯´æ˜ä¸ºä»€ä¹ˆå‘ç”Ÿ**ï¼šç»™å‡ºå¯èƒ½çš„åŸå› 
3. **è¯´æ˜å¦‚ä½•ä¿®å¤**ï¼šæä¾›è§£å†³å»ºè®®

```typescript
// OpenCode read å·¥å…·çš„é”™è¯¯å¤„ç†ç¤ºä¾‹
if (!(await file.exists())) {
  const dir = path.dirname(filepath)
  const base = path.basename(filepath)
  
  // å°è¯•æ‰¾åˆ°ç›¸ä¼¼çš„æ–‡ä»¶åï¼Œæä¾›å»ºè®®
  const dirEntries = fs.readdirSync(dir)
  const suggestions = dirEntries
    .filter((entry) =>
      entry.toLowerCase().includes(base.toLowerCase()) ||
      base.toLowerCase().includes(entry.toLowerCase())
    )
    .slice(0, 3)
  
  if (suggestions.length > 0) {
    throw new Error(
      `File not found: ${filepath}\n\n` +
      `Did you mean one of these?\n${suggestions.join("\n")}`
    )
  }
  
  throw new Error(`File not found: ${filepath}`)
}
```

---

## 5. MCP åè®®

### 5.1 ä»€ä¹ˆæ˜¯ MCPï¼Ÿ

MCPï¼ˆModel Context Protocolï¼‰æ˜¯ Anthropic æå‡ºçš„å¼€æ”¾åè®®ï¼Œç”¨äºæ ‡å‡†åŒ– AI åº”ç”¨ä¸å¤–éƒ¨å·¥å…·/æ•°æ®æºçš„è¿æ¥ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MCP æ¶æ„æ¦‚è§ˆ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä¼ ç»Ÿæ–¹å¼ï¼šæ¯ä¸ªåº”ç”¨éƒ½è¦å®ç°è‡ªå·±çš„å·¥å…·é›†æˆ                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  App A â”€â”€â”¬â”€â”€ GitHub API                             â”‚   â”‚
â”‚  â”‚          â”œâ”€â”€ Slack API                              â”‚   â”‚
â”‚  â”‚          â””â”€â”€ Database                               â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  App B â”€â”€â”¬â”€â”€ GitHub API  (é‡å¤å®ç°)                 â”‚   â”‚
â”‚  â”‚          â”œâ”€â”€ Slack API   (é‡å¤å®ç°)                 â”‚   â”‚
â”‚  â”‚          â””â”€â”€ Database    (é‡å¤å®ç°)                 â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  MCP æ–¹å¼ï¼šæ ‡å‡†åŒ–åè®®ï¼Œå·¥å…·å¯å¤ç”¨                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  App A â”€â”€â”                                          â”‚   â”‚
â”‚  â”‚          â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚  â”‚          â”œâ”€â”€â”€â”€â–ºâ”‚ MCP Server  â”‚â”€â”€â”€â”€ GitHub API       â”‚   â”‚
â”‚  â”‚          â”‚     â”‚ (GitHub)    â”‚                      â”‚   â”‚
â”‚  â”‚  App B â”€â”€â”¤     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚  â”‚          â”‚                                          â”‚   â”‚
â”‚  â”‚          â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚  â”‚          â”œâ”€â”€â”€â”€â–ºâ”‚ MCP Server  â”‚â”€â”€â”€â”€ Slack API        â”‚   â”‚
â”‚  â”‚          â”‚     â”‚ (Slack)     â”‚                      â”‚   â”‚
â”‚  â”‚          â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚  â”‚          â”‚                                          â”‚   â”‚
â”‚  â”‚          â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚  â”‚          â””â”€â”€â”€â”€â–ºâ”‚ MCP Server  â”‚â”€â”€â”€â”€ Database         â”‚   â”‚
â”‚  â”‚                â”‚ (DB)        â”‚                      â”‚   â”‚
â”‚  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä¼˜åŠ¿ï¼š                                                     â”‚
â”‚  â€¢ å·¥å…·å®ç°ä¸€æ¬¡ï¼Œå¤šå¤„å¤ç”¨                                  â”‚
â”‚  â€¢ æ ‡å‡†åŒ–æ¥å£ï¼Œé™ä½é›†æˆæˆæœ¬                                â”‚
â”‚  â€¢ ç¤¾åŒºå…±äº«ï¼Œç”Ÿæ€ç¹è£                                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 MCP æ ¸å¿ƒæ¦‚å¿µ

MCP å®šä¹‰äº†ä¸‰ç§æ ¸å¿ƒèƒ½åŠ›ï¼š

| èƒ½åŠ› | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| Tools | å¯æ‰§è¡Œçš„æ“ä½œ | åˆ›å»º GitHub Issueã€å‘é€ Slack æ¶ˆæ¯ |
| Resources | å¯è¯»å–çš„æ•°æ® | æ–‡ä»¶å†…å®¹ã€æ•°æ®åº“è®°å½• |
| Prompts | é¢„å®šä¹‰çš„æç¤ºæ¨¡æ¿ | ä»£ç å®¡æŸ¥æ¨¡æ¿ã€æ–‡æ¡£ç”Ÿæˆæ¨¡æ¿ |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MCP èƒ½åŠ›æ¨¡å‹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MCP Server                        â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚   Tools     â”‚  â”‚  Resources  â”‚  â”‚   Prompts   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æ‰§è¡Œæ“ä½œ  â”‚  â”‚ â€¢ æä¾›æ•°æ®  â”‚  â”‚ â€¢ æç¤ºæ¨¡æ¿  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æœ‰å‰¯ä½œç”¨  â”‚  â”‚ â€¢ åªè¯»è®¿é—®  â”‚  â”‚ â€¢ å¯å‚æ•°åŒ–  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ éœ€è¦æƒé™  â”‚  â”‚ â€¢ å¯è®¢é˜…    â”‚  â”‚ â€¢ å¯ç»„åˆ    â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  é€šä¿¡æ–¹å¼ï¼š                                                 â”‚
â”‚  â€¢ æœ¬åœ°ï¼šstdioï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰                             â”‚
â”‚  â€¢ è¿œç¨‹ï¼šHTTP/SSEï¼ˆæ”¯æŒ OAuth è®¤è¯ï¼‰                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 MCP é…ç½®

OpenCode æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶æ·»åŠ  MCP Serverï¼š

```json
// opencode.json
{
  "mcp": {
    "github": {
      "type": "local",
      "command": ["npx", "-y", "@modelcontextprotocol/server-github"],
      "environment": {
        "GITHUB_TOKEN": "${GITHUB_TOKEN}"
      }
    },
    "weather": {
      "type": "remote",
      "url": "https://weather-mcp.example.com",
      "oauth": {
        "clientId": "your-client-id"
      }
    }
  }
}
```

### 5.4 MCP vs å†…ç½®å·¥å…·

| ç‰¹æ€§ | å†…ç½®å·¥å…· | MCP å·¥å…· |
|------|----------|----------|
| æ€§èƒ½ | é«˜ï¼ˆè¿›ç¨‹å†…ï¼‰ | ä¸­ï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰ |
| çµæ´»æ€§ | ä½ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç ï¼‰ | é«˜ï¼ˆé…ç½®å³å¯ï¼‰ |
| ç”Ÿæ€ | æœ‰é™ | ä¸°å¯Œï¼ˆç¤¾åŒºå…±äº«ï¼‰ |
| å®‰å…¨ | å®Œå…¨æ§åˆ¶ | éœ€è¦ä¿¡ä»» Server |
| é€‚ç”¨åœºæ™¯ | æ ¸å¿ƒåŠŸèƒ½ | æ‰©å±•åŠŸèƒ½ |

---


## 6. OpenCode å®è·µæ¡ˆä¾‹

è®©æˆ‘ä»¬æ·±å…¥åˆ†æ OpenCode æ˜¯å¦‚ä½•å®ç°å·¥å…·ç³»ç»Ÿçš„ã€‚

### 6.1 å·¥å…·å®šä¹‰æ¡†æ¶

OpenCode åœ¨ `packages/opencode/src/tool/tool.ts` ä¸­å®šä¹‰äº†å·¥å…·çš„åŸºç¡€æ¡†æ¶ï¼š

```typescript
// packages/opencode/src/tool/tool.tsï¼ˆç®€åŒ–ç‰ˆï¼‰

export namespace Tool {
  // å·¥å…·ä¸Šä¸‹æ–‡ï¼šæä¾›ç»™å·¥å…·æ‰§è¡Œæ—¶ä½¿ç”¨çš„ä¿¡æ¯å’Œæ–¹æ³•
  export type Context = {
    sessionID: string       // å½“å‰ä¼šè¯ ID
    messageID: string       // å½“å‰æ¶ˆæ¯ ID
    agent: string           // å½“å‰ Agent åç§°
    abort: AbortSignal      // ä¸­æ­¢ä¿¡å·ï¼Œç”¨äºå–æ¶ˆæ‰§è¡Œ
    
    // æ›´æ–°å·¥å…·çš„å…ƒæ•°æ®ï¼ˆç”¨äº UI æ˜¾ç¤ºï¼‰
    metadata(input: { title?: string; metadata?: any }): void
    
    // è¯·æ±‚æƒé™
    ask(input: {
      permission: string    // æƒé™ç±»å‹ï¼Œå¦‚ "read", "bash"
      patterns: string[]    // åŒ¹é…æ¨¡å¼ï¼Œå¦‚ ["*.ts", "src/*"]
      always?: string[]     // "å§‹ç»ˆå…è®¸"æ—¶è®°ä½çš„æ¨¡å¼
      metadata: any         // é¢å¤–ä¿¡æ¯
    }): Promise<void>
  }

  // å·¥å…·ä¿¡æ¯æ¥å£
  export interface Info<Parameters, Metadata> {
    id: string              // å·¥å…·å”¯ä¸€æ ‡è¯†
    init: (ctx?: InitContext) => Promise<{
      description: string   // å·¥å…·æè¿°ï¼ˆç»™ LLM çœ‹ï¼‰
      parameters: Parameters // å‚æ•° Schema
      execute(args, ctx): Promise<{
        title: string       // æ‰§è¡Œç»“æœæ ‡é¢˜
        metadata: Metadata  // å…ƒæ•°æ®
        output: string      // è¾“å‡ºå†…å®¹ï¼ˆç»™ LLM çœ‹ï¼‰
        attachments?: []    // é™„ä»¶ï¼ˆå¦‚å›¾ç‰‡ï¼‰
      }>
    }>
  }

  // å·¥å…·å®šä¹‰è¾…åŠ©å‡½æ•°
  export function define<Parameters, Metadata>(
    id: string,
    init: Info<Parameters, Metadata>["init"]
  ): Info<Parameters, Metadata> {
    return {
      id,
      init: async (ctx) => {
        const toolInfo = init instanceof Function ? await init(ctx) : init
        const execute = toolInfo.execute
        
        // åŒ…è£… executeï¼Œæ·»åŠ å‚æ•°éªŒè¯
        toolInfo.execute = (args, ctx) => {
          try {
            toolInfo.parameters.parse(args)  // Zod éªŒè¯
          } catch (error) {
            // è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ© LLM ä¿®æ­£
            throw new Error(
              `The ${id} tool was called with invalid arguments: ${error}.\n` +
              `Please rewrite the input so it satisfies the expected schema.`
            )
          }
          return execute(args, ctx)
        }
        return toolInfo
      },
    }
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **Context æ¨¡å¼**ï¼šé€šè¿‡ Context æä¾›ä¼šè¯ä¿¡æ¯å’Œæƒé™è¯·æ±‚èƒ½åŠ›
2. **å‚æ•°éªŒè¯**ï¼šä½¿ç”¨ Zod è¿›è¡Œç±»å‹å®‰å…¨çš„å‚æ•°éªŒè¯
3. **å‹å¥½é”™è¯¯**ï¼šéªŒè¯å¤±è´¥æ—¶è¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
4. **å…ƒæ•°æ®æ›´æ–°**ï¼šæ”¯æŒå®æ—¶æ›´æ–° UI æ˜¾ç¤º

### 6.2 Read å·¥å…·å®ç°

`read` å·¥å…·æ˜¯æœ€åŸºç¡€çš„æ–‡ä»¶è¯»å–å·¥å…·ï¼š

```typescript
// packages/opencode/src/tool/read.tsï¼ˆç®€åŒ–ç‰ˆï¼‰

export const ReadTool = Tool.define("read", {
  description: DESCRIPTION,  // ä» read.txt åŠ è½½è¯¦ç»†æè¿°
  
  parameters: z.object({
    filePath: z.string().describe("The path to the file to read"),
    offset: z.coerce.number()
      .describe("The line number to start reading from (0-based)")
      .optional(),
    limit: z.coerce.number()
      .describe("The number of lines to read (defaults to 2000)")
      .optional(),
  }),
  
  async execute(params, ctx) {
    let filepath = params.filePath
    
    // 1. è·¯å¾„å¤„ç†ï¼šè½¬æ¢ä¸ºç»å¯¹è·¯å¾„
    if (!path.isAbsolute(filepath)) {
      filepath = path.join(process.cwd(), filepath)
    }
    const title = path.relative(Instance.worktree, filepath)

    // 2. å®‰å…¨æ£€æŸ¥ï¼šå¤–éƒ¨ç›®å½•éœ€è¦é¢å¤–æƒé™
    if (!Filesystem.contains(Instance.directory, filepath)) {
      await ctx.ask({
        permission: "external_directory",
        patterns: [path.dirname(filepath)],
        // ...
      })
    }

    // 3. æƒé™è¯·æ±‚ï¼šè¯»å–æƒé™
    await ctx.ask({
      permission: "read",
      patterns: [filepath],
      always: ["*"],  // ç”¨æˆ·é€‰æ‹©"å§‹ç»ˆå…è®¸"æ—¶ï¼Œå…è®¸æ‰€æœ‰æ–‡ä»¶
      metadata: {},
    })

    // 4. æ•æ„Ÿæ–‡ä»¶ä¿æŠ¤ï¼šé˜»æ­¢è¯»å– .env æ–‡ä»¶
    if (/^\.env(\.|$)/.test(path.basename(filepath))) {
      throw new Error(`The user has blocked you from reading ${filepath}`)
    }

    // 5. æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
    const file = Bun.file(filepath)
    if (!(await file.exists())) {
      // æä¾›ç›¸ä¼¼æ–‡ä»¶å»ºè®®
      const suggestions = findSimilarFiles(filepath)
      throw new Error(
        `File not found: ${filepath}\n\n` +
        `Did you mean one of these?\n${suggestions.join("\n")}`
      )
    }

    // 6. äºŒè¿›åˆ¶æ–‡ä»¶æ£€æµ‹
    if (await isBinaryFile(filepath, file)) {
      throw new Error(`Cannot read binary file: ${filepath}`)
    }

    // 7. è¯»å–å¹¶æ ¼å¼åŒ–å†…å®¹
    const limit = params.limit ?? 2000
    const offset = params.offset || 0
    const lines = await file.text().then((text) => text.split("\n"))
    
    // æ·»åŠ è¡Œå·ï¼Œä¾¿äº LLM å®šä½
    const content = lines
      .slice(offset, offset + limit)
      .map((line, index) => {
        // æˆªæ–­è¿‡é•¿çš„è¡Œ
        if (line.length > 2000) line = line.substring(0, 2000) + "..."
        return `${(index + offset + 1).toString().padStart(5, "0")}| ${line}`
      })

    // 8. æ„å»ºè¾“å‡º
    let output = "<file>\n" + content.join("\n")
    
    // æç¤ºæ˜¯å¦è¿˜æœ‰æ›´å¤šå†…å®¹
    if (lines.length > offset + content.length) {
      output += `\n\n(File has more lines. Use 'offset' parameter to read beyond line ${offset + content.length})`
    }
    output += "\n</file>"

    return {
      title,
      output,
      metadata: { preview: content.slice(0, 20).join("\n") },
    }
  },
})
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **å¤šå±‚å®‰å…¨æ£€æŸ¥**ï¼šå¤–éƒ¨ç›®å½•ã€æ•æ„Ÿæ–‡ä»¶ã€äºŒè¿›åˆ¶æ–‡ä»¶
2. **å‹å¥½çš„é”™è¯¯æç¤º**ï¼šæ–‡ä»¶ä¸å­˜åœ¨æ—¶æä¾›ç›¸ä¼¼æ–‡ä»¶å»ºè®®
3. **è¡Œå·æ ¼å¼åŒ–**ï¼šä¾¿äº LLM ç²¾ç¡®å®šä½ä»£ç ä½ç½®
4. **å¤§æ–‡ä»¶å¤„ç†**ï¼šæ”¯æŒåˆ†é¡µè¯»å–ï¼Œé¿å…ä¸Šä¸‹æ–‡æº¢å‡º

### 6.3 Bash å·¥å…·å®ç°

`bash` å·¥å…·å…è®¸æ‰§è¡Œ shell å‘½ä»¤ï¼Œæ˜¯æœ€å¼ºå¤§ä¹Ÿæœ€å±é™©çš„å·¥å…·ï¼š

```typescript
// packages/opencode/src/tool/bash.tsï¼ˆç®€åŒ–ç‰ˆï¼‰

export const BashTool = Tool.define("bash", async () => {
  const shell = Shell.acceptable()  // æ£€æµ‹å¯ç”¨çš„ shell
  
  return {
    description: DESCRIPTION,
    
    parameters: z.object({
      command: z.string().describe("The command to execute"),
      timeout: z.number().describe("Optional timeout in milliseconds").optional(),
      workdir: z.string().describe("The working directory").optional(),
      description: z.string().describe("Clear description of what this command does"),
    }),
    
    async execute(params, ctx) {
      const cwd = params.workdir || Instance.directory
      const timeout = params.timeout ?? 120000  // é»˜è®¤ 2 åˆ†é’Ÿè¶…æ—¶
      
      // 1. è§£æå‘½ä»¤ï¼šä½¿ç”¨ tree-sitter è§£æ bash è¯­æ³•
      const tree = await parser().then((p) => p.parse(params.command))
      
      // 2. æå–éœ€è¦æƒé™æ£€æŸ¥çš„æ“ä½œ
      const directories = new Set<string>()
      const patterns = new Set<string>()
      
      for (const node of tree.rootNode.descendantsOfType("command")) {
        const command = extractCommand(node)
        
        // æ£€æµ‹å±é™©å‘½ä»¤ï¼ˆcd, rm, cp, mv ç­‰ï¼‰
        if (["cd", "rm", "cp", "mv", "mkdir"].includes(command[0])) {
          // è§£æç›®æ ‡è·¯å¾„ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨é¡¹ç›®å¤–
          for (const arg of command.slice(1)) {
            const resolved = await resolvePath(arg, cwd)
            if (!Filesystem.contains(Instance.directory, resolved)) {
              directories.add(resolved)
            }
          }
        }
        
        patterns.add(command.join(" "))
      }

      // 3. è¯·æ±‚å¤–éƒ¨ç›®å½•æƒé™
      if (directories.size > 0) {
        await ctx.ask({
          permission: "external_directory",
          patterns: Array.from(directories),
          // ...
        })
      }

      // 4. è¯·æ±‚å‘½ä»¤æ‰§è¡Œæƒé™
      if (patterns.size > 0) {
        await ctx.ask({
          permission: "bash",
          patterns: Array.from(patterns),
          // ...
        })
      }

      // 5. æ‰§è¡Œå‘½ä»¤
      const proc = spawn(params.command, {
        shell,
        cwd,
        stdio: ["ignore", "pipe", "pipe"],
      })

      let output = ""
      
      // 6. å®æ—¶æ›´æ–°è¾“å‡ºï¼ˆç”¨äº UI æ˜¾ç¤ºï¼‰
      const append = (chunk: Buffer) => {
        if (output.length <= 30000) {  // é™åˆ¶è¾“å‡ºé•¿åº¦
          output += chunk.toString()
          ctx.metadata({
            metadata: { output, description: params.description },
          })
        }
      }
      
      proc.stdout?.on("data", append)
      proc.stderr?.on("data", append)

      // 7. è¶…æ—¶å¤„ç†
      let timedOut = false
      const timeoutTimer = setTimeout(() => {
        timedOut = true
        Shell.killTree(proc)  // æ€æ­»è¿›ç¨‹æ ‘
      }, timeout)

      // 8. ç­‰å¾…å®Œæˆ
      await new Promise((resolve) => proc.once("exit", resolve))
      clearTimeout(timeoutTimer)

      // 9. æ·»åŠ å…ƒæ•°æ®
      if (output.length > 30000) {
        output = output.slice(0, 30000) + "\n[truncated]"
      }
      if (timedOut) {
        output += `\n[timeout after ${timeout}ms]`
      }

      return {
        title: params.description,
        metadata: { output, exit: proc.exitCode },
        output,
      }
    },
  }
})
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **å‘½ä»¤è§£æ**ï¼šä½¿ç”¨ tree-sitter è§£æ bash è¯­æ³•ï¼Œç²¾ç¡®æå–å‘½ä»¤
2. **ç»†ç²’åº¦æƒé™**ï¼šæ ¹æ®å…·ä½“å‘½ä»¤è¯·æ±‚æƒé™ï¼Œè€Œéä¸€åˆ€åˆ‡
3. **å®æ—¶è¾“å‡º**ï¼šé€šè¿‡ metadata å®æ—¶æ›´æ–° UI
4. **è¶…æ—¶ä¿æŠ¤**ï¼šé˜²æ­¢å‘½ä»¤æ— é™æ‰§è¡Œ
5. **è¾“å‡ºé™åˆ¶**ï¼šé˜²æ­¢è¾“å‡ºè¿‡é•¿å ç”¨ä¸Šä¸‹æ–‡

### 6.4 æƒé™ç³»ç»Ÿå®ç°

OpenCode çš„æƒé™ç³»ç»Ÿåœ¨ `packages/opencode/src/permission/next.ts` ä¸­ï¼š

```typescript
// packages/opencode/src/permission/next.tsï¼ˆç®€åŒ–ç‰ˆï¼‰

export namespace PermissionNext {
  // æƒé™åŠ¨ä½œç±»å‹
  export const Action = z.enum(["allow", "deny", "ask"])
  
  // æƒé™è§„åˆ™
  export const Rule = z.object({
    permission: z.string(),  // æƒé™ç±»å‹ï¼Œå¦‚ "bash", "read"
    pattern: z.string(),     // åŒ¹é…æ¨¡å¼ï¼Œå¦‚ "git *", "*.ts"
    action: Action,          // åŠ¨ä½œ
  })
  
  // æƒé™è¯·æ±‚å¤„ç†
  export const ask = async (input: {
    permission: string
    patterns: string[]
    ruleset: Ruleset
    // ...
  }) => {
    const s = await state()
    
    for (const pattern of input.patterns) {
      // è¯„ä¼°æƒé™è§„åˆ™
      const rule = evaluate(input.permission, pattern, input.ruleset, s.approved)
      
      if (rule.action === "deny") {
        // è‡ªåŠ¨æ‹’ç»
        throw new DeniedError(input.ruleset)
      }
      
      if (rule.action === "ask") {
        // éœ€è¦ç”¨æˆ·ç¡®è®¤
        return new Promise<void>((resolve, reject) => {
          s.pending[id] = { info, resolve, reject }
          Bus.publish(Event.Asked, info)  // é€šçŸ¥ UI æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        })
      }
      
      // action === "allow"ï¼šè‡ªåŠ¨å…è®¸ï¼Œç»§ç»­
    }
  }
  
  // ç”¨æˆ·å›å¤å¤„ç†
  export const reply = async (input: {
    requestID: string
    reply: "once" | "always" | "reject"
    message?: string
  }) => {
    const s = await state()
    const existing = s.pending[input.requestID]
    
    if (input.reply === "reject") {
      // ç”¨æˆ·æ‹’ç»
      existing.reject(new RejectedError())
      return
    }
    
    if (input.reply === "once") {
      // ä»…æœ¬æ¬¡å…è®¸
      existing.resolve()
      return
    }
    
    if (input.reply === "always") {
      // å§‹ç»ˆå…è®¸ï¼šè®°ä½è¿™ä¸ªæ¨¡å¼
      for (const pattern of existing.info.always) {
        s.approved.push({
          permission: existing.info.permission,
          pattern,
          action: "allow",
        })
      }
      existing.resolve()
    }
  }
  
  // æƒé™è§„åˆ™è¯„ä¼°
  export function evaluate(
    permission: string,
    pattern: string,
    ...rulesets: Ruleset[]
  ): Rule {
    const merged = merge(...rulesets)
    
    // ä»åå¾€å‰æŸ¥æ‰¾åŒ¹é…çš„è§„åˆ™ï¼ˆåé¢çš„è§„åˆ™ä¼˜å…ˆçº§æ›´é«˜ï¼‰
    const match = merged.findLast((rule) =>
      Wildcard.match(permission, rule.permission) &&
      Wildcard.match(pattern, rule.pattern)
    )
    
    // æ²¡æœ‰åŒ¹é…è§„åˆ™æ—¶ï¼Œé»˜è®¤ ask
    return match ?? { action: "ask", permission, pattern: "*" }
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **è§„åˆ™ä¼˜å…ˆçº§**ï¼šåå®šä¹‰çš„è§„åˆ™ä¼˜å…ˆçº§æ›´é«˜
2. **é€šé…ç¬¦åŒ¹é…**ï¼šæ”¯æŒ `*` é€šé…ç¬¦
3. **ä¸‰ç§å›å¤**ï¼šonceï¼ˆä»…æœ¬æ¬¡ï¼‰ã€alwaysï¼ˆå§‹ç»ˆï¼‰ã€rejectï¼ˆæ‹’ç»ï¼‰
4. **çŠ¶æ€æŒä¹…åŒ–**ï¼š`always` çš„è§„åˆ™ä¼šè¢«è®°ä½

### 6.5 MCP å®¢æˆ·ç«¯å®ç°

OpenCode çš„ MCP å®¢æˆ·ç«¯åœ¨ `packages/opencode/src/mcp/index.ts` ä¸­ï¼š

```typescript
// packages/opencode/src/mcp/index.tsï¼ˆç®€åŒ–ç‰ˆï¼‰

export namespace MCP {
  // åˆ›å»º MCP è¿æ¥
  async function create(key: string, mcp: Config.Mcp) {
    if (mcp.type === "local") {
      // æœ¬åœ° MCP Serverï¼šé€šè¿‡ stdio é€šä¿¡
      const [cmd, ...args] = mcp.command
      const transport = new StdioClientTransport({
        command: cmd,
        args,
        cwd: Instance.directory,
        env: { ...process.env, ...mcp.environment },
      })
      
      const client = new Client({
        name: "opencode",
        version: Installation.VERSION,
      })
      
      await client.connect(transport)
      return { mcpClient: client, status: { status: "connected" } }
    }
    
    if (mcp.type === "remote") {
      // è¿œç¨‹ MCP Serverï¼šé€šè¿‡ HTTP/SSE é€šä¿¡
      // æ”¯æŒ OAuth è®¤è¯
      const authProvider = new McpOAuthProvider(key, mcp.url, mcp.oauth)
      
      const transports = [
        new StreamableHTTPClientTransport(new URL(mcp.url), { authProvider }),
        new SSEClientTransport(new URL(mcp.url), { authProvider }),
      ]
      
      // å°è¯•ä¸åŒçš„ä¼ è¾“æ–¹å¼
      for (const transport of transports) {
        try {
          const client = new Client({ name: "opencode", version: VERSION })
          await client.connect(transport)
          return { mcpClient: client, status: { status: "connected" } }
        } catch (error) {
          if (error instanceof UnauthorizedError) {
            // éœ€è¦ OAuth è®¤è¯
            return { status: { status: "needs_auth" } }
          }
        }
      }
    }
  }
  
  // è·å–æ‰€æœ‰ MCP å·¥å…·
  export async function tools() {
    const result: Record<string, Tool> = {}
    const clientsSnapshot = await clients()
    
    for (const [clientName, client] of Object.entries(clientsSnapshot)) {
      // è·å–è¯¥ Server çš„æ‰€æœ‰å·¥å…·
      const toolsResult = await client.listTools()
      
      for (const mcpTool of toolsResult.tools) {
        // è½¬æ¢ä¸º AI SDK æ ¼å¼
        // å·¥å…·åæ ¼å¼ï¼š{serverName}_{toolName}
        const toolName = `${clientName}_${mcpTool.name}`
        result[toolName] = await convertMcpTool(mcpTool, client)
      }
    }
    
    return result
  }
  
  // è½¬æ¢ MCP å·¥å…·ä¸º AI SDK æ ¼å¼
  async function convertMcpTool(mcpTool: MCPToolDef, client: Client): Promise<Tool> {
    return dynamicTool({
      description: mcpTool.description ?? "",
      inputSchema: jsonSchema(mcpTool.inputSchema),
      execute: async (args) => {
        // è°ƒç”¨ MCP Server æ‰§è¡Œå·¥å…·
        return client.callTool({
          name: mcpTool.name,
          arguments: args,
        })
      },
    })
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **å¤šä¼ è¾“æ”¯æŒ**ï¼šstdioï¼ˆæœ¬åœ°ï¼‰ã€HTTP/SSEï¼ˆè¿œç¨‹ï¼‰
2. **OAuth é›†æˆ**ï¼šè¿œç¨‹ Server æ”¯æŒ OAuth è®¤è¯
3. **å·¥å…·å‘½å**ï¼š`{serverName}_{toolName}` é¿å…å†²çª
4. **åŠ¨æ€åŠ è½½**ï¼šè¿è¡Œæ—¶ä» Server è·å–å·¥å…·å®šä¹‰

---


## 7. åŠ¨æ‰‹å®éªŒ

### å®éªŒ 1ï¼šå·¥å…·å‚æ•°è®¾è®¡

**ç›®æ ‡**ï¼šç†è§£å¥½çš„å‚æ•°è®¾è®¡å¦‚ä½•å½±å“å·¥å…·çš„å¯ç”¨æ€§

**æ­¥éª¤**ï¼š

1. åˆ›å»ºä¸€ä¸ªç®€å•çš„æ–‡ä»¶æœç´¢å·¥å…·ï¼š

```typescript
// search-tool.ts
import z from "zod"

// ç‰ˆæœ¬ 1ï¼šå‚æ•°è®¾è®¡ä¸ä½³
const searchToolV1 = {
  name: "search",
  description: "Search for files",
  parameters: z.object({
    q: z.string(),           // å‚æ•°åä¸æ¸…æ™°
    d: z.string().optional(), // ä»€ä¹ˆæ˜¯ dï¼Ÿ
    r: z.boolean().optional(), // ä»€ä¹ˆæ˜¯ rï¼Ÿ
  }),
}

// ç‰ˆæœ¬ 2ï¼šå‚æ•°è®¾è®¡è‰¯å¥½
const searchToolV2 = {
  name: "search",
  description: "Search for files matching a pattern in the specified directory",
  parameters: z.object({
    pattern: z.string()
      .describe("The glob pattern to match files (e.g., '*.ts', 'src/**/*.js')"),
    directory: z.string()
      .describe("The directory to search in (defaults to current directory)")
      .optional(),
    recursive: z.boolean()
      .describe("Whether to search recursively in subdirectories")
      .optional(),
  }),
}

// æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬
console.log("ç‰ˆæœ¬ 1 å‚æ•°ï¼š", searchToolV1.parameters.shape)
console.log("ç‰ˆæœ¬ 2 å‚æ•°ï¼š", searchToolV2.parameters.shape)
```

2. æ€è€ƒï¼šå¦‚æœä½ æ˜¯ LLMï¼Œå“ªä¸ªç‰ˆæœ¬æ›´å®¹æ˜“æ­£ç¡®ä½¿ç”¨ï¼Ÿ

### å®éªŒ 2ï¼šæƒé™ç³»ç»Ÿæ¨¡æ‹Ÿ

**ç›®æ ‡**ï¼šç†è§£æƒé™è§„åˆ™çš„åŒ¹é…å’Œä¼˜å…ˆçº§

**æ­¥éª¤**ï¼š

1. å®ç°ä¸€ä¸ªç®€å•çš„æƒé™è¯„ä¼°å™¨ï¼š

```typescript
// permission-evaluator.ts

type Action = "allow" | "deny" | "ask"

interface Rule {
  permission: string
  pattern: string
  action: Action
}

// ç®€å•çš„é€šé…ç¬¦åŒ¹é…
function wildcardMatch(pattern: string, text: string): boolean {
  if (pattern === "*") return true
  if (pattern.endsWith("*")) {
    return text.startsWith(pattern.slice(0, -1))
  }
  return pattern === text
}

// è¯„ä¼°æƒé™
function evaluate(permission: string, pattern: string, rules: Rule[]): Action {
  // ä»åå¾€å‰æŸ¥æ‰¾ï¼ˆåé¢çš„è§„åˆ™ä¼˜å…ˆçº§æ›´é«˜ï¼‰
  for (let i = rules.length - 1; i >= 0; i--) {
    const rule = rules[i]
    if (wildcardMatch(rule.permission, permission) &&
        wildcardMatch(rule.pattern, pattern)) {
      return rule.action
    }
  }
  return "ask"  // é»˜è®¤è¯¢é—®
}

// æµ‹è¯•è§„åˆ™é›†
const rules: Rule[] = [
  { permission: "*", pattern: "*", action: "ask" },           // é»˜è®¤è¯¢é—®
  { permission: "read", pattern: "*", action: "allow" },      // å…è®¸æ‰€æœ‰è¯»å–
  { permission: "read", pattern: ".env*", action: "deny" },   // ç¦æ­¢è¯»å– .env
  { permission: "bash", pattern: "git *", action: "allow" },  // å…è®¸ git å‘½ä»¤
  { permission: "bash", pattern: "rm *", action: "deny" },    // ç¦æ­¢ rm å‘½ä»¤
]

// æµ‹è¯•ç”¨ä¾‹
const testCases = [
  { permission: "read", pattern: "src/index.ts" },
  { permission: "read", pattern: ".env" },
  { permission: "bash", pattern: "git status" },
  { permission: "bash", pattern: "rm -rf /" },
  { permission: "write", pattern: "test.txt" },
]

for (const test of testCases) {
  const result = evaluate(test.permission, test.pattern, rules)
  console.log(`${test.permission}:${test.pattern} â†’ ${result}`)
}
```

2. è¿è¡Œå¹¶è§‚å¯Ÿç»“æœï¼š

```bash
bun run permission-evaluator.ts
```

3. å°è¯•æ·»åŠ æ–°è§„åˆ™ï¼Œè§‚å¯Ÿä¼˜å…ˆçº§å¦‚ä½•å·¥ä½œ

### å®éªŒ 3ï¼šå·¥å…·è¾“å‡ºæ ¼å¼åŒ–

**ç›®æ ‡**ï¼šç†è§£è¾“å‡ºæ ¼å¼å¯¹ LLM ç†è§£çš„å½±å“

**æ­¥éª¤**ï¼š

1. æ¯”è¾ƒä¸åŒçš„è¾“å‡ºæ ¼å¼ï¼š

```typescript
// output-format.ts

const fileContent = `import { App } from './app'
import { Config } from './config'

export function main() {
  const config = Config.load()
  const app = new App(config)
  app.start()
}
`

// æ ¼å¼ 1ï¼šçº¯æ–‡æœ¬
function formatPlain(content: string): string {
  return content
}

// æ ¼å¼ 2ï¼šå¸¦è¡Œå·
function formatWithLineNumbers(content: string): string {
  return content
    .split("\n")
    .map((line, i) => `${(i + 1).toString().padStart(3, "0")}| ${line}`)
    .join("\n")
}

// æ ¼å¼ 3ï¼šå¸¦ XML æ ‡ç­¾
function formatWithXml(content: string, filename: string): string {
  const numbered = formatWithLineNumbers(content)
  return `<file name="${filename}">\n${numbered}\n</file>`
}

// æ ¼å¼ 4ï¼šå¸¦å…ƒæ•°æ®
function formatWithMetadata(content: string, filename: string): string {
  const lines = content.split("\n")
  return JSON.stringify({
    filename,
    totalLines: lines.length,
    content: formatWithLineNumbers(content),
    preview: lines.slice(0, 5).join("\n"),
  }, null, 2)
}

console.log("=== æ ¼å¼ 1ï¼šçº¯æ–‡æœ¬ ===")
console.log(formatPlain(fileContent))

console.log("\n=== æ ¼å¼ 2ï¼šå¸¦è¡Œå· ===")
console.log(formatWithLineNumbers(fileContent))

console.log("\n=== æ ¼å¼ 3ï¼šå¸¦ XML æ ‡ç­¾ ===")
console.log(formatWithXml(fileContent, "src/index.ts"))

console.log("\n=== æ ¼å¼ 4ï¼šå¸¦å…ƒæ•°æ® ===")
console.log(formatWithMetadata(fileContent, "src/index.ts"))
```

2. æ€è€ƒï¼šå“ªç§æ ¼å¼æœ€é€‚åˆ LLM ç†è§£å’Œåç»­æ“ä½œï¼Ÿ

---

## 8. å®æˆ˜é¡¹ç›®ï¼šä»é›¶æ„å»º MCP Server

### é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ªå¤©æ°”æŸ¥è¯¢ MCP Serverï¼Œå®ç°ï¼š
1. æ ‡å‡†çš„ MCP åè®®æ¥å£
2. å·¥å…·å®šä¹‰å’Œæ‰§è¡Œ
3. é”™è¯¯å¤„ç†
4. ä¸ OpenCode é›†æˆ

### é¡¹ç›®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤©æ°” MCP Server æ¶æ„                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    MCP Server                        â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              Tools                           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ get_weather(city)                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    è·å–æŒ‡å®šåŸå¸‚çš„å½“å‰å¤©æ°”                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ get_forecast(city, days)                 â”‚   â”‚   â”‚
â”‚  â”‚  â”‚    è·å–æœªæ¥å‡ å¤©çš„å¤©æ°”é¢„æŠ¥                   â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                             â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              Transport                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                             â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  stdioï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                             â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                                  â”‚
â”‚                          â”‚ MCP åè®®                         â”‚
â”‚                          â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    OpenCode                          â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  Agent: "åŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"                      â”‚   â”‚
â”‚  â”‚         â†“                                           â”‚   â”‚
â”‚  â”‚  [è°ƒç”¨ weather_get_weather(city="åŒ—äº¬")]            â”‚   â”‚
â”‚  â”‚         â†“                                           â”‚   â”‚
â”‚  â”‚  "åŒ—äº¬ä»Šå¤©æ™´ï¼Œæ°”æ¸© 25Â°Cï¼Œé€‚åˆå¤–å‡º"                  â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°æ­¥éª¤

#### æ­¥éª¤ 1ï¼šåˆ›å»ºé¡¹ç›®ç»“æ„

```bash
mkdir weather-mcp-server
cd weather-mcp-server
bun init -y
bun add @modelcontextprotocol/sdk zod
```

```
weather-mcp-server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts        # å…¥å£
â”‚   â”œâ”€â”€ tools.ts        # å·¥å…·å®šä¹‰
â”‚   â””â”€â”€ weather-api.ts  # å¤©æ°” API å°è£…
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

#### æ­¥éª¤ 2ï¼šå®ç°å¤©æ°” API å°è£…

```typescript
// src/weather-api.ts

// æ¨¡æ‹Ÿå¤©æ°”æ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è°ƒç”¨çœŸå® APIï¼‰
const mockWeatherData: Record<string, {
  temperature: number
  condition: string
  humidity: number
  wind: string
}> = {
  "åŒ—äº¬": { temperature: 25, condition: "æ™´", humidity: 45, wind: "ä¸œåŒ—é£ 3çº§" },
  "ä¸Šæµ·": { temperature: 28, condition: "å¤šäº‘", humidity: 65, wind: "ä¸œé£ 2çº§" },
  "å¹¿å·": { temperature: 32, condition: "é˜´", humidity: 80, wind: "å—é£ 2çº§" },
  "æ·±åœ³": { temperature: 30, condition: "å°é›¨", humidity: 85, wind: "ä¸œå—é£ 3çº§" },
}

export interface WeatherData {
  city: string
  temperature: number
  condition: string
  humidity: number
  wind: string
}

export interface ForecastData {
  city: string
  forecasts: Array<{
    date: string
    high: number
    low: number
    condition: string
  }>
}

export async function getWeather(city: string): Promise<WeatherData> {
  // æ¨¡æ‹Ÿ API å»¶è¿Ÿ
  await new Promise(resolve => setTimeout(resolve, 100))
  
  const data = mockWeatherData[city]
  if (!data) {
    throw new Error(`æœªæ‰¾åˆ°åŸå¸‚ "${city}" çš„å¤©æ°”æ•°æ®`)
  }
  
  return { city, ...data }
}

export async function getForecast(city: string, days: number): Promise<ForecastData> {
  await new Promise(resolve => setTimeout(resolve, 100))
  
  const baseData = mockWeatherData[city]
  if (!baseData) {
    throw new Error(`æœªæ‰¾åˆ°åŸå¸‚ "${city}" çš„å¤©æ°”æ•°æ®`)
  }
  
  const forecasts = []
  const today = new Date()
  
  for (let i = 0; i < days; i++) {
    const date = new Date(today)
    date.setDate(date.getDate() + i)
    
    forecasts.push({
      date: date.toISOString().split("T")[0],
      high: baseData.temperature + Math.floor(Math.random() * 5),
      low: baseData.temperature - Math.floor(Math.random() * 8),
      condition: ["æ™´", "å¤šäº‘", "é˜´", "å°é›¨"][Math.floor(Math.random() * 4)],
    })
  }
  
  return { city, forecasts }
}
```

#### æ­¥éª¤ 3ï¼šå®šä¹‰ MCP å·¥å…·

```typescript
// src/tools.ts
import { z } from "zod"
import { getWeather, getForecast } from "./weather-api"

// å·¥å…·å®šä¹‰
export const tools = [
  {
    name: "get_weather",
    description: "è·å–æŒ‡å®šåŸå¸‚çš„å½“å‰å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ¸©åº¦ã€å¤©æ°”çŠ¶å†µã€æ¹¿åº¦å’Œé£åŠ›",
    inputSchema: {
      type: "object" as const,
      properties: {
        city: {
          type: "string",
          description: "åŸå¸‚åç§°ï¼Œå¦‚ 'åŒ—äº¬'ã€'ä¸Šæµ·'",
        },
      },
      required: ["city"],
    },
    handler: async (args: { city: string }) => {
      const weather = await getWeather(args.city)
      return {
        content: [
          {
            type: "text" as const,
            text: `${weather.city}å½“å‰å¤©æ°”ï¼š
- å¤©æ°”ï¼š${weather.condition}
- æ¸©åº¦ï¼š${weather.temperature}Â°C
- æ¹¿åº¦ï¼š${weather.humidity}%
- é£åŠ›ï¼š${weather.wind}`,
          },
        ],
      }
    },
  },
  {
    name: "get_forecast",
    description: "è·å–æŒ‡å®šåŸå¸‚æœªæ¥å‡ å¤©çš„å¤©æ°”é¢„æŠ¥",
    inputSchema: {
      type: "object" as const,
      properties: {
        city: {
          type: "string",
          description: "åŸå¸‚åç§°",
        },
        days: {
          type: "number",
          description: "é¢„æŠ¥å¤©æ•°ï¼ˆ1-7å¤©ï¼‰",
          minimum: 1,
          maximum: 7,
        },
      },
      required: ["city", "days"],
    },
    handler: async (args: { city: string; days: number }) => {
      const forecast = await getForecast(args.city, args.days)
      
      const forecastText = forecast.forecasts
        .map(f => `${f.date}: ${f.condition}, ${f.low}Â°C ~ ${f.high}Â°C`)
        .join("\n")
      
      return {
        content: [
          {
            type: "text" as const,
            text: `${forecast.city}æœªæ¥${args.days}å¤©å¤©æ°”é¢„æŠ¥ï¼š\n${forecastText}`,
          },
        ],
      }
    },
  },
]
```

#### æ­¥éª¤ 4ï¼šå®ç° MCP Server

```typescript
// src/index.ts
import { Server } from "@modelcontextprotocol/sdk/server/index.js"
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js"
import {
  CallToolRequestSchema,
  ListToolsRequestSchema,
} from "@modelcontextprotocol/sdk/types.js"
import { tools } from "./tools"

// åˆ›å»º MCP Server
const server = new Server(
  {
    name: "weather-server",
    version: "1.0.0",
  },
  {
    capabilities: {
      tools: {},  // å£°æ˜æ”¯æŒå·¥å…·èƒ½åŠ›
    },
  }
)

// å¤„ç†å·¥å…·åˆ—è¡¨è¯·æ±‚
server.setRequestHandler(ListToolsRequestSchema, async () => {
  return {
    tools: tools.map(tool => ({
      name: tool.name,
      description: tool.description,
      inputSchema: tool.inputSchema,
    })),
  }
})

// å¤„ç†å·¥å…·è°ƒç”¨è¯·æ±‚
server.setRequestHandler(CallToolRequestSchema, async (request) => {
  const { name, arguments: args } = request.params
  
  // æŸ¥æ‰¾å¯¹åº”çš„å·¥å…·
  const tool = tools.find(t => t.name === name)
  if (!tool) {
    throw new Error(`Unknown tool: ${name}`)
  }
  
  try {
    // æ‰§è¡Œå·¥å…·
    return await tool.handler(args as any)
  } catch (error) {
    // é”™è¯¯å¤„ç†ï¼šè¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    return {
      content: [
        {
          type: "text",
          text: `é”™è¯¯ï¼š${error instanceof Error ? error.message : String(error)}`,
        },
      ],
      isError: true,
    }
  }
})

// å¯åŠ¨ Server
async function main() {
  const transport = new StdioServerTransport()
  await server.connect(transport)
  console.error("Weather MCP Server started")  // è¾“å‡ºåˆ° stderrï¼Œä¸å½±å“ stdio é€šä¿¡
}

main().catch(console.error)
```

#### æ­¥éª¤ 5ï¼šé…ç½® package.json

```json
{
  "name": "weather-mcp-server",
  "version": "1.0.0",
  "type": "module",
  "bin": {
    "weather-mcp": "./dist/index.js"
  },
  "scripts": {
    "build": "bun build src/index.ts --outdir dist --target node",
    "start": "bun run src/index.ts"
  },
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.0.0",
    "zod": "^3.23.0"
  }
}
```

#### æ­¥éª¤ 6ï¼šä¸ OpenCode é›†æˆ

åœ¨ OpenCode é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```json
// opencode.json
{
  "mcp": {
    "weather": {
      "type": "local",
      "command": ["bun", "run", "/path/to/weather-mcp-server/src/index.ts"]
    }
  }
}
```

#### æ­¥éª¤ 7ï¼šæµ‹è¯•

å¯åŠ¨ OpenCode åï¼Œå°è¯•ï¼š

```
ç”¨æˆ·ï¼šåŒ—äº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ

Agentï¼š[è°ƒç”¨ weather_get_weather]
åŒ—äº¬å½“å‰å¤©æ°”ï¼š
- å¤©æ°”ï¼šæ™´
- æ¸©åº¦ï¼š25Â°C
- æ¹¿åº¦ï¼š45%
- é£åŠ›ï¼šä¸œåŒ—é£ 3çº§

ç”¨æˆ·ï¼šä¸Šæµ·æœªæ¥ 3 å¤©å¤©æ°”é¢„æŠ¥

Agentï¼š[è°ƒç”¨ weather_get_forecast]
ä¸Šæµ·æœªæ¥3å¤©å¤©æ°”é¢„æŠ¥ï¼š
2024-01-15: å¤šäº‘, 22Â°C ~ 28Â°C
2024-01-16: æ™´, 20Â°C ~ 27Â°C
2024-01-17: å°é›¨, 18Â°C ~ 24Â°C
```

### æ‰©å±•æ€è€ƒ

1. **æ·»åŠ æ›´å¤šå·¥å…·**ï¼šç©ºæ°”è´¨é‡ã€ç´«å¤–çº¿æŒ‡æ•°ã€ç©¿è¡£å»ºè®®
2. **æ¥å…¥çœŸå® API**ï¼šä½¿ç”¨ OpenWeatherMapã€å’Œé£å¤©æ°”ç­‰
3. **æ·»åŠ  Resources**ï¼šæä¾›åŸå¸‚åˆ—è¡¨ä½œä¸ºèµ„æº
4. **æ·»åŠ  Prompts**ï¼šé¢„å®šä¹‰å¤©æ°”æŸ¥è¯¢æ¨¡æ¿

---


## 9. çŸ¥è¯†è¡¥å……

### ç›¸å…³èµ„æº

| èµ„æº | è¯´æ˜ | é“¾æ¥ |
|------|------|------|
| MCP å®˜æ–¹æ–‡æ¡£ | Model Context Protocol å®Œæ•´è§„èŒƒ | [modelcontextprotocol.io](https://modelcontextprotocol.io) |
| MCP SDK | TypeScript/Python SDK | [GitHub](https://github.com/modelcontextprotocol/sdk) |
| MCP Servers | ç¤¾åŒº MCP Server é›†åˆ | [GitHub](https://github.com/modelcontextprotocol/servers) |
| OpenAI Function Calling | OpenAI å·¥å…·è°ƒç”¨æ–‡æ¡£ | [OpenAI Docs](https://platform.openai.com/docs/guides/function-calling) |
| Anthropic Tool Use | Claude å·¥å…·ä½¿ç”¨æŒ‡å— | [Anthropic Docs](https://docs.anthropic.com/claude/docs/tool-use) |

### è¿›é˜¶é˜…è¯»

1. **å·¥å…·è®¾è®¡æ¨¡å¼**
   - å‘½ä»¤æ¨¡å¼ï¼ˆCommand Patternï¼‰ï¼šå°†æ“ä½œå°è£…ä¸ºå¯¹è±¡
   - ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰ï¼šåŠ¨æ€é€‰æ‹©å·¥å…·å®ç°
   - è£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator Patternï¼‰ï¼šä¸ºå·¥å…·æ·»åŠ æƒé™æ£€æŸ¥ã€æ—¥å¿—ç­‰

2. **å®‰å…¨æœ€ä½³å®è·µ**
   - æœ€å°æƒé™åŸåˆ™ï¼šåªæˆäºˆå¿…è¦çš„æƒé™
   - æ²™ç®±æ‰§è¡Œï¼šåœ¨éš”ç¦»ç¯å¢ƒä¸­æ‰§è¡Œå±é™©æ“ä½œ
   - å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰å·¥å…·è°ƒç”¨

3. **æ€§èƒ½ä¼˜åŒ–**
   - å·¥å…·ç¼“å­˜ï¼šç¼“å­˜é¢‘ç¹è°ƒç”¨çš„ç»“æœ
   - æ‰¹é‡æ“ä½œï¼šåˆå¹¶å¤šä¸ªå°æ“ä½œ
   - å¼‚æ­¥æ‰§è¡Œï¼šå¹¶è¡Œæ‰§è¡Œç‹¬ç«‹çš„å·¥å…·è°ƒç”¨

### MCP ç”Ÿæ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MCP ç”Ÿæ€ç³»ç»Ÿ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å®˜æ–¹ MCP Serversï¼š                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ filesystem    - æ–‡ä»¶ç³»ç»Ÿæ“ä½œ                     â”‚   â”‚
â”‚  â”‚  â€¢ github        - GitHub API é›†æˆ                  â”‚   â”‚
â”‚  â”‚  â€¢ gitlab        - GitLab API é›†æˆ                  â”‚   â”‚
â”‚  â”‚  â€¢ slack         - Slack æ¶ˆæ¯å‘é€                   â”‚   â”‚
â”‚  â”‚  â€¢ postgres      - PostgreSQL æ•°æ®åº“                â”‚   â”‚
â”‚  â”‚  â€¢ sqlite        - SQLite æ•°æ®åº“                    â”‚   â”‚
â”‚  â”‚  â€¢ puppeteer     - æµè§ˆå™¨è‡ªåŠ¨åŒ–                     â”‚   â”‚
â”‚  â”‚  â€¢ brave-search  - Brave æœç´¢å¼•æ“                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ç¤¾åŒº MCP Serversï¼š                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ notion        - Notion é›†æˆ                      â”‚   â”‚
â”‚  â”‚  â€¢ linear        - Linear é¡¹ç›®ç®¡ç†                  â”‚   â”‚
â”‚  â”‚  â€¢ todoist       - Todoist ä»»åŠ¡ç®¡ç†                 â”‚   â”‚
â”‚  â”‚  â€¢ weather       - å¤©æ°”æŸ¥è¯¢                         â”‚   â”‚
â”‚  â”‚  â€¢ ...æ›´å¤šç¤¾åŒºè´¡çŒ®                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æ”¯æŒ MCP çš„å®¢æˆ·ç«¯ï¼š                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ Claude Desktop - Anthropic å®˜æ–¹å®¢æˆ·ç«¯            â”‚   â”‚
â”‚  â”‚  â€¢ OpenCode       - å¼€æº AI ç¼–ç¨‹åŠ©æ‰‹                â”‚   â”‚
â”‚  â”‚  â€¢ Cursor         - AI ä»£ç ç¼–è¾‘å™¨                   â”‚   â”‚
â”‚  â”‚  â€¢ Continue       - VS Code AI æ’ä»¶                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10. æœ¬ç« å°ç»“

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å·¥å…·ç³»ç»Ÿæ ¸å¿ƒæ¦‚å¿µ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å·¥å…·è®¾è®¡åŸåˆ™                                            â”‚
â”‚     â”œâ”€â”€ å•ä¸€èŒè´£ï¼šæ¯ä¸ªå·¥å…·åªåšä¸€ä»¶äº‹                       â”‚
â”‚     â”œâ”€â”€ ç²’åº¦é€‚ä¸­ï¼šå¹³è¡¡çµæ´»æ€§å’Œæ•ˆç‡                         â”‚
â”‚     â”œâ”€â”€ å‚æ•°æ¸…æ™°ï¼šç±»å‹æ˜ç¡®ã€å‘½åè‡ªè§£é‡Š                     â”‚
â”‚     â””â”€â”€ è¿”å›ç»“æ„åŒ–ï¼štitle + output + metadata              â”‚
â”‚                                                             â”‚
â”‚  2. å·¥å…·æè¿°                                                â”‚
â”‚     â”œâ”€â”€ åŠŸèƒ½æ¦‚è¿°ï¼šä¸€å¥è¯è¯´æ˜åšä»€ä¹ˆ                         â”‚
â”‚     â”œâ”€â”€ ä½¿ç”¨åœºæ™¯ï¼šä»€ä¹ˆæ—¶å€™ç”¨                               â”‚
â”‚     â”œâ”€â”€ å‚æ•°è¯´æ˜ï¼šæ¯ä¸ªå‚æ•°çš„å«ä¹‰                           â”‚
â”‚     â”œâ”€â”€ ä½¿ç”¨ç¤ºä¾‹ï¼šå…·ä½“è°ƒç”¨ç¤ºä¾‹                             â”‚
â”‚     â””â”€â”€ æ³¨æ„äº‹é¡¹ï¼šè¾¹ç•Œæ¡ä»¶å’Œé™åˆ¶                           â”‚
â”‚                                                             â”‚
â”‚  3. æƒé™ä¸å®‰å…¨                                              â”‚
â”‚     â”œâ”€â”€ æƒé™æ¨¡å‹ï¼šallow / deny / ask                       â”‚
â”‚     â”œâ”€â”€ è§„åˆ™ä¼˜å…ˆçº§ï¼šåå®šä¹‰çš„è§„åˆ™ä¼˜å…ˆ                       â”‚
â”‚     â”œâ”€â”€ æ•æ„Ÿæ“ä½œä¿æŠ¤ï¼š.env æ–‡ä»¶ã€å¤–éƒ¨ç›®å½•                  â”‚
â”‚     â””â”€â”€ ç”¨æˆ·ç¡®è®¤ï¼šonce / always / reject                   â”‚
â”‚                                                             â”‚
â”‚  4. é”™è¯¯å¤„ç†                                                â”‚
â”‚     â”œâ”€â”€ å‚æ•°é”™è¯¯ï¼šè¿”å›æ¸…æ™°ä¿¡æ¯ï¼Œå¸®åŠ© LLM ä¿®æ­£              â”‚
â”‚     â”œâ”€â”€ æƒé™é”™è¯¯ï¼šåœæ­¢æ‰§è¡Œï¼Œå‘ŠçŸ¥åŸå›                        â”‚
â”‚     â”œâ”€â”€ æ‰§è¡Œé”™è¯¯ï¼šè¿”å›è¯¦æƒ…ï¼Œè®© LLM å†³å®šé‡è¯•                â”‚
â”‚     â””â”€â”€ ç³»ç»Ÿé”™è¯¯ï¼šç»ˆæ­¢æ‰§è¡Œï¼Œè®°å½•æ—¥å¿—                       â”‚
â”‚                                                             â”‚
â”‚  5. MCP åè®®                                                â”‚
â”‚     â”œâ”€â”€ æ ¸å¿ƒèƒ½åŠ›ï¼šTools / Resources / Prompts              â”‚
â”‚     â”œâ”€â”€ ä¼ è¾“æ–¹å¼ï¼šstdioï¼ˆæœ¬åœ°ï¼‰/ HTTPï¼ˆè¿œç¨‹ï¼‰              â”‚
â”‚     â”œâ”€â”€ å·¥å…·å‘ç°ï¼šlistTools / callTool                     â”‚
â”‚     â””â”€â”€ ç”Ÿæ€ä¼˜åŠ¿ï¼šæ ‡å‡†åŒ–ã€å¯å¤ç”¨ã€ç¤¾åŒºå…±äº«                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç å¯¹ç…§è¡¨

| æ¦‚å¿µ | OpenCode å®ç° | æ–‡ä»¶ä½ç½® |
|------|---------------|----------|
| å·¥å…·å®šä¹‰æ¡†æ¶ | `Tool.define()` | `src/tool/tool.ts` |
| æ–‡ä»¶è¯»å–å·¥å…· | `ReadTool` | `src/tool/read.ts` |
| å‘½ä»¤æ‰§è¡Œå·¥å…· | `BashTool` | `src/tool/bash.ts` |
| æƒé™ç³»ç»Ÿ | `PermissionNext` | `src/permission/next.ts` |
| MCP å®¢æˆ·ç«¯ | `MCP` namespace | `src/mcp/index.ts` |

### æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šå·¥å…·ç³»ç»Ÿåœ¨ Agent ä¸­çš„ä½œç”¨
- [ ] è®¾è®¡ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™çš„å·¥å…·
- [ ] ç¼–å†™æ¸…æ™°çš„å·¥å…·æè¿°å’Œå‚æ•°å®šä¹‰
- [ ] å®ç°åŸºäºè§„åˆ™çš„æƒé™æ§åˆ¶ç³»ç»Ÿ
- [ ] å¤„ç†å·¥å…·æ‰§è¡Œä¸­çš„å„ç±»é”™è¯¯
- [ ] ç†è§£ MCP åè®®çš„æ ¸å¿ƒæ¦‚å¿µ
- [ ] æ„å»ºç®€å•çš„ MCP Server
- [ ] å°† MCP Server é›†æˆåˆ° OpenCode

---

## å¯¼èˆª

- [ä¸Šä¸€ç« ï¼šMulti-Agent ç³»ç»Ÿ](./02-multi-agent.md)
- [ä¸‹ä¸€ç« ï¼šä»£ç æ™ºèƒ½](./04-code-intelligence.md)
- [è¿”å›ç›®å½•](./00-introduction.md)
