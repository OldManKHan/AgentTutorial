# ç¬¬å…­ç« ï¼šå¯è§‚æµ‹æ€§ä¸è°ƒè¯•

> ğŸ¯ æœ¬ç« ç›®æ ‡ï¼šç†è§£ Agent ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§è®¾è®¡ï¼ŒæŒæ¡é“¾è·¯è¿½è¸ªã€æ—¥å¿—è®¾è®¡å’Œäº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå­¦ä¼šæ„å»º Agent ç›‘æ§ç³»ç»Ÿ

## ä¸ºä»€ä¹ˆéœ€è¦å¯è§‚æµ‹æ€§ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ éƒ¨ç½²äº†ä¸€ä¸ª Agent åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œç”¨æˆ·åé¦ˆ"Agent å›ç­”å¾ˆæ…¢"æˆ–"Agent ç»™å‡ºäº†é”™è¯¯çš„ç­”æ¡ˆ"ã€‚ä½ è¯¥å¦‚ä½•æ’æŸ¥é—®é¢˜ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent çš„é»‘ç›’é—®é¢˜                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä¼ ç»Ÿç¨‹åºè°ƒè¯•ï¼š                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¾“å…¥ â”€â”€â–º ç¡®å®šæ€§é€»è¾‘ â”€â”€â–º è¾“å‡º                       â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â€¢ ç›¸åŒè¾“å…¥ = ç›¸åŒè¾“å‡º                              â”‚   â”‚
â”‚  â”‚  â€¢ å¯ä»¥è®¾æ–­ç‚¹ã€å•æ­¥è°ƒè¯•                             â”‚   â”‚
â”‚  â”‚  â€¢ é”™è¯¯å¯å¤ç°                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  Agent è°ƒè¯•ï¼š                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¾“å…¥ â”€â”€â–º LLM (é»‘ç›’) â”€â”€â–º å·¥å…·è°ƒç”¨ â”€â”€â–º LLM â”€â”€â–º è¾“å‡º  â”‚   â”‚
â”‚  â”‚            â”‚              â”‚           â”‚             â”‚   â”‚
â”‚  â”‚            â–¼              â–¼           â–¼             â”‚   â”‚
â”‚  â”‚         ä¸ç¡®å®šæ€§       å¯èƒ½å¤±è´¥    ä¸ç¡®å®šæ€§         â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  â€¢ ç›¸åŒè¾“å…¥ â‰  ç›¸åŒè¾“å‡ºï¼ˆLLM æœ‰éšæœºæ€§ï¼‰              â”‚   â”‚
â”‚  â”‚  â€¢ æ— æ³•è®¾æ–­ç‚¹ï¼ˆLLM æ˜¯ API è°ƒç”¨ï¼‰                    â”‚   â”‚
â”‚  â”‚  â€¢ é”™è¯¯éš¾ä»¥å¤ç°                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¯è§‚æµ‹æ€§è§£å†³çš„æ ¸å¿ƒé—®é¢˜

| é—®é¢˜ | æ²¡æœ‰å¯è§‚æµ‹æ€§ | æœ‰å¯è§‚æµ‹æ€§ |
|------|--------------|------------|
| æ€§èƒ½é—®é¢˜ | "ä¸çŸ¥é“æ…¢åœ¨å“ªé‡Œ" | ç²¾ç¡®å®šä½åˆ°å…·ä½“æ­¥éª¤ |
| é”™è¯¯æ’æŸ¥ | "ä¸çŸ¥é“ä¸ºä»€ä¹ˆå‡ºé”™" | å®Œæ•´çš„é”™è¯¯é“¾è·¯å’Œä¸Šä¸‹æ–‡ |
| æˆæœ¬æ§åˆ¶ | "ä¸çŸ¥é“é’±èŠ±åœ¨å“ªé‡Œ" | Token ä½¿ç”¨æ˜ç»†å’Œæˆæœ¬åˆ†æ |
| è¡Œä¸ºç†è§£ | "ä¸çŸ¥é“ Agent åœ¨æƒ³ä»€ä¹ˆ" | å®Œæ•´çš„å†³ç­–è¿‡ç¨‹è®°å½• |
| è´¨é‡æ”¹è¿› | "ä¸çŸ¥é“å¦‚ä½•ä¼˜åŒ–" | æ•°æ®é©±åŠ¨çš„æ”¹è¿›æ–¹å‘ |


### å¯è§‚æµ‹æ€§çš„ä¸‰å¤§æ”¯æŸ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚     Logs        â”‚  â”‚    Metrics      â”‚  â”‚   Traces    â”‚ â”‚
â”‚  â”‚     æ—¥å¿—        â”‚  â”‚     æŒ‡æ ‡        â”‚  â”‚    é“¾è·¯     â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚             â”‚ â”‚
â”‚  â”‚  â€¢ ç¦»æ•£äº‹ä»¶     â”‚  â”‚  â€¢ èšåˆæ•°æ®     â”‚  â”‚  â€¢ è¯·æ±‚æµç¨‹ â”‚ â”‚
â”‚  â”‚  â€¢ è¯¦ç»†ä¸Šä¸‹æ–‡   â”‚  â”‚  â€¢ æ—¶é—´åºåˆ—     â”‚  â”‚  â€¢ å› æœå…³ç³» â”‚ â”‚
â”‚  â”‚  â€¢ è°ƒè¯•æ’æŸ¥     â”‚  â”‚  â€¢ è¶‹åŠ¿åˆ†æ     â”‚  â”‚  â€¢ æ€§èƒ½åˆ†æ â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚             â”‚ â”‚
â”‚  â”‚  ç¤ºä¾‹ï¼š         â”‚  â”‚  ç¤ºä¾‹ï¼š         â”‚  â”‚  ç¤ºä¾‹ï¼š     â”‚ â”‚
â”‚  â”‚  "å·¥å…·è°ƒç”¨å¤±è´¥  â”‚  â”‚  "å¹³å‡å“åº”æ—¶é—´  â”‚  â”‚  "è¯·æ±‚ A    â”‚ â”‚
â”‚  â”‚   é”™è¯¯: è¶…æ—¶"   â”‚  â”‚   2.3 ç§’"       â”‚  â”‚   â†’ LLM     â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚   â†’ å·¥å…·    â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚   â†’ LLM"    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  ä¸‰è€…å…³ç³»ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Metrics å‘ç°é—®é¢˜ â†’ Traces å®šä½é—®é¢˜ â†’ Logs åˆ†æç»†èŠ‚ â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  "å“åº”æ—¶é—´ä¸Šå‡" â†’ "å·¥å…·è°ƒç”¨è€—æ—¶é•¿" â†’ "æ•°æ®åº“è¿æ¥è¶…æ—¶"â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. æ‰§è¡Œé“¾è·¯è¿½è¸ª

é“¾è·¯è¿½è¸ªï¼ˆTracingï¼‰æ˜¯ç†è§£ Agent è¡Œä¸ºçš„å…³é”®ã€‚å®ƒè®°å½•äº†ä¸€ä¸ªè¯·æ±‚ä»å¼€å§‹åˆ°ç»“æŸçš„å®Œæ•´è·¯å¾„ã€‚

### 1.1 Trace å’Œ Span æ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Trace å’Œ Span                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Traceï¼ˆè¿½è¸ªï¼‰ï¼šä¸€ä¸ªå®Œæ•´è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸ                      â”‚
â”‚  Spanï¼ˆè·¨åº¦ï¼‰ï¼šTrace ä¸­çš„ä¸€ä¸ªæ“ä½œå•å…ƒ                       â”‚
â”‚                                                             â”‚
â”‚  ç¤ºä¾‹ï¼šç”¨æˆ·é—® "å¸®æˆ‘è¯»å– config.json æ–‡ä»¶"                   â”‚
â”‚                                                             â”‚
â”‚  Trace: user-request-12345                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  Span: agent-loop (æ ¹ Span)                         â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å¼€å§‹æ—¶é—´: 10:00:00.000                         â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ç»“æŸæ—¶é—´: 10:00:03.500                         â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ€»è€—æ—¶: 3.5s                                   â”‚   â”‚
â”‚  â”‚      â”‚                                              â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ Span: llm-call-1                           â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€â”€ æ¨¡å‹: claude-3-5-sonnet                â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€â”€ è¾“å…¥ tokens: 1200                      â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€â”€ è¾“å‡º tokens: 150                       â”‚   â”‚
â”‚  â”‚      â”‚   â””â”€â”€ è€—æ—¶: 1.2s                             â”‚   â”‚
â”‚  â”‚      â”‚                                              â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ Span: tool-call (read_file)                â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€â”€ å·¥å…·: read_file                        â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€â”€ å‚æ•°: {path: "config.json"}            â”‚   â”‚
â”‚  â”‚      â”‚   â”œâ”€â”€ ç»“æœ: æˆåŠŸ (2KB)                       â”‚   â”‚
â”‚  â”‚      â”‚   â””â”€â”€ è€—æ—¶: 0.1s                             â”‚   â”‚
â”‚  â”‚      â”‚                                              â”‚   â”‚
â”‚  â”‚      â””â”€â”€ Span: llm-call-2                           â”‚   â”‚
â”‚  â”‚          â”œâ”€â”€ æ¨¡å‹: claude-3-5-sonnet                â”‚   â”‚
â”‚  â”‚          â”œâ”€â”€ è¾“å…¥ tokens: 1800                      â”‚   â”‚
â”‚  â”‚          â”œâ”€â”€ è¾“å‡º tokens: 300                       â”‚   â”‚
â”‚  â”‚          â””â”€â”€ è€—æ—¶: 2.0s                             â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 1.2 ä¸Šä¸‹æ–‡ä¼ æ’­

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œéœ€è¦åœ¨ä¸åŒç»„ä»¶é—´ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡ï¼š

```typescript
// è¿½è¸ªä¸Šä¸‹æ–‡å®šä¹‰
interface TraceContext {
  traceId: string      // æ•´ä¸ªè¯·æ±‚çš„å”¯ä¸€æ ‡è¯†
  spanId: string       // å½“å‰æ“ä½œçš„å”¯ä¸€æ ‡è¯†
  parentSpanId?: string // çˆ¶æ“ä½œçš„æ ‡è¯†
  baggage?: Record<string, string> // é™„åŠ ä¿¡æ¯
}

// åˆ›å»ºæ–°çš„ Trace
function startTrace(name: string): TraceContext {
  return {
    traceId: generateId(),  // ç”Ÿæˆå”¯ä¸€ ID
    spanId: generateId(),
    // æ²¡æœ‰ parentSpanIdï¼Œè¿™æ˜¯æ ¹ Span
  }
}

// åˆ›å»ºå­ Span
function startSpan(parent: TraceContext, name: string): TraceContext {
  return {
    traceId: parent.traceId,  // ç»§æ‰¿ traceId
    spanId: generateId(),      // æ–°çš„ spanId
    parentSpanId: parent.spanId, // è®°å½•çˆ¶ Span
  }
}
```

### 1.3 Agent é“¾è·¯è¿½è¸ªè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Agent é“¾è·¯è¿½è¸ªæ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ç”¨æˆ·è¯·æ±‚                                                   â”‚
â”‚      â”‚                                                      â”‚
â”‚      â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Trace å¼€å§‹                                         â”‚   â”‚
â”‚  â”‚  traceId: "abc123"                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                      â”‚
â”‚      â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Agent Loop Span                                    â”‚   â”‚
â”‚  â”‚  spanId: "span-1", parentId: null                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  è¿­ä»£ 1                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€ LLM Span (spanId: "span-2")            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚   â””â”€â”€ è®°å½•: æ¨¡å‹ã€tokensã€å»¶è¿Ÿ           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€ Tool Span (spanId: "span-3")           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      â””â”€â”€ è®°å½•: å·¥å…·åã€å‚æ•°ã€ç»“æœ           â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  è¿­ä»£ 2                                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€ LLM Span (spanId: "span-4")            â”‚   â”‚   â”‚
â”‚  â”‚  â”‚      â””â”€â”€ è®°å½•: æœ€ç»ˆå“åº”                     â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                      â”‚
â”‚      â–¼                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Trace ç»“æŸ                                         â”‚   â”‚
â”‚  â”‚  æ€»è€—æ—¶ã€æ€» tokensã€å·¥å…·è°ƒç”¨æ¬¡æ•°                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 Span å±æ€§è®¾è®¡

ä¸åŒç±»å‹çš„ Span éœ€è¦è®°å½•ä¸åŒçš„å±æ€§ï¼š

| Span ç±»å‹ | å…³é”®å±æ€§ | ç”¨é€” |
|-----------|----------|------|
| Agent Loop | è¿­ä»£æ¬¡æ•°ã€æ€»è€—æ—¶ã€æœ€ç»ˆçŠ¶æ€ | æ•´ä½“æ€§èƒ½åˆ†æ |
| LLM Call | æ¨¡å‹åã€è¾“å…¥/è¾“å‡º tokensã€å»¶è¿Ÿã€æ¸©åº¦ | æˆæœ¬åˆ†æã€æ€§èƒ½ä¼˜åŒ– |
| Tool Call | å·¥å…·åã€å‚æ•°ã€ç»“æœã€é”™è¯¯ä¿¡æ¯ | å·¥å…·ä½¿ç”¨åˆ†æ |
| Memory Search | æŸ¥è¯¢ã€ç»“æœæ•°é‡ã€ç›¸ä¼¼åº¦åˆ†æ•° | æ£€ç´¢è´¨é‡åˆ†æ |
| Context Compaction | å‹ç¼©å‰/å tokensã€å‹ç¼©ç‡ | ä¸Šä¸‹æ–‡ç®¡ç†åˆ†æ |

---

## 2. Token ä½¿ç”¨ç›‘æ§

Token æ˜¯ Agent çš„"ç‡ƒæ–™"ï¼Œç›‘æ§ Token ä½¿ç”¨å¯¹æˆæœ¬æ§åˆ¶è‡³å…³é‡è¦ã€‚

### 2.1 Token ç»Ÿè®¡ç»´åº¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Token ç»Ÿè®¡ç»´åº¦                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æŒ‰è¯·æ±‚ç»Ÿè®¡ï¼š                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¯·æ±‚ ID: req-12345                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ è¾“å…¥ tokens: 5,200                             â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ ç³»ç»Ÿæç¤º: 1,500                            â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ ç”¨æˆ·æ¶ˆæ¯: 200                              â”‚   â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ å†å²ä¸Šä¸‹æ–‡: 2,500                          â”‚   â”‚
â”‚  â”‚  â”‚   â””â”€â”€ å·¥å…·ç»“æœ: 1,000                            â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ è¾“å‡º tokens: 800                               â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ€»æˆæœ¬: $0.018                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æŒ‰æ—¶é—´ç»Ÿè®¡ï¼š                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ—¶é—´èŒƒå›´: 2024-01-15                               â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ€»è¯·æ±‚æ•°: 1,234                                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ€»è¾“å…¥ tokens: 2,500,000                       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æ€»è¾“å‡º tokens: 450,000                         â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å¹³å‡æ¯è¯·æ±‚: 2,390 tokens                       â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ€»æˆæœ¬: $45.60                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æŒ‰ç”¨æˆ·/é¡¹ç›®ç»Ÿè®¡ï¼š                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç”¨æˆ·: user-abc                                     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æœ¬æœˆä½¿ç”¨: 150,000 tokens                       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ é…é¢: 500,000 tokens                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å‰©ä½™: 350,000 tokens (70%)                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 2.2 æˆæœ¬è¿½è¸ªå®ç°

```typescript
// Token ä½¿ç”¨è®°å½•
interface TokenUsage {
  requestId: string
  timestamp: Date
  model: string
  inputTokens: number
  outputTokens: number
  cachedTokens?: number  // Prompt Caching å‘½ä¸­çš„ tokens
}

// æˆæœ¬è®¡ç®—ï¼ˆä»¥ Claude 3.5 Sonnet ä¸ºä¾‹ï¼‰
const PRICING = {
  "claude-3-5-sonnet": {
    input: 3.00 / 1_000_000,   // $3 per 1M input tokens
    output: 15.00 / 1_000_000, // $15 per 1M output tokens
    cached: 0.30 / 1_000_000,  // $0.30 per 1M cached tokens
  },
  "gpt-4o": {
    input: 2.50 / 1_000_000,
    output: 10.00 / 1_000_000,
  }
}

function calculateCost(usage: TokenUsage): number {
  const pricing = PRICING[usage.model]
  if (!pricing) return 0
  
  // è®¡ç®—æˆæœ¬
  const inputCost = usage.inputTokens * pricing.input
  const outputCost = usage.outputTokens * pricing.output
  const cachedCost = (usage.cachedTokens ?? 0) * (pricing.cached ?? pricing.input)
  
  return inputCost + outputCost + cachedCost
}
```

### 2.3 é¢„ç®—æ§åˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é¢„ç®—æ§åˆ¶ç­–ç•¥                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å±‚çº§é™åˆ¶ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  å…¨å±€é™åˆ¶                                           â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ¯æ—¥é¢„ç®—: $100                                 â”‚   â”‚
â”‚  â”‚      â”‚                                              â”‚   â”‚
â”‚  â”‚      â”œâ”€â”€ ç”¨æˆ·é™åˆ¶                                   â”‚   â”‚
â”‚  â”‚      â”‚   â””â”€â”€ æ¯ç”¨æˆ·æ¯æ—¥: $10                        â”‚   â”‚
â”‚  â”‚      â”‚       â”‚                                      â”‚   â”‚
â”‚  â”‚      â”‚       â””â”€â”€ è¯·æ±‚é™åˆ¶                           â”‚   â”‚
â”‚  â”‚      â”‚           â””â”€â”€ å•æ¬¡è¯·æ±‚: $1                   â”‚   â”‚
â”‚  â”‚      â”‚                                              â”‚   â”‚
â”‚  â”‚      â””â”€â”€ é¡¹ç›®é™åˆ¶                                   â”‚   â”‚
â”‚  â”‚          â””â”€â”€ æ¯é¡¹ç›®æ¯æ—¥: $20                        â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  è¶…é™å¤„ç†ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. è­¦å‘Šé˜ˆå€¼ (80%)ï¼šå‘é€é€šçŸ¥                        â”‚   â”‚
â”‚  â”‚  2. è½¯é™åˆ¶ (100%)ï¼šé™çº§åˆ°æ›´ä¾¿å®œçš„æ¨¡å‹               â”‚   â”‚
â”‚  â”‚  3. ç¡¬é™åˆ¶ (120%)ï¼šæ‹’ç»è¯·æ±‚                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å·¥å…·è°ƒç”¨åˆ†æ

å·¥å…·æ˜¯ Agent ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’çš„æ¡¥æ¢ï¼Œåˆ†æå·¥å…·è°ƒç”¨æœ‰åŠ©äºä¼˜åŒ– Agent è¡Œä¸ºã€‚

### 3.1 å·¥å…·è°ƒç”¨æŒ‡æ ‡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å·¥å…·è°ƒç”¨æŒ‡æ ‡                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  åŸºç¡€æŒ‡æ ‡ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å·¥å…·: read_file                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ è°ƒç”¨æ¬¡æ•°: 1,234                                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æˆåŠŸç‡: 98.5%                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å¹³å‡å»¶è¿Ÿ: 120ms                                â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ P95 å»¶è¿Ÿ: 350ms                                â”‚   â”‚
â”‚  â”‚  â””â”€â”€ P99 å»¶è¿Ÿ: 800ms                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  é”™è¯¯åˆ†æï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å·¥å…·: bash                                         â”‚   â”‚
â”‚  â”‚  é”™è¯¯åˆ†å¸ƒ:                                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ æƒé™æ‹’ç»: 45%                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å‘½ä»¤è¶…æ—¶: 30%                                  â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ å‘½ä»¤ä¸å­˜åœ¨: 15%                                â”‚   â”‚
â”‚  â”‚  â””â”€â”€ å…¶ä»–: 10%                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä½¿ç”¨æ¨¡å¼ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å¸¸è§å·¥å…·è°ƒç”¨åºåˆ—:                                  â”‚   â”‚
â”‚  â”‚  1. read_file â†’ write_file (ç¼–è¾‘æ–‡ä»¶)    35%        â”‚   â”‚
â”‚  â”‚  2. list_dir â†’ read_file (æµè§ˆä»£ç )      25%        â”‚   â”‚
â”‚  â”‚  3. bash â†’ read_file (æ‰§è¡Œåæ£€æŸ¥)        20%        â”‚   â”‚
â”‚  â”‚  4. search â†’ read_file (æœç´¢åé˜…è¯»)      15%        â”‚   â”‚
â”‚  â”‚  5. å…¶ä»–                                  5%        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å·¥å…·è°ƒç”¨è®°å½•

```typescript
// å·¥å…·è°ƒç”¨è®°å½•
interface ToolCallRecord {
  id: string
  traceId: string
  spanId: string
  tool: string
  parameters: Record<string, any>
  startTime: Date
  endTime: Date
  duration: number  // æ¯«ç§’
  status: "success" | "error" | "timeout"
  result?: any
  error?: {
    type: string
    message: string
    stack?: string
  }
}

// å·¥å…·è°ƒç”¨åˆ†æ
function analyzeToolCalls(records: ToolCallRecord[]) {
  const byTool = new Map<string, ToolCallRecord[]>()
  
  // æŒ‰å·¥å…·åˆ†ç»„
  for (const record of records) {
    const list = byTool.get(record.tool) ?? []
    list.push(record)
    byTool.set(record.tool, list)
  }
  
  // è®¡ç®—æ¯ä¸ªå·¥å…·çš„æŒ‡æ ‡
  return Array.from(byTool.entries()).map(([tool, calls]) => {
    const successful = calls.filter(c => c.status === "success")
    const durations = calls.map(c => c.duration).sort((a, b) => a - b)
    
    return {
      tool,
      totalCalls: calls.length,
      successRate: successful.length / calls.length,
      avgDuration: durations.reduce((a, b) => a + b, 0) / durations.length,
      p95Duration: durations[Math.floor(durations.length * 0.95)],
      p99Duration: durations[Math.floor(durations.length * 0.99)],
    }
  })
}
```


---

## 4. é”™è¯¯è¯Šæ–­ä¸é‡è¯•ç­–ç•¥

Agent ç³»ç»Ÿæ¶‰åŠå¤šä¸ªå¤–éƒ¨ä¾èµ–ï¼ˆLLM APIã€å·¥å…·æ‰§è¡Œï¼‰ï¼Œé”™è¯¯å¤„ç†è‡³å…³é‡è¦ã€‚

### 4.1 é”™è¯¯åˆ†ç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent é”™è¯¯åˆ†ç±»                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å¯é‡è¯•é”™è¯¯ï¼ˆRetryableï¼‰ï¼š                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ é€Ÿç‡é™åˆ¶ (Rate Limit)                            â”‚   â”‚
â”‚  â”‚    â””â”€â”€ ç­‰å¾…åé‡è¯•                                   â”‚   â”‚
â”‚  â”‚  â€¢ æœåŠ¡è¿‡è½½ (Overloaded)                            â”‚   â”‚
â”‚  â”‚    â””â”€â”€ æŒ‡æ•°é€€é¿é‡è¯•                                 â”‚   â”‚
â”‚  â”‚  â€¢ ç½‘ç»œè¶…æ—¶ (Timeout)                               â”‚   â”‚
â”‚  â”‚    â””â”€â”€ ç«‹å³é‡è¯•æˆ–çŸ­æš‚ç­‰å¾…                           â”‚   â”‚
â”‚  â”‚  â€¢ ä¸´æ—¶æœåŠ¡é”™è¯¯ (5xx)                               â”‚   â”‚
â”‚  â”‚    â””â”€â”€ æŒ‡æ•°é€€é¿é‡è¯•                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä¸å¯é‡è¯•é”™è¯¯ï¼ˆNon-retryableï¼‰ï¼š                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ è®¤è¯å¤±è´¥ (401)                                   â”‚   â”‚
â”‚  â”‚    â””â”€â”€ éœ€è¦ç”¨æˆ·ä»‹å…¥                                 â”‚   â”‚
â”‚  â”‚  â€¢ æƒé™ä¸è¶³ (403)                                   â”‚   â”‚
â”‚  â”‚    â””â”€â”€ éœ€è¦é…ç½®ä¿®æ”¹                                 â”‚   â”‚
â”‚  â”‚  â€¢ è¯·æ±‚æ— æ•ˆ (400)                                   â”‚   â”‚
â”‚  â”‚    â””â”€â”€ éœ€è¦ä¿®å¤è¯·æ±‚                                 â”‚   â”‚
â”‚  â”‚  â€¢ èµ„æºä¸å­˜åœ¨ (404)                                 â”‚   â”‚
â”‚  â”‚    â””â”€â”€ éœ€è¦æ£€æŸ¥å‚æ•°                                 â”‚   â”‚
â”‚  â”‚  â€¢ å†…å®¹è¿è§„ (Content Policy)                        â”‚   â”‚
â”‚  â”‚    â””â”€â”€ éœ€è¦ä¿®æ”¹å†…å®¹                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  éœ€è¦é™çº§çš„é”™è¯¯ï¼š                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ ä¸Šä¸‹æ–‡è¿‡é•¿                                       â”‚   â”‚
â”‚  â”‚    â””â”€â”€ å‹ç¼©ä¸Šä¸‹æ–‡åé‡è¯•                             â”‚   â”‚
â”‚  â”‚  â€¢ æ¨¡å‹ä¸å¯ç”¨                                       â”‚   â”‚
â”‚  â”‚    â””â”€â”€ åˆ‡æ¢åˆ°å¤‡ç”¨æ¨¡å‹                               â”‚   â”‚
â”‚  â”‚  â€¢ é…é¢è€—å°½                                         â”‚   â”‚
â”‚  â”‚    â””â”€â”€ åˆ‡æ¢åˆ°æ›´ä¾¿å®œçš„æ¨¡å‹                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æŒ‡æ•°é€€é¿ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æŒ‡æ•°é€€é¿ç­–ç•¥                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  åŸºæœ¬å…¬å¼ï¼šdelay = min(initialDelay Ã— 2^attempt, maxDelay)  â”‚
â”‚                                                             â”‚
â”‚  ç¤ºä¾‹ï¼ˆinitialDelay=2s, maxDelay=30sï¼‰ï¼š                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  å°è¯• 1: å¤±è´¥ â†’ ç­‰å¾… 2s                             â”‚   â”‚
â”‚  â”‚  å°è¯• 2: å¤±è´¥ â†’ ç­‰å¾… 4s                             â”‚   â”‚
â”‚  â”‚  å°è¯• 3: å¤±è´¥ â†’ ç­‰å¾… 8s                             â”‚   â”‚
â”‚  â”‚  å°è¯• 4: å¤±è´¥ â†’ ç­‰å¾… 16s                            â”‚   â”‚
â”‚  â”‚  å°è¯• 5: å¤±è´¥ â†’ ç­‰å¾… 30s (è¾¾åˆ°ä¸Šé™)                 â”‚   â”‚
â”‚  â”‚  å°è¯• 6: å¤±è´¥ â†’ ç­‰å¾… 30s                            â”‚   â”‚
â”‚  â”‚  ...                                                â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  å»¶è¿Ÿ                                               â”‚   â”‚
â”‚  â”‚  30s â”¤                    â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—               â”‚   â”‚
â”‚  â”‚      â”‚                 â—                            â”‚   â”‚
â”‚  â”‚  16s â”¤              â—                               â”‚   â”‚
â”‚  â”‚      â”‚           â—                                  â”‚   â”‚
â”‚  â”‚   8s â”¤        â—                                     â”‚   â”‚
â”‚  â”‚      â”‚     â—                                        â”‚   â”‚
â”‚  â”‚   4s â”¤  â—                                           â”‚   â”‚
â”‚  â”‚   2s â”¤â—                                             â”‚   â”‚
â”‚  â”‚      â””â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â–º å°è¯•æ¬¡æ•°               â”‚   â”‚
â”‚  â”‚         1  2  3  4  5  6                            â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  å¸¦æŠ–åŠ¨ï¼ˆJitterï¼‰ï¼šé¿å…å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶é‡è¯•                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  delay = baseDelay Ã— (0.5 + random() Ã— 0.5)         â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  ä¾‹å¦‚ baseDelay=8s:                                 â”‚   â”‚
â”‚  â”‚  å®é™…å»¶è¿ŸèŒƒå›´: 4s ~ 8s                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 é‡è¯•ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|----------|------|------|
| ç«‹å³é‡è¯• | å¶å‘ç½‘ç»œæŠ–åŠ¨ | å¿«é€Ÿæ¢å¤ | å¯èƒ½åŠ é‡æœåŠ¡å‹åŠ› |
| å›ºå®šé—´éš” | ç®€å•åœºæ™¯ | å®ç°ç®€å• | ä¸å¤Ÿçµæ´» |
| æŒ‡æ•°é€€é¿ | æœåŠ¡è¿‡è½½ | ç»™æœåŠ¡æ¢å¤æ—¶é—´ | æ¢å¤è¾ƒæ…¢ |
| æŒ‡æ•°é€€é¿+æŠ–åŠ¨ | é«˜å¹¶å‘åœºæ™¯ | é¿å…æƒŠç¾¤æ•ˆåº” | å®ç°ç¨å¤æ‚ |
| åŸºäºå“åº”å¤´ | API é™æµ | ç²¾ç¡®æ§åˆ¶ | ä¾èµ–æœåŠ¡ç«¯æ”¯æŒ |


---

## 5. æ—¥å¿—ä¸æŒ‡æ ‡è®¾è®¡

è‰¯å¥½çš„æ—¥å¿—å’ŒæŒ‡æ ‡è®¾è®¡æ˜¯å¯è§‚æµ‹æ€§çš„åŸºç¡€ã€‚

### 5.1 ç»“æ„åŒ–æ—¥å¿—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç»“æ„åŒ–æ—¥å¿—è®¾è®¡                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  éç»“æ„åŒ–æ—¥å¿—ï¼ˆä¸æ¨èï¼‰ï¼š                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  [2024-01-15 10:00:00] Tool call failed: read_file  â”‚   â”‚
â”‚  â”‚  Error: File not found - config.json                â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  é—®é¢˜ï¼š                                             â”‚   â”‚
â”‚  â”‚  â€¢ éš¾ä»¥è§£æå’ŒæŸ¥è¯¢                                   â”‚   â”‚
â”‚  â”‚  â€¢ æ ¼å¼ä¸ä¸€è‡´                                       â”‚   â”‚
â”‚  â”‚  â€¢ ç¼ºå°‘ä¸Šä¸‹æ–‡ä¿¡æ¯                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ç»“æ„åŒ–æ—¥å¿—ï¼ˆæ¨èï¼‰ï¼š                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  {                                                  â”‚   â”‚
â”‚  â”‚    "timestamp": "2024-01-15T10:00:00.123Z",         â”‚   â”‚
â”‚  â”‚    "level": "ERROR",                                â”‚   â”‚
â”‚  â”‚    "service": "tool",                               â”‚   â”‚
â”‚  â”‚    "message": "Tool call failed",                   â”‚   â”‚
â”‚  â”‚    "traceId": "abc123",                             â”‚   â”‚
â”‚  â”‚    "spanId": "span-456",                            â”‚   â”‚
â”‚  â”‚    "tool": "read_file",                             â”‚   â”‚
â”‚  â”‚    "parameters": {"path": "config.json"},           â”‚   â”‚
â”‚  â”‚    "error": {                                       â”‚   â”‚
â”‚  â”‚      "type": "FileNotFound",                        â”‚   â”‚
â”‚  â”‚      "message": "File not found"                    â”‚   â”‚
â”‚  â”‚    },                                               â”‚   â”‚
â”‚  â”‚    "duration": 45                                   â”‚   â”‚
â”‚  â”‚  }                                                  â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  ä¼˜ç‚¹ï¼š                                             â”‚   â”‚
â”‚  â”‚  â€¢ æ˜“äºè§£æå’ŒæŸ¥è¯¢                                   â”‚   â”‚
â”‚  â”‚  â€¢ æ ¼å¼ä¸€è‡´                                         â”‚   â”‚
â”‚  â”‚  â€¢ åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ—¥å¿—çº§åˆ«ä½¿ç”¨

| çº§åˆ« | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| DEBUG | è¯¦ç»†è°ƒè¯•ä¿¡æ¯ | å·¥å…·å‚æ•°ã€LLM å®Œæ•´å“åº” |
| INFO | æ­£å¸¸æ“ä½œè®°å½• | è¯·æ±‚å¼€å§‹/ç»“æŸã€å·¥å…·è°ƒç”¨æˆåŠŸ |
| WARN | æ½œåœ¨é—®é¢˜ | é‡è¯•å‘ç”Ÿã€æ¥è¿‘é…é¢é™åˆ¶ |
| ERROR | é”™è¯¯ä½†å¯æ¢å¤ | å·¥å…·è°ƒç”¨å¤±è´¥ã€API é”™è¯¯ |
| FATAL | ä¸¥é‡é”™è¯¯ | ç³»ç»Ÿæ— æ³•å¯åŠ¨ã€å…³é”®é…ç½®ç¼ºå¤± |

### 5.3 å…³é”®æŒ‡æ ‡è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent å…³é”®æŒ‡æ ‡                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ€§èƒ½æŒ‡æ ‡ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ agent_request_duration_seconds                   â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è¯·æ±‚æ€»è€—æ—¶ï¼ˆç›´æ–¹å›¾ï¼‰                         â”‚   â”‚
â”‚  â”‚  â€¢ agent_llm_call_duration_seconds                  â”‚   â”‚
â”‚  â”‚    â””â”€â”€ LLM è°ƒç”¨è€—æ—¶ï¼ˆç›´æ–¹å›¾ï¼‰                       â”‚   â”‚
â”‚  â”‚  â€¢ agent_tool_call_duration_seconds                 â”‚   â”‚
â”‚  â”‚    â””â”€â”€ å·¥å…·è°ƒç”¨è€—æ—¶ï¼ˆæŒ‰å·¥å…·åæ ‡ç­¾ï¼‰                 â”‚   â”‚
â”‚  â”‚  â€¢ agent_loop_iterations_total                      â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Agent Loop è¿­ä»£æ¬¡æ•°ï¼ˆç›´æ–¹å›¾ï¼‰                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  æˆæœ¬æŒ‡æ ‡ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ agent_tokens_total                               â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Token ä½¿ç”¨é‡ï¼ˆæŒ‰ç±»å‹ï¼šinput/output/cachedï¼‰  â”‚   â”‚
â”‚  â”‚  â€¢ agent_cost_dollars_total                         â”‚   â”‚
â”‚  â”‚    â””â”€â”€ ç´¯è®¡æˆæœ¬ï¼ˆæŒ‰æ¨¡å‹æ ‡ç­¾ï¼‰                       â”‚   â”‚
â”‚  â”‚  â€¢ agent_budget_remaining_ratio                     â”‚   â”‚
â”‚  â”‚    â””â”€â”€ å‰©ä½™é¢„ç®—æ¯”ä¾‹                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  å¯é æ€§æŒ‡æ ‡ï¼š                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ agent_requests_total                             â”‚   â”‚
â”‚  â”‚    â””â”€â”€ è¯·æ±‚æ€»æ•°ï¼ˆæŒ‰çŠ¶æ€ï¼šsuccess/errorï¼‰            â”‚   â”‚
â”‚  â”‚  â€¢ agent_tool_calls_total                           â”‚   â”‚
â”‚  â”‚    â””â”€â”€ å·¥å…·è°ƒç”¨æ€»æ•°ï¼ˆæŒ‰å·¥å…·åã€çŠ¶æ€ï¼‰               â”‚   â”‚
â”‚  â”‚  â€¢ agent_retries_total                              â”‚   â”‚
â”‚  â”‚    â””â”€â”€ é‡è¯•æ¬¡æ•°ï¼ˆæŒ‰åŸå› ï¼‰                           â”‚   â”‚
â”‚  â”‚  â€¢ agent_errors_total                               â”‚   â”‚
â”‚  â”‚    â””â”€â”€ é”™è¯¯æ€»æ•°ï¼ˆæŒ‰é”™è¯¯ç±»å‹ï¼‰                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. äº‹ä»¶é©±åŠ¨æ¶æ„

äº‹ä»¶é©±åŠ¨æ¶æ„æ˜¯å®ç°å¯è§‚æµ‹æ€§çš„é‡è¦æ¨¡å¼ï¼Œå®ƒå°†ç³»ç»Ÿè¡Œä¸ºè§£è€¦ä¸ºç‹¬ç«‹çš„äº‹ä»¶ã€‚

### 6.1 äº‹ä»¶æ€»çº¿æ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    äº‹ä»¶æ€»çº¿æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Event Bus                         â”‚   â”‚
â”‚  â”‚                    (äº‹ä»¶æ€»çº¿)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â–²           â–²           â–²           â–²               â”‚
â”‚        â”‚           â”‚           â”‚           â”‚               â”‚
â”‚     publish     publish     publish     publish            â”‚
â”‚        â”‚           â”‚           â”‚           â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Session â”‚ â”‚  Tool   â”‚ â”‚   LLM   â”‚ â”‚   MCP   â”‚          â”‚
â”‚  â”‚ ä¼šè¯    â”‚ â”‚  å·¥å…·   â”‚ â”‚  æ¨¡å‹   â”‚ â”‚  åè®®   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Event Bus                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚           â”‚           â”‚           â”‚               â”‚
â”‚     subscribe   subscribe   subscribe   subscribe          â”‚
â”‚        â–¼           â–¼           â–¼           â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  æ—¥å¿—   â”‚ â”‚  æŒ‡æ ‡   â”‚ â”‚   UI    â”‚ â”‚  å‘Šè­¦   â”‚          â”‚
â”‚  â”‚ Logger  â”‚ â”‚ Metrics â”‚ â”‚ Display â”‚ â”‚ Alerter â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                             â”‚
â”‚  ä¼˜ç‚¹ï¼š                                                     â”‚
â”‚  â€¢ å‘å¸ƒè€…å’Œè®¢é˜…è€…è§£è€¦                                       â”‚
â”‚  â€¢ æ˜“äºæ·»åŠ æ–°çš„è§‚å¯Ÿè€…                                       â”‚
â”‚  â€¢ æ”¯æŒå¤šä¸ªè®¢é˜…è€…                                           â”‚
â”‚  â€¢ å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


### 6.2 äº‹ä»¶å®šä¹‰

```typescript
// äº‹ä»¶å®šä¹‰ç¤ºä¾‹
interface AgentEvent {
  type: string           // äº‹ä»¶ç±»å‹
  timestamp: Date        // å‘ç”Ÿæ—¶é—´
  traceId?: string       // è¿½è¸ª ID
  properties: Record<string, any>  // äº‹ä»¶å±æ€§
}

// å¸¸è§äº‹ä»¶ç±»å‹
type EventTypes = 
  | "session.created"      // ä¼šè¯åˆ›å»º
  | "session.updated"      // ä¼šè¯æ›´æ–°
  | "session.deleted"      // ä¼šè¯åˆ é™¤
  | "message.updated"      // æ¶ˆæ¯æ›´æ–°
  | "tool.called"          // å·¥å…·è°ƒç”¨
  | "tool.completed"       // å·¥å…·å®Œæˆ
  | "tool.failed"          // å·¥å…·å¤±è´¥
  | "llm.started"          // LLM è°ƒç”¨å¼€å§‹
  | "llm.completed"        // LLM è°ƒç”¨å®Œæˆ
  | "llm.error"            // LLM é”™è¯¯
  | "permission.asked"     // è¯·æ±‚æƒé™
  | "permission.replied"   // æƒé™å›å¤
```

### 6.3 å‘å¸ƒ-è®¢é˜…æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‘å¸ƒ-è®¢é˜…æ¨¡å¼                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å‘å¸ƒäº‹ä»¶ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  // å·¥å…·è°ƒç”¨å®Œæˆæ—¶å‘å¸ƒäº‹ä»¶                          â”‚   â”‚
â”‚  â”‚  Bus.publish(ToolEvent.Completed, {                 â”‚   â”‚
â”‚  â”‚    tool: "read_file",                               â”‚   â”‚
â”‚  â”‚    parameters: { path: "config.json" },             â”‚   â”‚
â”‚  â”‚    result: fileContent,                             â”‚   â”‚
â”‚  â”‚    duration: 120                                    â”‚   â”‚
â”‚  â”‚  })                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  è®¢é˜…äº‹ä»¶ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  // æ—¥å¿—è®°å½•å™¨è®¢é˜…æ‰€æœ‰äº‹ä»¶                          â”‚   â”‚
â”‚  â”‚  Bus.subscribeAll((event) => {                      â”‚   â”‚
â”‚  â”‚    log.info(event.type, event.properties)           â”‚   â”‚
â”‚  â”‚  })                                                 â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  // æŒ‡æ ‡æ”¶é›†å™¨è®¢é˜…ç‰¹å®šäº‹ä»¶                          â”‚   â”‚
â”‚  â”‚  Bus.subscribe(ToolEvent.Completed, (event) => {    â”‚   â”‚
â”‚  â”‚    metrics.recordToolCall(event.properties)         â”‚   â”‚
â”‚  â”‚  })                                                 â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  // UI è®¢é˜…ä¼šè¯æ›´æ–°                                 â”‚   â”‚
â”‚  â”‚  Bus.subscribe(Session.Event.Updated, (event) => {  â”‚   â”‚
â”‚  â”‚    ui.refresh(event.properties.sessionId)           â”‚   â”‚
â”‚  â”‚  })                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ä¸€æ¬¡æ€§è®¢é˜…ï¼š                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  // ç­‰å¾…ç‰¹å®šäº‹ä»¶å‘ç”Ÿä¸€æ¬¡                            â”‚   â”‚
â”‚  â”‚  Bus.once(Permission.Event.Replied, (event) => {    â”‚   â”‚
â”‚  â”‚    if (event.properties.granted) {                  â”‚   â”‚
â”‚  â”‚      // æƒé™å·²æˆäºˆï¼Œç»§ç»­æ‰§è¡Œ                        â”‚   â”‚
â”‚  â”‚      return "done"  // å–æ¶ˆè®¢é˜…                     â”‚   â”‚
â”‚  â”‚    }                                                â”‚   â”‚
â”‚  â”‚  })                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 äº‹ä»¶é©±åŠ¨çš„ä¼˜åŠ¿

| æ–¹é¢ | ä¼ ç»Ÿæ–¹å¼ | äº‹ä»¶é©±åŠ¨ |
|------|----------|----------|
| è€¦åˆåº¦ | é«˜ï¼ˆç›´æ¥è°ƒç”¨ï¼‰ | ä½ï¼ˆé€šè¿‡äº‹ä»¶é€šä¿¡ï¼‰ |
| æ‰©å±•æ€§ | éœ€è¦ä¿®æ”¹ä»£ç  | æ·»åŠ æ–°è®¢é˜…è€…å³å¯ |
| æµ‹è¯•æ€§ | éœ€è¦ mock ä¾èµ– | å¯ä»¥ç‹¬ç«‹æµ‹è¯• |
| å¼‚æ­¥å¤„ç† | éœ€è¦é¢å¤–å®ç° | å¤©ç„¶æ”¯æŒ |
| å¯è§‚æµ‹æ€§ | éœ€è¦ä¾µå…¥ä»£ç  | è®¢é˜…äº‹ä»¶å³å¯ |

---

## 7. å®è·µæ¡ˆä¾‹ï¼šOpenCode å¯è§‚æµ‹æ€§å®ç°

è®©æˆ‘ä»¬çœ‹çœ‹ OpenCode æ˜¯å¦‚ä½•å®ç°å¯è§‚æµ‹æ€§çš„ã€‚

### 7.1 é‡è¯•æœºåˆ¶ (session/retry.ts)

OpenCode å®ç°äº†æ™ºèƒ½çš„é‡è¯•æœºåˆ¶ï¼Œèƒ½å¤Ÿæ ¹æ®é”™è¯¯ç±»å‹å’Œå“åº”å¤´å†³å®šé‡è¯•ç­–ç•¥ï¼š

```typescript
// OpenCode é‡è¯•æœºåˆ¶æ ¸å¿ƒé€»è¾‘
// æ¥æº: packages/opencode/src/session/retry.ts

export namespace SessionRetry {
  // é‡è¯•é…ç½®å¸¸é‡
  export const RETRY_INITIAL_DELAY = 2000        // åˆå§‹å»¶è¿Ÿ 2 ç§’
  export const RETRY_BACKOFF_FACTOR = 2          // é€€é¿å› å­
  export const RETRY_MAX_DELAY_NO_HEADERS = 30_000  // æ— å“åº”å¤´æ—¶æœ€å¤§å»¶è¿Ÿ 30 ç§’
  export const RETRY_MAX_DELAY = 2_147_483_647   // setTimeout æœ€å¤§å€¼

  // å¯ä¸­æ–­çš„ç¡çœ å‡½æ•°
  // æ”¯æŒé€šè¿‡ AbortSignal å–æ¶ˆç­‰å¾…
  export async function sleep(ms: number, signal: AbortSignal): Promise<void> {
    return new Promise((resolve, reject) => {
      const abortHandler = () => {
        clearTimeout(timeout)
        reject(new DOMException("Aborted", "AbortError"))
      }
      const timeout = setTimeout(
        () => {
          signal.removeEventListener("abort", abortHandler)
          resolve()
        },
        Math.min(ms, RETRY_MAX_DELAY),  // ç¡®ä¿ä¸è¶…è¿‡æœ€å¤§å€¼
      )
      signal.addEventListener("abort", abortHandler, { once: true })
    })
  }

  // è®¡ç®—é‡è¯•å»¶è¿Ÿ
  // ä¼˜å…ˆä½¿ç”¨æœåŠ¡ç«¯è¿”å›çš„ retry-after å¤´
  export function delay(attempt: number, error?: MessageV2.APIError) {
    if (error) {
      const headers = error.data.responseHeaders
      if (headers) {
        // ä¼˜å…ˆæ£€æŸ¥ retry-after-msï¼ˆæ¯«ç§’ï¼‰
        const retryAfterMs = headers["retry-after-ms"]
        if (retryAfterMs) {
          const parsedMs = Number.parseFloat(retryAfterMs)
          if (!Number.isNaN(parsedMs)) {
            return parsedMs
          }
        }

        // å…¶æ¬¡æ£€æŸ¥ retry-afterï¼ˆç§’æˆ–æ—¥æœŸï¼‰
        const retryAfter = headers["retry-after"]
        if (retryAfter) {
          const parsedSeconds = Number.parseFloat(retryAfter)
          if (!Number.isNaN(parsedSeconds)) {
            return Math.ceil(parsedSeconds * 1000)  // è½¬æ¢ä¸ºæ¯«ç§’
          }
          // å°è¯•è§£æ HTTP æ—¥æœŸæ ¼å¼
          const parsed = Date.parse(retryAfter) - Date.now()
          if (!Number.isNaN(parsed) && parsed > 0) {
            return Math.ceil(parsed)
          }
        }

        // æœ‰å“åº”å¤´ä½†æ²¡æœ‰ retry-afterï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿
        return RETRY_INITIAL_DELAY * Math.pow(RETRY_BACKOFF_FACTOR, attempt - 1)
      }
    }

    // æ— å“åº”å¤´ï¼Œä½¿ç”¨æœ‰ä¸Šé™çš„æŒ‡æ•°é€€é¿
    return Math.min(
      RETRY_INITIAL_DELAY * Math.pow(RETRY_BACKOFF_FACTOR, attempt - 1),
      RETRY_MAX_DELAY_NO_HEADERS
    )
  }

  // åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•
  // è¿”å›å¯é‡è¯•çš„åŸå› ï¼Œæˆ– undefined è¡¨ç¤ºä¸å¯é‡è¯•
  export function retryable(error: ReturnType<NamedError["toObject"]>) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯ API é”™è¯¯
    if (MessageV2.APIError.isInstance(error)) {
      if (!error.data.isRetryable) return undefined
      return error.data.message.includes("Overloaded") 
        ? "Provider is overloaded" 
        : error.data.message
    }

    // å°è¯•è§£æé”™è¯¯æ¶ˆæ¯ä¸­çš„ JSON
    if (typeof error.data?.message === "string") {
      try {
        const json = JSON.parse(error.data.message)
        // æ£€æŸ¥å„ç§å¯é‡è¯•çš„é”™è¯¯ç±»å‹
        if (json.type === "error" && json.error?.type === "too_many_requests") {
          return "Too Many Requests"
        }
        if (json.code.includes("exhausted") || json.code.includes("unavailable")) {
          return "Provider is overloaded"
        }
        if (json.type === "error" && json.error?.code?.includes("rate_limit")) {
          return "Rate Limited"
        }
        if (json.error?.message?.includes("no_kv_space") ||
            (json.type === "error" && json.error?.type === "server_error") ||
            !!json.error) {
          return "Provider Server Error"
        }
      } catch {}
    }

    return undefined  // ä¸å¯é‡è¯•
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
1. **å“åº”å¤´ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨æœåŠ¡ç«¯è¿”å›çš„ `retry-after` å¤´ï¼Œè¿™æ˜¯æœ€ç²¾ç¡®çš„é‡è¯•æ—¶æœº
2. **æŒ‡æ•°é€€é¿**ï¼šæ²¡æœ‰å“åº”å¤´æ—¶ä½¿ç”¨æŒ‡æ•°é€€é¿ï¼Œé¿å…å¯¹æœåŠ¡é€ æˆå‹åŠ›
3. **æœ€å¤§å»¶è¿Ÿé™åˆ¶**ï¼šè®¾ç½®åˆç†çš„æœ€å¤§å»¶è¿Ÿï¼Œé¿å…æ— é™ç­‰å¾…
4. **å¯ä¸­æ–­ç­‰å¾…**ï¼šæ”¯æŒé€šè¿‡ AbortSignal å–æ¶ˆç­‰å¾…ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
5. **é”™è¯¯åˆ†ç±»**ï¼šæ™ºèƒ½åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•ï¼Œé¿å…æ— æ„ä¹‰çš„é‡è¯•


### 7.2 äº‹ä»¶æ€»çº¿ (bus/index.ts)

OpenCode ä½¿ç”¨äº‹ä»¶æ€»çº¿å®ç°ç»„ä»¶é—´çš„æ¾è€¦åˆé€šä¿¡ï¼š

```typescript
// OpenCode äº‹ä»¶æ€»çº¿å®ç°
// æ¥æº: packages/opencode/src/bus/index.ts

import z from "zod"
import { Log } from "../util/log"
import { Instance } from "../project/instance"
import { BusEvent } from "./bus-event"
import { GlobalBus } from "./global"

export namespace Bus {
  const log = Log.create({ service: "bus" })
  type Subscription = (event: any) => void

  // å®šä¹‰å®ä¾‹é”€æ¯äº‹ä»¶
  export const InstanceDisposed = BusEvent.define(
    "server.instance.disposed",
    z.object({
      directory: z.string(),
    }),
  )

  // ä½¿ç”¨ Instance.state ç®¡ç†è®¢é˜…çŠ¶æ€
  // ç¡®ä¿æ¯ä¸ªå®ä¾‹æœ‰ç‹¬ç«‹çš„è®¢é˜…åˆ—è¡¨
  const state = Instance.state(
    () => {
      const subscriptions = new Map<any, Subscription[]>()
      return { subscriptions }
    },
    // æ¸…ç†å›è°ƒï¼šå®ä¾‹é”€æ¯æ—¶é€šçŸ¥æ‰€æœ‰é€šé…ç¬¦è®¢é˜…è€…
    async (entry) => {
      const wildcard = entry.subscriptions.get("*")
      if (!wildcard) return
      const event = {
        type: InstanceDisposed.type,
        properties: { directory: Instance.directory },
      }
      for (const sub of [...wildcard]) {
        sub(event)
      }
    },
  )

  // å‘å¸ƒäº‹ä»¶
  // é€šçŸ¥æ‰€æœ‰è®¢é˜…äº†è¯¥äº‹ä»¶ç±»å‹çš„è®¢é˜…è€…
  export async function publish<Definition extends BusEvent.Definition>(
    def: Definition,
    properties: z.output<Definition["properties"]>,
  ) {
    const payload = {
      type: def.type,
      properties,
    }
    log.info("publishing", { type: def.type })
    
    const pending = []
    // é€šçŸ¥ç‰¹å®šç±»å‹çš„è®¢é˜…è€…å’Œé€šé…ç¬¦è®¢é˜…è€…
    for (const key of [def.type, "*"]) {
      const match = state().subscriptions.get(key)
      for (const sub of match ?? []) {
        pending.push(sub(payload))
      }
    }
    
    // åŒæ—¶å‘é€åˆ°å…¨å±€äº‹ä»¶æ€»çº¿ï¼ˆè·¨å®ä¾‹é€šä¿¡ï¼‰
    GlobalBus.emit("event", {
      directory: Instance.directory,
      payload,
    })
    
    return Promise.all(pending)
  }

  // è®¢é˜…ç‰¹å®šç±»å‹çš„äº‹ä»¶
  export function subscribe<Definition extends BusEvent.Definition>(
    def: Definition,
    callback: (event: { 
      type: Definition["type"]
      properties: z.infer<Definition["properties"]> 
    }) => void,
  ) {
    return raw(def.type, callback)
  }

  // ä¸€æ¬¡æ€§è®¢é˜…
  // å›è°ƒè¿”å› "done" æ—¶è‡ªåŠ¨å–æ¶ˆè®¢é˜…
  export function once<Definition extends BusEvent.Definition>(
    def: Definition,
    callback: (event: {
      type: Definition["type"]
      properties: z.infer<Definition["properties"]>
    }) => "done" | undefined,
  ) {
    const unsub = subscribe(def, (event) => {
      if (callback(event)) unsub()
    })
  }

  // è®¢é˜…æ‰€æœ‰äº‹ä»¶ï¼ˆé€šé…ç¬¦è®¢é˜…ï¼‰
  export function subscribeAll(callback: (event: any) => void) {
    return raw("*", callback)
  }

  // åº•å±‚è®¢é˜…å®ç°
  function raw(type: string, callback: (event: any) => void) {
    log.info("subscribing", { type })
    const subscriptions = state().subscriptions
    let match = subscriptions.get(type) ?? []
    match.push(callback)
    subscriptions.set(type, match)

    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      log.info("unsubscribing", { type })
      const match = subscriptions.get(type)
      if (!match) return
      const index = match.indexOf(callback)
      if (index === -1) return
      match.splice(index, 1)
    }
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
1. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨ Zod å®šä¹‰äº‹ä»¶å±æ€§ï¼Œç¡®ä¿ç±»å‹å®‰å…¨
2. **é€šé…ç¬¦è®¢é˜…**ï¼šæ”¯æŒ `*` è®¢é˜…æ‰€æœ‰äº‹ä»¶ï¼Œæ–¹ä¾¿æ—¥å¿—è®°å½•
3. **ä¸€æ¬¡æ€§è®¢é˜…**ï¼š`once` æ–¹æ³•æ”¯æŒç­‰å¾…ç‰¹å®šäº‹ä»¶åè‡ªåŠ¨å–æ¶ˆ
4. **å®ä¾‹éš”ç¦»**ï¼šæ¯ä¸ªå®ä¾‹æœ‰ç‹¬ç«‹çš„è®¢é˜…åˆ—è¡¨ï¼Œé¿å…è·¨å®ä¾‹å¹²æ‰°
5. **å…¨å±€å¹¿æ’­**ï¼šé€šè¿‡ GlobalBus æ”¯æŒè·¨å®ä¾‹äº‹ä»¶ä¼ æ’­

### 7.3 æ—¥å¿—ç³»ç»Ÿ (util/log.ts)

OpenCode å®ç°äº†ç»“æ„åŒ–çš„æ—¥å¿—ç³»ç»Ÿï¼š

```typescript
// OpenCode æ—¥å¿—ç³»ç»Ÿå®ç°
// æ¥æº: packages/opencode/src/util/log.ts

export namespace Log {
  // æ—¥å¿—çº§åˆ«å®šä¹‰
  export const Level = z.enum(["DEBUG", "INFO", "WARN", "ERROR"])
  export type Level = z.infer<typeof Level>

  // çº§åˆ«ä¼˜å…ˆçº§ï¼Œç”¨äºè¿‡æ»¤
  const levelPriority: Record<Level, number> = {
    DEBUG: 0,
    INFO: 1,
    WARN: 2,
    ERROR: 3,
  }

  let level: Level = "INFO"  // é»˜è®¤çº§åˆ«

  // åˆ¤æ–­æ˜¯å¦åº”è¯¥è®°å½•è¯¥çº§åˆ«çš„æ—¥å¿—
  function shouldLog(input: Level): boolean {
    return levelPriority[input] >= levelPriority[level]
  }

  // Logger æ¥å£å®šä¹‰
  export type Logger = {
    debug(message?: any, extra?: Record<string, any>): void
    info(message?: any, extra?: Record<string, any>): void
    error(message?: any, extra?: Record<string, any>): void
    warn(message?: any, extra?: Record<string, any>): void
    tag(key: string, value: string): Logger  // æ·»åŠ æ ‡ç­¾
    clone(): Logger                           // å…‹éš† Logger
    time(message: string, extra?: Record<string, any>): {
      stop(): void
      [Symbol.dispose](): void  // æ”¯æŒ using è¯­æ³•
    }
  }

  // Logger ç¼“å­˜ï¼Œé¿å…é‡å¤åˆ›å»º
  const loggers = new Map<string, Logger>()

  // æ„å»ºæ—¥å¿—æ¶ˆæ¯
  // æ ¼å¼: æ—¶é—´ +å»¶è¿Ÿ æ ‡ç­¾ æ¶ˆæ¯
  let last = Date.now()
  function build(tags: Record<string, any>, message: any, extra?: Record<string, any>) {
    const prefix = Object.entries({ ...tags, ...extra })
      .filter(([_, value]) => value !== undefined && value !== null)
      .map(([key, value]) => {
        const prefix = `${key}=`
        if (value instanceof Error) return prefix + formatError(value)
        if (typeof value === "object") return prefix + JSON.stringify(value)
        return prefix + value
      })
      .join(" ")
    
    const next = new Date()
    const diff = next.getTime() - last
    last = next.getTime()
    
    // æ ¼å¼: 2024-01-15T10:00:00 +123ms service=tool message
    return [
      next.toISOString().split(".")[0],
      "+" + diff + "ms",
      prefix,
      message
    ].filter(Boolean).join(" ") + "\n"
  }

  // åˆ›å»º Logger
  export function create(tags?: Record<string, any>) {
    tags = tags || {}
    const service = tags["service"]
    
    // æ£€æŸ¥ç¼“å­˜
    if (service && typeof service === "string") {
      const cached = loggers.get(service)
      if (cached) return cached
    }

    const result: Logger = {
      debug(message?: any, extra?: Record<string, any>) {
        if (shouldLog("DEBUG")) {
          write("DEBUG " + build(tags!, message, extra))
        }
      },
      info(message?: any, extra?: Record<string, any>) {
        if (shouldLog("INFO")) {
          write("INFO  " + build(tags!, message, extra))
        }
      },
      error(message?: any, extra?: Record<string, any>) {
        if (shouldLog("ERROR")) {
          write("ERROR " + build(tags!, message, extra))
        }
      },
      warn(message?: any, extra?: Record<string, any>) {
        if (shouldLog("WARN")) {
          write("WARN  " + build(tags!, message, extra))
        }
      },
      // æ·»åŠ æ ‡ç­¾
      tag(key: string, value: string) {
        if (tags) tags[key] = value
        return result
      },
      // å…‹éš† Logger
      clone() {
        return Log.create({ ...tags })
      },
      // è®¡æ—¶åŠŸèƒ½
      time(message: string, extra?: Record<string, any>) {
        const now = Date.now()
        result.info(message, { status: "started", ...extra })
        
        function stop() {
          result.info(message, {
            status: "completed",
            duration: Date.now() - now,
            ...extra,
          })
        }
        
        return {
          stop,
          [Symbol.dispose]() { stop() },  // æ”¯æŒ using è¯­æ³•è‡ªåŠ¨åœæ­¢
        }
      },
    }

    // ç¼“å­˜ Logger
    if (service && typeof service === "string") {
      loggers.set(service, result)
    }

    return result
  }
}
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
1. **ç»“æ„åŒ–è¾“å‡º**ï¼šä½¿ç”¨ `key=value` æ ¼å¼ï¼Œä¾¿äºè§£æ
2. **æ—¶é—´å·®æ˜¾ç¤º**ï¼šæ˜¾ç¤ºä¸ä¸Šä¸€æ¡æ—¥å¿—çš„æ—¶é—´å·®ï¼Œä¾¿äºæ€§èƒ½åˆ†æ
3. **çº§åˆ«è¿‡æ»¤**ï¼šæ”¯æŒæŒ‰çº§åˆ«è¿‡æ»¤æ—¥å¿—
4. **æ ‡ç­¾ç³»ç»Ÿ**ï¼šæ”¯æŒæ·»åŠ æ ‡ç­¾ï¼Œä¾¿äºåˆ†ç±»å’Œè¿‡æ»¤
5. **è®¡æ—¶åŠŸèƒ½**ï¼šå†…ç½® `time` æ–¹æ³•ï¼Œæ”¯æŒ `using` è¯­æ³•è‡ªåŠ¨è®°å½•è€—æ—¶
6. **Logger ç¼“å­˜**ï¼šç›¸åŒ service å¤ç”¨ Loggerï¼Œé¿å…é‡å¤åˆ›å»º


### 7.4 OpenCode äº‹ä»¶ç±»å‹ä¸€è§ˆ

OpenCode å®šä¹‰äº†ä¸°å¯Œçš„äº‹ä»¶ç±»å‹ï¼Œè¦†ç›–ç³»ç»Ÿçš„å„ä¸ªæ–¹é¢ï¼š

```typescript
// OpenCode ä¸­å®šä¹‰çš„ä¸»è¦äº‹ä»¶ç±»å‹
// è¿™äº›äº‹ä»¶é€šè¿‡ BusEvent.define() å®šä¹‰

// ä¼šè¯ç›¸å…³äº‹ä»¶
Session.Event.Created    // ä¼šè¯åˆ›å»º
Session.Event.Updated    // ä¼šè¯æ›´æ–°
Session.Event.Deleted    // ä¼šè¯åˆ é™¤
Session.Event.Error      // ä¼šè¯é”™è¯¯

// æ¶ˆæ¯ç›¸å…³äº‹ä»¶
MessageV2.Event.Updated      // æ¶ˆæ¯æ›´æ–°
MessageV2.Event.Removed      // æ¶ˆæ¯åˆ é™¤
MessageV2.Event.PartUpdated  // æ¶ˆæ¯éƒ¨åˆ†æ›´æ–°
MessageV2.Event.PartRemoved  // æ¶ˆæ¯éƒ¨åˆ†åˆ é™¤

// æƒé™ç›¸å…³äº‹ä»¶
Permission.Event.Asked    // è¯·æ±‚æƒé™
Permission.Event.Replied  // æƒé™å›å¤

// å·¥å…·ç›¸å…³äº‹ä»¶
MCP.ToolsChanged  // MCP å·¥å…·å˜æ›´

// LSP ç›¸å…³äº‹ä»¶
LSP.Event.Updated           // LSP çŠ¶æ€æ›´æ–°
LSPClient.Event.Diagnostics // ä»£ç è¯Šæ–­æ›´æ–°

// æ–‡ä»¶ç›¸å…³äº‹ä»¶
File.Event.Edited           // æ–‡ä»¶ç¼–è¾‘
FileWatcher.Event.Updated   // æ–‡ä»¶å˜æ›´

// ç»ˆç«¯ç›¸å…³äº‹ä»¶
PTY.Event.Created  // ç»ˆç«¯åˆ›å»º
PTY.Event.Updated  // ç»ˆç«¯æ›´æ–°
PTY.Event.Exited   // ç»ˆç«¯é€€å‡º
PTY.Event.Deleted  // ç»ˆç«¯åˆ é™¤

// é¡¹ç›®ç›¸å…³äº‹ä»¶
Project.Event.Updated      // é¡¹ç›®æ›´æ–°
Vcs.Event.BranchUpdated    // åˆ†æ”¯æ›´æ–°

// å‘½ä»¤ç›¸å…³äº‹ä»¶
Command.Event.Executed  // å‘½ä»¤æ‰§è¡Œ

// å®‰è£…ç›¸å…³äº‹ä»¶
Installation.Event.Updated         // å®‰è£…æ›´æ–°
Installation.Event.UpdateAvailable // æœ‰å¯ç”¨æ›´æ–°
```

**äº‹ä»¶ä½¿ç”¨ç¤ºä¾‹**ï¼š

```typescript
// ç›‘å¬ä¼šè¯é”™è¯¯ï¼Œè®°å½•æ—¥å¿—
Bus.subscribe(Session.Event.Error, (event) => {
  log.error("Session error", {
    sessionId: event.properties.sessionId,
    error: event.properties.error,
  })
})

// ç›‘å¬å·¥å…·å˜æ›´ï¼Œåˆ·æ–° UI
Bus.subscribe(MCP.ToolsChanged, (event) => {
  ui.refreshToolList()
})

// ç›‘å¬æ‰€æœ‰äº‹ä»¶ï¼Œå‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
Bus.subscribeAll((event) => {
  monitoring.send({
    type: event.type,
    timestamp: Date.now(),
    properties: event.properties,
  })
})
```

---


## åŠ¨æ‰‹å®éªŒ

### å®éªŒ 1ï¼šå®ç°ç®€å•çš„é“¾è·¯è¿½è¸ª

åˆ›å»ºä¸€ä¸ªç®€å•çš„é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œè®°å½• Agent æ‰§è¡Œè¿‡ç¨‹ï¼š

```typescript
// trace.ts - ç®€å•çš„é“¾è·¯è¿½è¸ªå®ç°

interface Span {
  traceId: string
  spanId: string
  parentSpanId?: string
  name: string
  startTime: number
  endTime?: number
  attributes: Record<string, any>
  events: Array<{
    name: string
    timestamp: number
    attributes?: Record<string, any>
  }>
}

class Tracer {
  private spans: Map<string, Span> = new Map()
  private currentSpan?: Span

  // ç”Ÿæˆå”¯ä¸€ ID
  private generateId(): string {
    return Math.random().toString(36).substring(2, 15)
  }

  // å¼€å§‹æ–°çš„ Trace
  startTrace(name: string): Span {
    const span: Span = {
      traceId: this.generateId(),
      spanId: this.generateId(),
      name,
      startTime: Date.now(),
      attributes: {},
      events: [],
    }
    this.spans.set(span.spanId, span)
    this.currentSpan = span
    return span
  }

  // å¼€å§‹å­ Span
  startSpan(name: string): Span {
    const parent = this.currentSpan
    const span: Span = {
      traceId: parent?.traceId ?? this.generateId(),
      spanId: this.generateId(),
      parentSpanId: parent?.spanId,
      name,
      startTime: Date.now(),
      attributes: {},
      events: [],
    }
    this.spans.set(span.spanId, span)
    this.currentSpan = span
    return span
  }

  // ç»“æŸ Span
  endSpan(span: Span): void {
    span.endTime = Date.now()
    // æ¢å¤åˆ°çˆ¶ Span
    if (span.parentSpanId) {
      this.currentSpan = this.spans.get(span.parentSpanId)
    }
  }

  // æ·»åŠ å±æ€§
  setAttribute(span: Span, key: string, value: any): void {
    span.attributes[key] = value
  }

  // æ·»åŠ äº‹ä»¶
  addEvent(span: Span, name: string, attributes?: Record<string, any>): void {
    span.events.push({
      name,
      timestamp: Date.now(),
      attributes,
    })
  }

  // è·å– Trace çš„æ‰€æœ‰ Span
  getTrace(traceId: string): Span[] {
    return Array.from(this.spans.values())
      .filter(s => s.traceId === traceId)
  }

  // æ‰“å° Trace
  printTrace(traceId: string): void {
    const spans = this.getTrace(traceId)
    const root = spans.find(s => !s.parentSpanId)
    if (!root) return

    const printSpan = (span: Span, indent: number) => {
      const duration = span.endTime ? span.endTime - span.startTime : '...'
      console.log(`${'  '.repeat(indent)}â”œâ”€â”€ ${span.name} (${duration}ms)`)
      
      // æ‰“å°å±æ€§
      for (const [key, value] of Object.entries(span.attributes)) {
        console.log(`${'  '.repeat(indent + 1)}${key}: ${JSON.stringify(value)}`)
      }
      
      // æ‰“å°å­ Span
      const children = spans.filter(s => s.parentSpanId === span.spanId)
      for (const child of children) {
        printSpan(child, indent + 1)
      }
    }

    console.log(`Trace: ${traceId}`)
    printSpan(root, 0)
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const tracer = new Tracer()

async function agentLoop(query: string) {
  const rootSpan = tracer.startTrace("agent-loop")
  tracer.setAttribute(rootSpan, "query", query)

  try {
    // LLM è°ƒç”¨
    const llmSpan = tracer.startSpan("llm-call")
    tracer.setAttribute(llmSpan, "model", "claude-3-5-sonnet")
    
    // æ¨¡æ‹Ÿ LLM è°ƒç”¨
    await new Promise(r => setTimeout(r, 1000))
    tracer.setAttribute(llmSpan, "inputTokens", 1200)
    tracer.setAttribute(llmSpan, "outputTokens", 150)
    tracer.endSpan(llmSpan)

    // å·¥å…·è°ƒç”¨
    const toolSpan = tracer.startSpan("tool-call")
    tracer.setAttribute(toolSpan, "tool", "read_file")
    tracer.setAttribute(toolSpan, "parameters", { path: "config.json" })
    
    // æ¨¡æ‹Ÿå·¥å…·è°ƒç”¨
    await new Promise(r => setTimeout(r, 100))
    tracer.addEvent(toolSpan, "file-read", { size: 1024 })
    tracer.endSpan(toolSpan)

    tracer.setAttribute(rootSpan, "status", "success")
  } catch (error) {
    tracer.setAttribute(rootSpan, "status", "error")
    tracer.setAttribute(rootSpan, "error", String(error))
  } finally {
    tracer.endSpan(rootSpan)
  }

  tracer.printTrace(rootSpan.traceId)
}

// è¿è¡Œ
agentLoop("è¯»å–é…ç½®æ–‡ä»¶")
```

**å®éªŒç›®æ ‡**ï¼š
1. ç†è§£ Trace å’Œ Span çš„å…³ç³»
2. å®ç°åŸºæœ¬çš„é“¾è·¯è¿½è¸ªåŠŸèƒ½
3. å­¦ä¼šè®°å½•å…³é”®å±æ€§å’Œäº‹ä»¶

### å®éªŒ 2ï¼šå®ç° Token ä½¿ç”¨ç»Ÿè®¡

```typescript
// token-tracker.ts - Token ä½¿ç”¨ç»Ÿè®¡

interface TokenUsage {
  requestId: string
  timestamp: Date
  model: string
  inputTokens: number
  outputTokens: number
  cachedTokens: number
  cost: number
}

class TokenTracker {
  private usages: TokenUsage[] = []
  
  // æ¨¡å‹å®šä»·ï¼ˆæ¯ç™¾ä¸‡ Tokenï¼‰
  private pricing: Record<string, { input: number; output: number; cached: number }> = {
    "claude-3-5-sonnet": { input: 3.00, output: 15.00, cached: 0.30 },
    "gpt-4o": { input: 2.50, output: 10.00, cached: 0.25 },
    "gpt-4o-mini": { input: 0.15, output: 0.60, cached: 0.015 },
  }

  // è®°å½•ä½¿ç”¨
  record(usage: Omit<TokenUsage, "cost">): TokenUsage {
    const pricing = this.pricing[usage.model]
    const cost = pricing
      ? (usage.inputTokens * pricing.input +
         usage.outputTokens * pricing.output +
         usage.cachedTokens * pricing.cached) / 1_000_000
      : 0

    const record: TokenUsage = { ...usage, cost }
    this.usages.push(record)
    return record
  }

  // è·å–ç»Ÿè®¡
  getStats(options?: { model?: string; since?: Date }) {
    let filtered = this.usages

    if (options?.model) {
      filtered = filtered.filter(u => u.model === options.model)
    }
    if (options?.since) {
      filtered = filtered.filter(u => u.timestamp >= options.since)
    }

    const totalInputTokens = filtered.reduce((sum, u) => sum + u.inputTokens, 0)
    const totalOutputTokens = filtered.reduce((sum, u) => sum + u.outputTokens, 0)
    const totalCachedTokens = filtered.reduce((sum, u) => sum + u.cachedTokens, 0)
    const totalCost = filtered.reduce((sum, u) => sum + u.cost, 0)

    return {
      requestCount: filtered.length,
      totalInputTokens,
      totalOutputTokens,
      totalCachedTokens,
      totalTokens: totalInputTokens + totalOutputTokens,
      totalCost,
      avgTokensPerRequest: filtered.length > 0
        ? (totalInputTokens + totalOutputTokens) / filtered.length
        : 0,
      cacheHitRate: totalInputTokens > 0
        ? totalCachedTokens / totalInputTokens
        : 0,
    }
  }

  // æ‰“å°æŠ¥å‘Š
  printReport() {
    const stats = this.getStats()
    console.log("=== Token ä½¿ç”¨æŠ¥å‘Š ===")
    console.log(`è¯·æ±‚æ•°: ${stats.requestCount}`)
    console.log(`è¾“å…¥ Tokens: ${stats.totalInputTokens.toLocaleString()}`)
    console.log(`è¾“å‡º Tokens: ${stats.totalOutputTokens.toLocaleString()}`)
    console.log(`ç¼“å­˜å‘½ä¸­: ${stats.totalCachedTokens.toLocaleString()}`)
    console.log(`ç¼“å­˜å‘½ä¸­ç‡: ${(stats.cacheHitRate * 100).toFixed(1)}%`)
    console.log(`å¹³å‡æ¯è¯·æ±‚: ${stats.avgTokensPerRequest.toFixed(0)} tokens`)
    console.log(`æ€»æˆæœ¬: $${stats.totalCost.toFixed(4)}`)
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const tracker = new TokenTracker()

// æ¨¡æ‹Ÿå‡ æ¬¡è¯·æ±‚
tracker.record({
  requestId: "req-1",
  timestamp: new Date(),
  model: "claude-3-5-sonnet",
  inputTokens: 1500,
  outputTokens: 200,
  cachedTokens: 500,
})

tracker.record({
  requestId: "req-2",
  timestamp: new Date(),
  model: "claude-3-5-sonnet",
  inputTokens: 2000,
  outputTokens: 350,
  cachedTokens: 1000,
})

tracker.printReport()
```

**å®éªŒç›®æ ‡**ï¼š
1. ç†è§£ Token æˆæœ¬è®¡ç®—
2. å®ç°ä½¿ç”¨é‡ç»Ÿè®¡
3. å­¦ä¼šåˆ†æç¼“å­˜å‘½ä¸­ç‡


### å®éªŒ 3ï¼šå®ç°äº‹ä»¶æ€»çº¿

```typescript
// event-bus.ts - ç®€å•çš„äº‹ä»¶æ€»çº¿å®ç°

type EventCallback<T = any> = (event: T) => void | Promise<void>

class EventBus {
  private subscriptions = new Map<string, EventCallback[]>()

  // è®¢é˜…äº‹ä»¶
  subscribe<T>(eventType: string, callback: EventCallback<T>): () => void {
    const callbacks = this.subscriptions.get(eventType) ?? []
    callbacks.push(callback as EventCallback)
    this.subscriptions.set(eventType, callbacks)

    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      const callbacks = this.subscriptions.get(eventType)
      if (!callbacks) return
      const index = callbacks.indexOf(callback as EventCallback)
      if (index !== -1) {
        callbacks.splice(index, 1)
      }
    }
  }

  // è®¢é˜…æ‰€æœ‰äº‹ä»¶
  subscribeAll(callback: EventCallback<{ type: string; data: any }>): () => void {
    return this.subscribe("*", callback)
  }

  // å‘å¸ƒäº‹ä»¶
  async publish<T>(eventType: string, data: T): Promise<void> {
    const event = { type: eventType, data, timestamp: Date.now() }
    
    // é€šçŸ¥ç‰¹å®šè®¢é˜…è€…
    const specific = this.subscriptions.get(eventType) ?? []
    for (const callback of specific) {
      await callback(data)
    }

    // é€šçŸ¥é€šé…ç¬¦è®¢é˜…è€…
    const wildcard = this.subscriptions.get("*") ?? []
    for (const callback of wildcard) {
      await callback(event)
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const bus = new EventBus()

// è®¢é˜…ç‰¹å®šäº‹ä»¶
const unsubTool = bus.subscribe("tool.completed", (event: any) => {
  console.log(`å·¥å…· ${event.tool} æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶ ${event.duration}ms`)
})

// è®¢é˜…æ‰€æœ‰äº‹ä»¶ï¼ˆç”¨äºæ—¥å¿—ï¼‰
bus.subscribeAll((event) => {
  console.log(`[LOG] ${event.type}:`, JSON.stringify(event.data))
})

// å‘å¸ƒäº‹ä»¶
bus.publish("tool.completed", {
  tool: "read_file",
  parameters: { path: "config.json" },
  duration: 120,
  status: "success",
})

bus.publish("llm.completed", {
  model: "claude-3-5-sonnet",
  inputTokens: 1500,
  outputTokens: 200,
  duration: 1200,
})

// å–æ¶ˆè®¢é˜…
unsubTool()
```

**å®éªŒç›®æ ‡**ï¼š
1. ç†è§£å‘å¸ƒ-è®¢é˜…æ¨¡å¼
2. å®ç°äº‹ä»¶æ€»çº¿åŸºæœ¬åŠŸèƒ½
3. å­¦ä¼šä½¿ç”¨é€šé…ç¬¦è®¢é˜…

---

## å®æˆ˜é¡¹ç›®ï¼šAgent æ‰§è¡Œç›‘æ§é¢æ¿

### é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ª Agent æ‰§è¡Œç›‘æ§é¢æ¿ï¼Œå®æ—¶å±•ç¤ºï¼š
- è¯·æ±‚é“¾è·¯è¿½è¸ª
- Token ä½¿ç”¨ç»Ÿè®¡
- å·¥å…·è°ƒç”¨åˆ†æ
- é”™è¯¯ç›‘æ§

### é¡¹ç›®æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç›‘æ§é¢æ¿æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Agent Core                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚   LLM   â”‚  â”‚  Tools  â”‚  â”‚ Memory  â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚       â”‚            â”‚            â”‚                   â”‚   â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚  â”‚                    â”‚                                â”‚   â”‚
â”‚  â”‚                    â–¼                                â”‚   â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚            â”‚  Event Bus    â”‚                        â”‚   â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                     â”‚
â”‚                       â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Monitoring Layer                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚   â”‚
â”‚  â”‚  â”‚ Tracer  â”‚  â”‚ Metrics â”‚  â”‚ Logger  â”‚             â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â”‚       â”‚            â”‚            â”‚                   â”‚   â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚  â”‚                    â”‚                                â”‚   â”‚
â”‚  â”‚                    â–¼                                â”‚   â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚            â”‚   Storage     â”‚                        â”‚   â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â”‚                                     â”‚
â”‚                       â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                Dashboard UI                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  å®æ—¶æŒ‡æ ‡  â”‚  é“¾è·¯è¿½è¸ª  â”‚  é”™è¯¯åˆ—è¡¨  â”‚  æˆæœ¬  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®ç°æ­¥éª¤

#### æ­¥éª¤ 1ï¼šå®šä¹‰ç›‘æ§æ•°æ®ç»“æ„

```typescript
// types.ts - ç›‘æ§æ•°æ®ç±»å‹å®šä¹‰

// é“¾è·¯è¿½è¸ª
interface Trace {
  traceId: string
  startTime: number
  endTime?: number
  status: "running" | "success" | "error"
  spans: Span[]
}

interface Span {
  spanId: string
  parentSpanId?: string
  name: string
  startTime: number
  endTime?: number
  attributes: Record<string, any>
}

// æŒ‡æ ‡
interface Metrics {
  // è¯·æ±‚æŒ‡æ ‡
  requestCount: number
  successCount: number
  errorCount: number
  avgDuration: number
  
  // Token æŒ‡æ ‡
  totalInputTokens: number
  totalOutputTokens: number
  totalCost: number
  
  // å·¥å…·æŒ‡æ ‡
  toolCalls: Record<string, {
    count: number
    successRate: number
    avgDuration: number
  }>
}

// é”™è¯¯è®°å½•
interface ErrorRecord {
  id: string
  timestamp: number
  traceId?: string
  type: string
  message: string
  stack?: string
  context?: Record<string, any>
}
```

#### æ­¥éª¤ 2ï¼šå®ç°ç›‘æ§æ”¶é›†å™¨

```typescript
// monitor.ts - ç›‘æ§æ”¶é›†å™¨

class AgentMonitor {
  private traces = new Map<string, Trace>()
  private metrics: Metrics = {
    requestCount: 0,
    successCount: 0,
    errorCount: 0,
    avgDuration: 0,
    totalInputTokens: 0,
    totalOutputTokens: 0,
    totalCost: 0,
    toolCalls: {},
  }
  private errors: ErrorRecord[] = []
  private eventBus: EventBus

  constructor(eventBus: EventBus) {
    this.eventBus = eventBus
    this.setupSubscriptions()
  }

  private setupSubscriptions() {
    // è®¢é˜…è¯·æ±‚å¼€å§‹
    this.eventBus.subscribe("request.started", (event: any) => {
      this.traces.set(event.traceId, {
        traceId: event.traceId,
        startTime: Date.now(),
        status: "running",
        spans: [],
      })
      this.metrics.requestCount++
    })

    // è®¢é˜…è¯·æ±‚å®Œæˆ
    this.eventBus.subscribe("request.completed", (event: any) => {
      const trace = this.traces.get(event.traceId)
      if (trace) {
        trace.endTime = Date.now()
        trace.status = "success"
        this.metrics.successCount++
        this.updateAvgDuration(trace.endTime - trace.startTime)
      }
    })

    // è®¢é˜…è¯·æ±‚é”™è¯¯
    this.eventBus.subscribe("request.error", (event: any) => {
      const trace = this.traces.get(event.traceId)
      if (trace) {
        trace.endTime = Date.now()
        trace.status = "error"
        this.metrics.errorCount++
      }
      this.recordError({
        id: this.generateId(),
        timestamp: Date.now(),
        traceId: event.traceId,
        type: event.errorType,
        message: event.message,
        stack: event.stack,
      })
    })

    // è®¢é˜… LLM è°ƒç”¨
    this.eventBus.subscribe("llm.completed", (event: any) => {
      this.metrics.totalInputTokens += event.inputTokens
      this.metrics.totalOutputTokens += event.outputTokens
      this.metrics.totalCost += event.cost
    })

    // è®¢é˜…å·¥å…·è°ƒç”¨
    this.eventBus.subscribe("tool.completed", (event: any) => {
      const tool = event.tool
      if (!this.metrics.toolCalls[tool]) {
        this.metrics.toolCalls[tool] = {
          count: 0,
          successRate: 1,
          avgDuration: 0,
        }
      }
      const stats = this.metrics.toolCalls[tool]
      stats.count++
      stats.avgDuration = (stats.avgDuration * (stats.count - 1) + event.duration) / stats.count
      if (event.status === "error") {
        stats.successRate = (stats.successRate * (stats.count - 1)) / stats.count
      }
    })
  }

  private updateAvgDuration(duration: number) {
    const total = this.metrics.successCount + this.metrics.errorCount
    this.metrics.avgDuration = 
      (this.metrics.avgDuration * (total - 1) + duration) / total
  }

  private recordError(error: ErrorRecord) {
    this.errors.push(error)
    // ä¿ç•™æœ€è¿‘ 100 æ¡é”™è¯¯
    if (this.errors.length > 100) {
      this.errors.shift()
    }
  }

  private generateId(): string {
    return Math.random().toString(36).substring(2, 15)
  }

  // è·å–å½“å‰æŒ‡æ ‡
  getMetrics(): Metrics {
    return { ...this.metrics }
  }

  // è·å–æœ€è¿‘çš„é”™è¯¯
  getRecentErrors(limit = 10): ErrorRecord[] {
    return this.errors.slice(-limit)
  }

  // è·å–é“¾è·¯è¿½è¸ª
  getTrace(traceId: string): Trace | undefined {
    return this.traces.get(traceId)
  }

  // è·å–æœ€è¿‘çš„é“¾è·¯
  getRecentTraces(limit = 10): Trace[] {
    return Array.from(this.traces.values())
      .sort((a, b) => b.startTime - a.startTime)
      .slice(0, limit)
  }
}
```


#### æ­¥éª¤ 3ï¼šå®ç°ä»ªè¡¨æ¿ UI

```typescript
// dashboard.ts - ç®€å•çš„ç»ˆç«¯ä»ªè¡¨æ¿

class Dashboard {
  private monitor: AgentMonitor
  private refreshInterval?: NodeJS.Timeout

  constructor(monitor: AgentMonitor) {
    this.monitor = monitor
  }

  // å¯åŠ¨ä»ªè¡¨æ¿
  start(intervalMs = 1000) {
    this.refreshInterval = setInterval(() => {
      this.render()
    }, intervalMs)
    this.render()
  }

  // åœæ­¢ä»ªè¡¨æ¿
  stop() {
    if (this.refreshInterval) {
      clearInterval(this.refreshInterval)
    }
  }

  // æ¸²æŸ“ä»ªè¡¨æ¿
  private render() {
    console.clear()
    const metrics = this.monitor.getMetrics()
    const errors = this.monitor.getRecentErrors(5)
    const traces = this.monitor.getRecentTraces(5)

    console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    console.log("â•‘              Agent æ‰§è¡Œç›‘æ§é¢æ¿                            â•‘")
    console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
    
    // è¯·æ±‚ç»Ÿè®¡
    console.log("â•‘ ğŸ“Š è¯·æ±‚ç»Ÿè®¡                                                â•‘")
    console.log(`â•‘   æ€»è¯·æ±‚: ${metrics.requestCount.toString().padEnd(10)} ` +
                `æˆåŠŸ: ${metrics.successCount.toString().padEnd(10)} ` +
                `å¤±è´¥: ${metrics.errorCount.toString().padEnd(10)}â•‘`)
    console.log(`â•‘   å¹³å‡è€—æ—¶: ${metrics.avgDuration.toFixed(0)}ms`.padEnd(63) + "â•‘")
    
    // Token ç»Ÿè®¡
    console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
    console.log("â•‘ ğŸ’° Token ä½¿ç”¨                                              â•‘")
    console.log(`â•‘   è¾“å…¥: ${metrics.totalInputTokens.toLocaleString().padEnd(12)} ` +
                `è¾“å‡º: ${metrics.totalOutputTokens.toLocaleString().padEnd(12)}`.padEnd(43) + "â•‘")
    console.log(`â•‘   æ€»æˆæœ¬: $${metrics.totalCost.toFixed(4)}`.padEnd(63) + "â•‘")
    
    // å·¥å…·ç»Ÿè®¡
    console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
    console.log("â•‘ ğŸ”§ å·¥å…·è°ƒç”¨                                                â•‘")
    for (const [tool, stats] of Object.entries(metrics.toolCalls)) {
      console.log(`â•‘   ${tool}: ${stats.count}æ¬¡, ` +
                  `æˆåŠŸç‡: ${(stats.successRate * 100).toFixed(1)}%, ` +
                  `å¹³å‡: ${stats.avgDuration.toFixed(0)}ms`.padEnd(50) + "â•‘")
    }
    
    // æœ€è¿‘é”™è¯¯
    if (errors.length > 0) {
      console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
      console.log("â•‘ âŒ æœ€è¿‘é”™è¯¯                                                â•‘")
      for (const error of errors) {
        const time = new Date(error.timestamp).toLocaleTimeString()
        console.log(`â•‘   [${time}] ${error.type}: ${error.message}`.slice(0, 62).padEnd(63) + "â•‘")
      }
    }
    
    // æœ€è¿‘è¯·æ±‚
    console.log("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
    console.log("â•‘ ğŸ“‹ æœ€è¿‘è¯·æ±‚                                                â•‘")
    for (const trace of traces) {
      const duration = trace.endTime 
        ? `${trace.endTime - trace.startTime}ms` 
        : "è¿è¡Œä¸­"
      const status = trace.status === "success" ? "âœ…" : 
                     trace.status === "error" ? "âŒ" : "â³"
      console.log(`â•‘   ${status} ${trace.traceId.slice(0, 8)} - ${duration}`.padEnd(63) + "â•‘")
    }
    
    console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    console.log("\næŒ‰ Ctrl+C é€€å‡º")
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const eventBus = new EventBus()
const monitor = new AgentMonitor(eventBus)
const dashboard = new Dashboard(monitor)

// å¯åŠ¨ä»ªè¡¨æ¿
dashboard.start()

// æ¨¡æ‹Ÿä¸€äº›äº‹ä»¶
setInterval(() => {
  const traceId = Math.random().toString(36).substring(2, 10)
  
  eventBus.publish("request.started", { traceId })
  
  setTimeout(() => {
    eventBus.publish("llm.completed", {
      traceId,
      inputTokens: Math.floor(Math.random() * 2000) + 500,
      outputTokens: Math.floor(Math.random() * 500) + 100,
      cost: Math.random() * 0.01,
    })
  }, 500)
  
  setTimeout(() => {
    eventBus.publish("tool.completed", {
      traceId,
      tool: ["read_file", "write_file", "bash"][Math.floor(Math.random() * 3)],
      duration: Math.floor(Math.random() * 200) + 50,
      status: Math.random() > 0.1 ? "success" : "error",
    })
  }, 800)
  
  setTimeout(() => {
    if (Math.random() > 0.9) {
      eventBus.publish("request.error", {
        traceId,
        errorType: "APIError",
        message: "Rate limit exceeded",
      })
    } else {
      eventBus.publish("request.completed", { traceId })
    }
  }, 1200)
}, 2000)
```

### æ‰©å±•æ€è€ƒ

1. **æŒä¹…åŒ–å­˜å‚¨**ï¼šå°†ç›‘æ§æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ï¼Œæ”¯æŒå†å²æŸ¥è¯¢
2. **å‘Šè­¦ç³»ç»Ÿ**ï¼šå½“é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦
3. **Web UI**ï¼šä½¿ç”¨ React/Vue æ„å»ºæ›´ä¸°å¯Œçš„å¯è§†åŒ–ç•Œé¢
4. **åˆ†å¸ƒå¼è¿½è¸ª**ï¼šæ”¯æŒè·¨æœåŠ¡çš„é“¾è·¯è¿½è¸ª
5. **è‡ªå®šä¹‰æŒ‡æ ‡**ï¼šæ”¯æŒç”¨æˆ·å®šä¹‰çš„ä¸šåŠ¡æŒ‡æ ‡

---


## çŸ¥è¯†è¡¥å……

### ç›¸å…³å·¥å…·å’Œæ¡†æ¶

| å·¥å…· | ç±»å‹ | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| [LangSmith](https://smith.langchain.com/) | LLM å¯è§‚æµ‹æ€§ | LangChain å®˜æ–¹ï¼ŒåŠŸèƒ½å…¨é¢ | LangChain é¡¹ç›® |
| [Langfuse](https://langfuse.com/) | LLM å¯è§‚æµ‹æ€§ | å¼€æºï¼Œè‡ªæ‰˜ç®¡ | éœ€è¦æ•°æ®éšç§ |
| [Helicone](https://helicone.ai/) | LLM ä»£ç† | ç®€å•é›†æˆï¼Œæˆæœ¬åˆ†æ | å¿«é€Ÿä¸Šæ‰‹ |
| [OpenTelemetry](https://opentelemetry.io/) | é€šç”¨å¯è§‚æµ‹æ€§ | æ ‡å‡†åŒ–ï¼Œç”Ÿæ€ä¸°å¯Œ | ä¼ä¸šçº§ç³»ç»Ÿ |
| [Jaeger](https://www.jaegertracing.io/) | åˆ†å¸ƒå¼è¿½è¸ª | å¼€æºï¼Œå¯è§†åŒ–å¥½ | å¾®æœåŠ¡æ¶æ„ |
| [Prometheus](https://prometheus.io/) | æŒ‡æ ‡ç›‘æ§ | æ—¶åºæ•°æ®åº“ï¼Œå‘Šè­¦ | æŒ‡æ ‡æ”¶é›† |
| [Grafana](https://grafana.com/) | å¯è§†åŒ– | ä»ªè¡¨æ¿ï¼Œå¤šæ•°æ®æº | æ•°æ®å±•ç¤º |

### æ¨èé˜…è¯»

**è®ºæ–‡å’Œæ–‡ç« **ï¼š
- [Dapper, a Large-Scale Distributed Systems Tracing Infrastructure](https://research.google/pubs/pub36356/) - Google åˆ†å¸ƒå¼è¿½è¸ªè®ºæ–‡
- [Observability Engineering](https://www.oreilly.com/library/view/observability-engineering/9781492076438/) - O'Reilly å¯è§‚æµ‹æ€§å·¥ç¨‹ä¹¦ç±
- [The Three Pillars of Observability](https://www.oreilly.com/library/view/distributed-systems-observability/9781492033431/ch04.html) - å¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±

**LLM å¯è§‚æµ‹æ€§**ï¼š
- [LangSmith Documentation](https://docs.smith.langchain.com/) - LangSmith å®˜æ–¹æ–‡æ¡£
- [Langfuse Documentation](https://langfuse.com/docs) - Langfuse å®˜æ–¹æ–‡æ¡£
- [Prompt Engineering Guide - Evaluation](https://www.promptingguide.ai/techniques/evaluation) - Prompt è¯„ä¼°æŒ‡å—

**OpenTelemetry**ï¼š
- [OpenTelemetry Documentation](https://opentelemetry.io/docs/) - OpenTelemetry å®˜æ–¹æ–‡æ¡£
- [OpenTelemetry JavaScript](https://opentelemetry.io/docs/instrumentation/js/) - JavaScript SDK æ–‡æ¡£

### è¡Œä¸šæœ€ä½³å®è·µ

1. **ç»“æ„åŒ–æ—¥å¿—**ï¼šä½¿ç”¨ JSON æ ¼å¼ï¼Œä¾¿äºè§£æå’ŒæŸ¥è¯¢
2. **å…³è” ID**ï¼šåœ¨æ‰€æœ‰æ—¥å¿—å’ŒæŒ‡æ ‡ä¸­åŒ…å« traceId
3. **é‡‡æ ·ç­–ç•¥**ï¼šé«˜æµé‡åœºæ™¯ä½¿ç”¨é‡‡æ ·ï¼Œå¹³è¡¡æˆæœ¬å’Œè¦†ç›–ç‡
4. **å‘Šè­¦åˆ†çº§**ï¼šåŒºåˆ† P0-P3 å‘Šè­¦çº§åˆ«ï¼Œé¿å…å‘Šè­¦ç–²åŠ³
5. **SLO å®šä¹‰**ï¼šå®šä¹‰æœåŠ¡çº§åˆ«ç›®æ ‡ï¼Œå¦‚ 99.9% å¯ç”¨æ€§

---

## æœ¬ç« å°ç»“

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¯è§‚æµ‹æ€§æ ¸å¿ƒæ¦‚å¿µ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ä¸‰å¤§æ”¯æŸ±ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Logs (æ—¥å¿—)     â†’ ç¦»æ•£äº‹ä»¶ï¼Œè¯¦ç»†ä¸Šä¸‹æ–‡              â”‚   â”‚
â”‚  â”‚  Metrics (æŒ‡æ ‡)  â†’ èšåˆæ•°æ®ï¼Œè¶‹åŠ¿åˆ†æ                â”‚   â”‚
â”‚  â”‚  Traces (é“¾è·¯)   â†’ è¯·æ±‚æµç¨‹ï¼Œå› æœå…³ç³»                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  å…³é”®æŠ€æœ¯ï¼š                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  é“¾è·¯è¿½è¸ª        â†’ Trace + Span + ä¸Šä¸‹æ–‡ä¼ æ’­         â”‚   â”‚
â”‚  â”‚  Token ç›‘æ§      â†’ ä½¿ç”¨é‡ç»Ÿè®¡ + æˆæœ¬è¿½è¸ª             â”‚   â”‚
â”‚  â”‚  é”™è¯¯å¤„ç†        â†’ åˆ†ç±» + é‡è¯•ç­–ç•¥ + æŒ‡æ•°é€€é¿        â”‚   â”‚
â”‚  â”‚  äº‹ä»¶é©±åŠ¨        â†’ å‘å¸ƒè®¢é˜… + è§£è€¦ + å¼‚æ­¥å¤„ç†        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### OpenCode ä»£ç å¯¹ç…§è¡¨

| æ¦‚å¿µ | OpenCode å®ç° | æ–‡ä»¶ä½ç½® |
|------|---------------|----------|
| é‡è¯•æœºåˆ¶ | `SessionRetry` | `session/retry.ts` |
| äº‹ä»¶æ€»çº¿ | `Bus` | `bus/index.ts` |
| äº‹ä»¶å®šä¹‰ | `BusEvent.define` | `bus/bus-event.ts` |
| æ—¥å¿—ç³»ç»Ÿ | `Log` | `util/log.ts` |
| å…¨å±€äº‹ä»¶ | `GlobalBus` | `bus/global.ts` |

### æ£€æŸ¥æ¸…å•

å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] è§£é‡Šå¯è§‚æµ‹æ€§ä¸‰å¤§æ”¯æŸ±ï¼ˆLogsã€Metricsã€Tracesï¼‰çš„ä½œç”¨
- [ ] ç†è§£ Trace å’Œ Span çš„æ¦‚å¿µåŠå…¶å…³ç³»
- [ ] è®¾è®¡ Agent ç³»ç»Ÿçš„é“¾è·¯è¿½è¸ªæ–¹æ¡ˆ
- [ ] å®ç° Token ä½¿ç”¨ç»Ÿè®¡å’Œæˆæœ¬è¿½è¸ª
- [ ] åˆ†æå·¥å…·è°ƒç”¨çš„æ€§èƒ½å’Œå¯é æ€§æŒ‡æ ‡
- [ ] ç†è§£é”™è¯¯åˆ†ç±»å’Œé‡è¯•ç­–ç•¥ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
- [ ] è®¾è®¡ç»“æ„åŒ–æ—¥å¿—æ ¼å¼
- [ ] ç†è§£äº‹ä»¶é©±åŠ¨æ¶æ„çš„ä¼˜åŠ¿
- [ ] ä½¿ç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼å®ç°ç»„ä»¶è§£è€¦
- [ ] é˜…è¯»å’Œç†è§£ OpenCode çš„å¯è§‚æµ‹æ€§å®ç°
- [ ] æ„å»ºç®€å•çš„ Agent ç›‘æ§é¢æ¿

---

## å¯¼èˆª

- [ä¸Šä¸€ç« ï¼šè®°å¿†ç³»ç»Ÿ](./05-memory-system.md)
- [è¿”å›ç›®å½•](./00-introduction.md)

---

ğŸ‰ æ­å–œä½ å®Œæˆäº† AI Agent è¿›é˜¶æ•™ç¨‹çš„å…¨éƒ¨å†…å®¹ï¼

é€šè¿‡è¿™å…­ä¸ªæ¨¡å—çš„å­¦ä¹ ï¼Œä½ å·²ç»æŒæ¡äº†æ„å»ºç”Ÿäº§çº§ Agent ç³»ç»Ÿæ‰€éœ€çš„æ ¸å¿ƒæŠ€æœ¯ï¼š

1. **ä¸Šä¸‹æ–‡å·¥ç¨‹** - é«˜æ•ˆç®¡ç†æœ‰é™çš„ä¸Šä¸‹æ–‡çª—å£
2. **Multi-Agent ç³»ç»Ÿ** - è®©å¤šä¸ª Agent åä½œå®Œæˆå¤æ‚ä»»åŠ¡
3. **å·¥å…·ç³»ç»Ÿè®¾è®¡** - æ„å»ºå®‰å…¨ã€å¯æ‰©å±•çš„å·¥å…·ç”Ÿæ€
4. **ä»£ç æ™ºèƒ½** - è®© Agent çœŸæ­£ç†è§£ä»£ç ç»“æ„
5. **è®°å¿†ç³»ç»Ÿ** - ä¸º Agent æ·»åŠ é•¿æœŸè®°å¿†èƒ½åŠ›
6. **å¯è§‚æµ‹æ€§** - ç›‘æ§å’Œè°ƒè¯• Agent è¡Œä¸º

ç°åœ¨ï¼Œä½ å·²ç»å…·å¤‡äº†æ„å»ºå¤æ‚ Agent ç³»ç»Ÿçš„ç†è®ºåŸºç¡€å’Œå®è·µèƒ½åŠ›ã€‚ç»§ç»­æ¢ç´¢ï¼Œæ„å»ºå±äºä½ çš„æ™ºèƒ½ Agentï¼
