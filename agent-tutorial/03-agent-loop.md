# ç¬¬ä¸‰ç« ï¼šAgent Loop æ ¸å¿ƒå¾ªç¯

> æœ¬ç« ç›®æ ‡ï¼šæ·±å…¥ç†è§£ Agent çš„æ ¸å¿ƒè¿è¡Œæœºåˆ¶â€”â€”Agent Loop

---

## 3.1 ä»€ä¹ˆæ˜¯ Agent Loop

### æ ¸å¿ƒæ¦‚å¿µ

Agent Loopï¼ˆä»£ç†å¾ªç¯ï¼‰æ˜¯ Agent ç³»ç»Ÿçš„"å¿ƒè„"ï¼Œå®ƒåè°ƒ LLM å’Œå·¥å…·ä¹‹é—´çš„äº¤äº’ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Agent Loop                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚   ç”¨æˆ·è¾“å…¥    â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                           â”‚                                 â”‚
â”‚                           â–¼                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚                        â”‚                     â”‚
â”‚              â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                     â”‚
â”‚         â”Œâ”€â”€â”€â–¶â”‚    â”‚  LLM æ€è€ƒ    â”‚    â”‚                     â”‚
â”‚         â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                     â”‚
â”‚         â”‚    â”‚           â”‚            â”‚                     â”‚
â”‚         â”‚    â”‚           â–¼            â”‚                     â”‚
â”‚         â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚                     â”‚
â”‚         â”‚    â”‚    â”‚  å†³å®šè¡ŒåŠ¨    â”‚    â”‚                     â”‚
â”‚         â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                     â”‚
â”‚         â”‚    â”‚           â”‚            â”‚                     â”‚
â”‚         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚         â”‚                â”‚                                  â”‚
â”‚         â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚         â”‚       â”‚                 â”‚                         â”‚
â”‚         â”‚       â–¼                 â–¼                         â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â”‚  â”‚ è°ƒç”¨å·¥å…· â”‚      â”‚ ç›´æ¥å›å¤ â”‚â”€â”€â”€â”€â”€â”€â–¶ ç»“æŸ        â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚         â”‚       â”‚                                           â”‚
â”‚         â”‚       â–¼                                           â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚         â”‚  â”‚ æ‰§è¡Œå·¥å…· â”‚                                      â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                      â”‚
â”‚         â”‚       â”‚                                           â”‚
â”‚         â”‚       â–¼                                           â”‚
â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚         â””â”€â”€â”‚ è§‚å¯Ÿç»“æœ â”‚                                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¾ªç¯çš„æœ¬è´¨

Agent Loop æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **while å¾ªç¯**ï¼š

```typescript
// ä¼ªä»£ç 
async function agentLoop(userMessage) {
  messages.push(userMessage)
  
  while (true) {
    // 1. è°ƒç”¨ LLM
    const response = await llm.generate(messages)
    
    // 2. æ£€æŸ¥æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
    if (response.hasToolCalls) {
      for (const toolCall of response.toolCalls) {
        // 3. æ‰§è¡Œå·¥å…·
        const result = await executeTool(toolCall)
        
        // 4. å°†ç»“æœåŠ å…¥æ¶ˆæ¯å†å²
        messages.push({
          role: "tool",
          content: result
        })
      }
      // ç»§ç»­å¾ªç¯ï¼Œè®© LLM çœ‹åˆ°å·¥å…·ç»“æœ
      continue
    }
    
    // 5. æ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œè¿”å›æœ€ç»ˆå›å¤
    return response.text
  }
}
```


---

## 3.2 ReAct æ¨¡å¼è¯¦è§£

### ä»€ä¹ˆæ˜¯ ReAct

ReActï¼ˆReasoning + Actingï¼‰æ˜¯ç›®å‰æœ€æµè¡Œçš„ Agent æ¨¡å¼ï¼Œç”± Google åœ¨ 2022 å¹´æå‡ºã€‚

æ ¸å¿ƒæ€æƒ³ï¼šè®© LLM **äº¤æ›¿è¿›è¡Œæ¨ç†å’Œè¡ŒåŠ¨**ã€‚

### ReAct çš„ä¸‰ä¸ªé˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ReAct æ¨¡å¼                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Thought (æ€è€ƒ)                                             â”‚
â”‚  â”œâ”€â”€ åˆ†æå½“å‰æƒ…å†µ                                           â”‚
â”‚  â”œâ”€â”€ ç¡®å®šéœ€è¦ä»€ä¹ˆä¿¡æ¯                                       â”‚
â”‚  â””â”€â”€ å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨                                         â”‚
â”‚                                                             â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚                                                             â”‚
â”‚  Action (è¡ŒåŠ¨)                                              â”‚
â”‚  â”œâ”€â”€ é€‰æ‹©åˆé€‚çš„å·¥å…·                                         â”‚
â”‚  â”œâ”€â”€ æ„é€ å·¥å…·å‚æ•°                                           â”‚
â”‚  â””â”€â”€ æ‰§è¡Œå·¥å…·è°ƒç”¨                                           â”‚
â”‚                                                             â”‚
â”‚           â”‚                                                 â”‚
â”‚           â–¼                                                 â”‚
â”‚                                                             â”‚
â”‚  Observation (è§‚å¯Ÿ)                                         â”‚
â”‚  â”œâ”€â”€ è·å–å·¥å…·æ‰§è¡Œç»“æœ                                       â”‚
â”‚  â”œâ”€â”€ åˆ†æç»“æœæ˜¯å¦æ»¡è¶³éœ€æ±‚                                   â”‚
â”‚  â””â”€â”€ å†³å®šæ˜¯å¦éœ€è¦æ›´å¤šè¡ŒåŠ¨                                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®é™…ä¾‹å­

ç”¨æˆ·è¯·æ±‚ï¼š"å¸®æˆ‘çœ‹çœ‹ src ç›®å½•ä¸‹æœ‰å“ªäº› TypeScript æ–‡ä»¶ï¼Œç„¶åè¯»å– index.ts çš„å†…å®¹"

```
Thought 1: ç”¨æˆ·æƒ³çŸ¥é“ src ç›®å½•ä¸‹çš„ TypeScript æ–‡ä»¶ï¼Œæˆ‘éœ€è¦å…ˆåˆ—å‡ºç›®å½•å†…å®¹
Action 1: glob(pattern="src/**/*.ts")
Observation 1: 
  - src/index.ts
  - src/utils/helper.ts
  - src/types/index.ts

Thought 2: æ‰¾åˆ°äº† 3 ä¸ª TypeScript æ–‡ä»¶ï¼Œç”¨æˆ·è¿˜æƒ³çœ‹ index.ts çš„å†…å®¹
Action 2: read(filePath="src/index.ts")
Observation 2:
  00001| import { helper } from './utils/helper'
  00002| 
  00003| export function main() {
  00004|   console.log('Hello, World!')
  00005| }

Thought 3: æˆ‘å·²ç»è·å–äº†æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯ï¼Œå¯ä»¥å›ç­”ç”¨æˆ·äº†
Answer: src ç›®å½•ä¸‹æœ‰ 3 ä¸ª TypeScript æ–‡ä»¶ï¼š
  1. src/index.ts
  2. src/utils/helper.ts  
  3. src/types/index.ts
  
  index.ts çš„å†…å®¹æ˜¯ä¸€ä¸ªç®€å•çš„å…¥å£æ–‡ä»¶ï¼Œå¯¼å…¥äº† helper å¹¶å¯¼å‡ºäº† main å‡½æ•°...
```

### ä¸ºä»€ä¹ˆ ReAct æœ‰æ•ˆ

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| å¯è§£é‡Šæ€§ | æ¯ä¸€æ­¥éƒ½æœ‰æ˜ç¡®çš„æ€è€ƒè¿‡ç¨‹ |
| å¯æ§æ€§ | å¯ä»¥åœ¨ä»»ä½•ä¸€æ­¥ä»‹å…¥æˆ–ä¿®æ­£ |
| çµæ´»æ€§ | å¯ä»¥æ ¹æ®è§‚å¯Ÿç»“æœåŠ¨æ€è°ƒæ•´ç­–ç•¥ |
| é²æ£’æ€§ | å·¥å…·å¤±è´¥æ—¶å¯ä»¥å°è¯•å…¶ä»–æ–¹æ³• |

---

## 3.3 æ¶ˆæ¯ä¸å¯¹è¯ç®¡ç†

### æ¶ˆæ¯ç±»å‹

åœ¨ Agent ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯æœ‰å¤šç§ç±»å‹ï¼š

```typescript
// OpenCode ä¸­çš„æ¶ˆæ¯ç±»å‹å®šä¹‰ (ç®€åŒ–ç‰ˆ)
type Message = 
  | { role: "user"; content: string }           // ç”¨æˆ·æ¶ˆæ¯
  | { role: "assistant"; content: string }      // AI å›å¤
  | { role: "assistant"; tool_calls: ToolCall[] } // AI å·¥å…·è°ƒç”¨
  | { role: "tool"; tool_call_id: string; content: string } // å·¥å…·ç»“æœ
```

### å¯¹è¯å†å²çš„é‡è¦æ€§

LLM æ˜¯**æ— çŠ¶æ€**çš„ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦ä¼ å…¥å®Œæ•´çš„å¯¹è¯å†å²ï¼š

```typescript
// ç¬¬ä¸€è½®
messages = [
  { role: "user", content: "è¯»å– package.json" }
]
response = await llm.generate(messages)
// response: tool_call read(filePath="package.json")

// ç¬¬äºŒè½®ï¼ˆåŒ…å«ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯ï¼‰
messages = [
  { role: "user", content: "è¯»å– package.json" },
  { role: "assistant", tool_calls: [{ name: "read", args: {...} }] },
  { role: "tool", content: '{"name": "opencode", ...}' }
]
response = await llm.generate(messages)
// response: "package.json çš„å†…å®¹æ˜¯..."
```

### OpenCode çš„æ¶ˆæ¯ç®¡ç†

æ‰“å¼€ `packages/opencode/src/session/message-v2.ts`ï¼š

```typescript
export namespace MessageV2 {
  // æ¶ˆæ¯çš„åŸºç¡€ä¿¡æ¯
  export const Info = z.object({
    id: z.string(),
    sessionID: z.string(),
    role: z.enum(["user", "assistant"]),
    time: z.object({
      created: z.number(),
      completed: z.number().optional(),
    }),
    // ...
  })
  
  // æ¶ˆæ¯çš„ç»„æˆéƒ¨åˆ†
  export type Part = 
    | TextPart       // æ–‡æœ¬å†…å®¹
    | ToolPart       // å·¥å…·è°ƒç”¨
    | ReasoningPart  // æ¨ç†è¿‡ç¨‹
    | StepPart       // æ­¥éª¤æ ‡è®°
    | PatchPart      // æ–‡ä»¶å˜æ›´
}
```


---

## 3.4 OpenCode çš„ Agent Loop å®ç°

### æ ¸å¿ƒæ–‡ä»¶

Agent Loop çš„å®ç°ä¸»è¦åœ¨ `packages/opencode/src/session/processor.ts`ã€‚

### ä»£ç è§£æ

```typescript
// processor.ts æ ¸å¿ƒé€»è¾‘ï¼ˆç®€åŒ–ç‰ˆï¼‰
export namespace SessionProcessor {
  export function create(input: {
    assistantMessage: MessageV2.Assistant
    sessionID: string
    model: Provider.Model
    abort: AbortSignal
  }) {
    return {
      async process(streamInput: LLM.StreamInput) {
        // ä¸»å¾ªç¯
        while (true) {
          try {
            // 1. è°ƒç”¨ LLMï¼Œè·å–æµå¼å“åº”
            const stream = await LLM.stream(streamInput)
            
            // 2. å¤„ç†æµå¼å“åº”
            for await (const value of stream.fullStream) {
              switch (value.type) {
                // 2.1 æ–‡æœ¬è¾“å‡º
                case "text-delta":
                  // å®æ—¶æ›´æ–°æ–‡æœ¬å†…å®¹
                  currentText.text += value.text
                  await Session.updatePart({ part: currentText, delta: value.text })
                  break
                
                // 2.2 å·¥å…·è°ƒç”¨å¼€å§‹
                case "tool-call":
                  // è®°å½•å·¥å…·è°ƒç”¨ï¼Œå‡†å¤‡æ‰§è¡Œ
                  toolcalls[value.toolCallId] = {
                    tool: value.toolName,
                    state: { status: "running", input: value.input }
                  }
                  break
                
                // 2.3 å·¥å…·æ‰§è¡Œå®Œæˆ
                case "tool-result":
                  // æ›´æ–°å·¥å…·çŠ¶æ€ä¸ºå®Œæˆ
                  await Session.updatePart({
                    ...match,
                    state: {
                      status: "completed",
                      output: value.output.output,
                    }
                  })
                  break
                
                // 2.4 å·¥å…·æ‰§è¡Œé”™è¯¯
                case "tool-error":
                  await Session.updatePart({
                    ...match,
                    state: {
                      status: "error",
                      error: value.error.toString(),
                    }
                  })
                  // æ£€æŸ¥æ˜¯å¦æ˜¯æƒé™æ‹’ç»
                  if (value.error instanceof PermissionNext.RejectedError) {
                    blocked = true
                  }
                  break
                
                // 2.5 æ­¥éª¤å®Œæˆ
                case "finish-step":
                  // è®¡ç®— token ä½¿ç”¨é‡å’Œæˆæœ¬
                  const usage = Session.getUsage({
                    model: input.model,
                    usage: value.usage,
                  })
                  // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸Šä¸‹æ–‡å‹ç¼©
                  if (await SessionCompaction.isOverflow({ tokens: usage.tokens })) {
                    needsCompaction = true
                  }
                  break
              }
            }
          } catch (e) {
            // 3. é”™è¯¯å¤„ç†å’Œé‡è¯•
            const retry = SessionRetry.retryable(error)
            if (retry !== undefined) {
              attempt++
              await SessionRetry.sleep(delay, input.abort)
              continue  // é‡è¯•
            }
            // ä¸å¯é‡è¯•çš„é”™è¯¯
            input.assistantMessage.error = error
            break
          }
          
          // 4. åˆ¤æ–­æ˜¯å¦ç»§ç»­å¾ªç¯
          if (needsCompaction) return "compact"
          if (blocked) return "stop"
          if (input.assistantMessage.error) return "stop"
          return "continue"
        }
      }
    }
  }
}
```

### æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SessionProcessor.process()                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  while (true) {                                             â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€â–¶ LLM.stream() â”€â”€â–¶ è·å–æµå¼å“åº”                       â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€â–¶ for await (value of stream) {                       â”‚
â”‚    â”‚      â”‚                                                 â”‚
â”‚    â”‚      â”œâ”€â”€ text-delta â”€â”€â–¶ æ›´æ–°æ–‡æœ¬                       â”‚
â”‚    â”‚      â”œâ”€â”€ tool-call â”€â”€â–¶ è®°å½•å·¥å…·è°ƒç”¨                    â”‚
â”‚    â”‚      â”œâ”€â”€ tool-result â”€â”€â–¶ ä¿å­˜ç»“æœ                      â”‚
â”‚    â”‚      â”œâ”€â”€ tool-error â”€â”€â–¶ å¤„ç†é”™è¯¯                       â”‚
â”‚    â”‚      â””â”€â”€ finish-step â”€â”€â–¶ è®¡ç®—ç”¨é‡                      â”‚
â”‚    â”‚    }                                                   â”‚
â”‚    â”‚                                                        â”‚
â”‚    â”œâ”€â”€â–¶ æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼© â”€â”€â–¶ return "compact"               â”‚
â”‚    â”œâ”€â”€â–¶ æ£€æŸ¥æ˜¯å¦è¢«é˜»æ­¢ â”€â”€â–¶ return "stop"                    â”‚
â”‚    â””â”€â”€â–¶ æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ â”€â”€â–¶ return "stop"                    â”‚
â”‚                                                             â”‚
â”‚    // å¦‚æœæœ‰å·¥å…·è°ƒç”¨ï¼Œç»§ç»­å¾ªç¯è®© LLM çœ‹åˆ°ç»“æœ                â”‚
â”‚    // å¦‚æœæ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œå¾ªç¯è‡ªç„¶ç»“æŸ                         â”‚
â”‚  }                                                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3.5 LLM è°ƒç”¨è¯¦è§£

### LLM.stream() å‡½æ•°

æ‰“å¼€ `packages/opencode/src/session/llm.ts`ï¼š

```typescript
export namespace LLM {
  export async function stream(input: StreamInput) {
    // 1. è·å–è¯­è¨€æ¨¡å‹
    const language = await Provider.getLanguage(input.model)
    
    // 2. æ„å»ºç³»ç»Ÿæç¤ºè¯
    const system = SystemPrompt.header(input.model.providerID)
    system.push([
      // Agent è‡ªå®šä¹‰æç¤ºè¯
      ...(input.agent.prompt ? [input.agent.prompt] : SystemPrompt.provider(input.model)),
      // è°ƒç”¨æ—¶ä¼ å…¥çš„é¢å¤–æç¤ºè¯
      ...input.system,
      // ç”¨æˆ·æ¶ˆæ¯ä¸­çš„ç³»ç»Ÿæç¤ºè¯
      ...(input.user.system ? [input.user.system] : []),
    ].join("\n"))
    
    // 3. è§£æå¯ç”¨å·¥å…·ï¼ˆæ ¹æ®æƒé™è¿‡æ»¤ï¼‰
    const tools = await resolveTools(input)
    
    // 4. è°ƒç”¨ Vercel AI SDK
    return streamText({
      model: language,
      messages: [
        // ç³»ç»Ÿæç¤ºè¯
        ...system.map(x => ({ role: "system", content: x })),
        // å¯¹è¯å†å²
        ...input.messages,
      ],
      tools,
      maxOutputTokens: OUTPUT_TOKEN_MAX,
      temperature: input.agent.temperature,
      abortSignal: input.abort,
    })
  }
}
```

### å·¥å…·è¿‡æ»¤

```typescript
async function resolveTools(input) {
  // æ ¹æ® Agent æƒé™è¿‡æ»¤å·¥å…·
  const disabled = PermissionNext.disabled(
    Object.keys(input.tools), 
    input.agent.permission
  )
  
  for (const tool of Object.keys(input.tools)) {
    // ç”¨æˆ·ç¦ç”¨çš„å·¥å…·
    if (input.user.tools?.[tool] === false) {
      delete input.tools[tool]
    }
    // æƒé™ç¦ç”¨çš„å·¥å…·
    if (disabled.has(tool)) {
      delete input.tools[tool]
    }
  }
  
  return input.tools
}
```


---

## 3.6 Doom Loop æ£€æµ‹

### ä»€ä¹ˆæ˜¯ Doom Loop

Doom Loopï¼ˆæ­»å¾ªç¯ï¼‰æ˜¯æŒ‡ Agent åå¤æ‰§è¡Œç›¸åŒçš„å·¥å…·è°ƒç”¨ï¼Œæ— æ³•å–å¾—è¿›å±•ã€‚

ä¾‹å¦‚ï¼š
```
Action: read(filePath="config.json")
Observation: File not found
Action: read(filePath="config.json")  // åˆå°è¯•è¯»å–åŒä¸€ä¸ªä¸å­˜åœ¨çš„æ–‡ä»¶
Observation: File not found
Action: read(filePath="config.json")  // ç»§ç»­...
...
```

### OpenCode çš„æ£€æµ‹æœºåˆ¶

```typescript
// processor.ts ä¸­çš„ Doom Loop æ£€æµ‹
const DOOM_LOOP_THRESHOLD = 3

case "tool-call": {
  // è·å–æœ€è¿‘çš„å·¥å…·è°ƒç”¨
  const parts = await MessageV2.parts(input.assistantMessage.id)
  const lastThree = parts.slice(-DOOM_LOOP_THRESHOLD)
  
  // æ£€æŸ¥æ˜¯å¦è¿ç»­ 3 æ¬¡ç›¸åŒçš„å·¥å…·è°ƒç”¨
  if (
    lastThree.length === DOOM_LOOP_THRESHOLD &&
    lastThree.every(p =>
      p.type === "tool" &&
      p.tool === value.toolName &&
      JSON.stringify(p.state.input) === JSON.stringify(value.input)
    )
  ) {
    // è§¦å‘ Doom Loop æƒé™æ£€æŸ¥
    await PermissionNext.ask({
      permission: "doom_loop",
      patterns: [value.toolName],
      metadata: {
        tool: value.toolName,
        input: value.input,
      },
    })
  }
  break
}
```

### å¤„ç†ç­–ç•¥

å½“æ£€æµ‹åˆ° Doom Loop æ—¶ï¼ŒOpenCode ä¼šï¼š
1. æš‚åœæ‰§è¡Œ
2. è¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­
3. ç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š
   - å…è®¸ç»§ç»­ï¼ˆå¯èƒ½ Agent æœ‰å…¶ä»–è®¡åˆ’ï¼‰
   - æ‹’ç»å¹¶æä¾›æ–°çš„æŒ‡ç¤º
   - å®Œå…¨åœæ­¢

---

## 3.7 åŠ¨æ‰‹å®éªŒï¼šè·Ÿè¸ª Agent Loop

### å®éªŒç›®æ ‡

é€šè¿‡æ·»åŠ æ—¥å¿—ï¼Œè§‚å¯Ÿ Agent Loop çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹ã€‚

### æ­¥éª¤ 1ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—

åœ¨ `packages/opencode/src/session/processor.ts` ä¸­æ·»åŠ æ—¥å¿—ï¼š

```typescript
// åœ¨ process å‡½æ•°å¼€å¤´æ·»åŠ 
console.log("ğŸ”„ Agent Loop å¼€å§‹")

// åœ¨ switch è¯­å¥ä¸­æ·»åŠ 
case "tool-call":
  console.log(`ğŸ”§ å·¥å…·è°ƒç”¨: ${value.toolName}`, value.input)
  break

case "tool-result":
  console.log(`âœ… å·¥å…·ç»“æœ: ${value.toolName}`)
  break

case "text-delta":
  // åªæ‰“å°å‰ 50 ä¸ªå­—ç¬¦
  if (currentText.text.length < 50) {
    console.log(`ğŸ“ æ–‡æœ¬: ${value.text}`)
  }
  break
```

### æ­¥éª¤ 2ï¼šè¿è¡Œæµ‹è¯•

```bash
cd packages/opencode && bun dev
```

è¾“å…¥ä¸€ä¸ªéœ€è¦å¤šæ­¥å·¥å…·è°ƒç”¨çš„è¯·æ±‚ï¼š
```
åˆ—å‡º src ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œç„¶åè¯»å–å…¶ä¸­æœ€å¤§çš„é‚£ä¸ªæ–‡ä»¶
```

### æ­¥éª¤ 3ï¼šè§‚å¯Ÿè¾“å‡º

ä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—ï¼š

```
ğŸ”„ Agent Loop å¼€å§‹
ğŸ“ æ–‡æœ¬: æˆ‘
ğŸ“ æ–‡æœ¬: éœ€è¦
ğŸ“ æ–‡æœ¬: å…ˆåˆ—å‡º
ğŸ”§ å·¥å…·è°ƒç”¨: glob { pattern: "src/**/*" }
âœ… å·¥å…·ç»“æœ: glob
ğŸ“ æ–‡æœ¬: æ‰¾åˆ°äº†
ğŸ“ æ–‡æœ¬: ä»¥ä¸‹æ–‡ä»¶
ğŸ”§ å·¥å…·è°ƒç”¨: bash { command: "ls -la src/index.ts" }
âœ… å·¥å…·ç»“æœ: bash
ğŸ”§ å·¥å…·è°ƒç”¨: read { filePath: "src/index.ts" }
âœ… å·¥å…·ç»“æœ: read
ğŸ“ æ–‡æœ¬: æœ€å¤§çš„æ–‡ä»¶æ˜¯
...
```

### æ­¥éª¤ 4ï¼šåˆ†ææ‰§è¡Œæµç¨‹

ç”»å‡ºä½ è§‚å¯Ÿåˆ°çš„æ‰§è¡Œæµç¨‹å›¾ï¼š

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
Thought: éœ€è¦åˆ—å‡ºæ–‡ä»¶
    â”‚
    â–¼
Action: glob
    â”‚
    â–¼
Observation: æ–‡ä»¶åˆ—è¡¨
    â”‚
    â–¼
Thought: éœ€è¦æ‰¾æœ€å¤§çš„æ–‡ä»¶
    â”‚
    â–¼
Action: bash (ls -la)
    â”‚
    â–¼
Observation: æ–‡ä»¶å¤§å°ä¿¡æ¯
    â”‚
    â–¼
Thought: æœ€å¤§çš„æ˜¯ index.ts
    â”‚
    â–¼
Action: read
    â”‚
    â–¼
Observation: æ–‡ä»¶å†…å®¹
    â”‚
    â–¼
Answer: æœ€ç»ˆå›å¤
```

---

## 3.8 çŸ¥è¯†è¡¥å……ï¼šå…¶ä»– Agent æ¶æ„

### Plan-and-Execute

å…ˆåˆ¶å®šå®Œæ•´è®¡åˆ’ï¼Œå†é€æ­¥æ‰§è¡Œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Plan-and-Execute                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. Planning Phase (è§„åˆ’é˜¶æ®µ)                               â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€â”€â–¶ åˆ†æä»»åŠ¡ â”€â”€â–¶ åˆ¶å®šæ­¥éª¤ â”€â”€â–¶ ç”Ÿæˆè®¡åˆ’                 â”‚
â”‚                                                             â”‚
â”‚  2. Execution Phase (æ‰§è¡Œé˜¶æ®µ)                              â”‚
â”‚     â”‚                                                       â”‚
â”‚     â””â”€â”€â–¶ æ­¥éª¤1 â”€â”€â–¶ æ­¥éª¤2 â”€â”€â–¶ æ­¥éª¤3 â”€â”€â–¶ ... â”€â”€â–¶ å®Œæˆ        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

é€‚ç”¨åœºæ™¯ï¼šå¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡

### Tree of Thoughts

æ¢ç´¢å¤šä¸ªå¯èƒ½çš„è·¯å¾„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Tree of Thoughts                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚                      é—®é¢˜                                   â”‚
â”‚                        â”‚                                    â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚            â–¼          â–¼          â–¼                         â”‚
â”‚         æ€è·¯A       æ€è·¯B       æ€è·¯C                       â”‚
â”‚            â”‚          â”‚          â”‚                         â”‚
â”‚         è¯„ä¼°        è¯„ä¼°        è¯„ä¼°                        â”‚
â”‚            â”‚          â”‚          â”‚                         â”‚
â”‚         æ”¾å¼ƒ      â”Œâ”€â”€â”´â”€â”€â”      æ”¾å¼ƒ                        â”‚
â”‚                   â–¼     â–¼                                  â”‚
â”‚                 B1     B2                                  â”‚
â”‚                   â”‚     â”‚                                  â”‚
â”‚                 è¯„ä¼°   è¯„ä¼°                                 â”‚
â”‚                   â”‚                                        â”‚
â”‚                 æœ€ä¼˜è§£                                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

é€‚ç”¨åœºæ™¯ï¼šéœ€è¦å›æº¯å’Œæ¯”è¾ƒçš„å¤æ‚æ¨ç†

### Multi-Agent

å¤šä¸ª Agent åä½œï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Multi-Agent                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ Coordinator â”‚ â—€â”€â”€â”€â”€ ç”¨æˆ·è¯·æ±‚                            â”‚
â”‚  â”‚   åè°ƒè€…     â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚         â”‚                                                   â”‚
â”‚    åˆ†é…ä»»åŠ¡                                                 â”‚
â”‚         â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚  â–¼      â–¼      â–¼          â–¼                                â”‚
â”‚ Agent1 Agent2 Agent3 ... AgentN                            â”‚
â”‚ æœç´¢   ç¼–ç    æµ‹è¯•       æ–‡æ¡£                               â”‚
â”‚  â”‚      â”‚      â”‚          â”‚                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚    æ±‡æ€»ç»“æœ â”€â”€â–¶ æœ€ç»ˆè¾“å‡º                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

OpenCode é€šè¿‡ `task` å·¥å…·æ”¯æŒè¿™ç§æ¨¡å¼ã€‚

---

## 3.9 æœ¬ç« å°ç»“

### æ ¸å¿ƒæ¦‚å¿µå›é¡¾

1. **Agent Loop** æ˜¯åè°ƒ LLM å’Œå·¥å…·çš„æ ¸å¿ƒå¾ªç¯
2. **ReAct** æ¨¡å¼ï¼šThought â†’ Action â†’ Observation
3. **æ¶ˆæ¯ç®¡ç†**ï¼šç»´æŠ¤å®Œæ•´çš„å¯¹è¯å†å²
4. **Doom Loop æ£€æµ‹**ï¼šé˜²æ­¢æ— é™å¾ªç¯

### OpenCode å®ç°å¯¹ç…§

| æ¦‚å¿µ | å®ç°ä½ç½® |
|------|---------|
| Agent Loop | `src/session/processor.ts` |
| LLM è°ƒç”¨ | `src/session/llm.ts` |
| æ¶ˆæ¯ç®¡ç† | `src/session/message-v2.ts` |
| æµå¼å¤„ç† | Vercel AI SDK `streamText` |

### æ£€æŸ¥æ¸…å•

- [ ] ç†è§£ Agent Loop çš„å·¥ä½œåŸç†
- [ ] æŒæ¡ ReAct æ¨¡å¼çš„ä¸‰ä¸ªé˜¶æ®µ
- [ ] äº†è§£æ¶ˆæ¯åœ¨ Agent ç³»ç»Ÿä¸­çš„æµè½¬
- [ ] å®Œæˆäº†è·Ÿè¸ªå®éªŒï¼Œè§‚å¯Ÿåˆ°å®Œæ•´çš„æ‰§è¡Œæµç¨‹
- [ ] äº†è§£ Doom Loop æ£€æµ‹æœºåˆ¶

---

[â† ä¸Šä¸€ç« ï¼šå·¥å…·ç³»ç»Ÿ](./02-tools.md) | [ä¸‹ä¸€ç« ï¼šPrompt Engineering â†’](./04-prompt-engineering.md)
