# OpenCode 项目架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              OpenCode 整体架构                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │
│  │   CLI/TUI   │  │   Desktop   │  │  Web Console│  │      SDK (JS/TS)        │ │
│  │ (Terminal)  │  │    App      │  │             │  │                         │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └───────────┬─────────────┘ │
│         │                │                │                     │               │
│         └────────────────┴────────────────┴─────────────────────┘               │
│                                    │                                            │
│                                    ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                         Server (HTTP/WebSocket)                          │   │
│  │                    packages/opencode/src/server                          │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                            │
│                                    ▼                                            │
│  ┌──────────────────────────────────────────────────────────────────────────┐   │
│  │                              Core Engine                                 │   │
│  │                        packages/opencode/src                             │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 核心 Agent 架构 (packages/opencode/src)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Agent 核心架构                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           Session (会话管理)                             │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐    │    │
│  │  │   index.ts  │ │   llm.ts    │ │  prompt.ts  │ │   message.ts    │    │    │
│  │  │  会话生命周期 │ │  LLM 流处理  │ │  提示词管理  │ │   消息存储      │    │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘    │    │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                        │    │
│  │  │ system.ts   │ │ compaction  │ │  summary.ts │                        │    │
│  │  │ 系统提示词   │ │  上下文压缩  │ │   会话摘要   │                        │    │
│  │  └─────────────┘ └─────────────┘ └─────────────┘                        │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                       │                                         │
│                                       ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                           Agent (代理定义)                               │    │
│  │  ┌───────────────────────────────────────────────────────────────────┐  │    │
│  │  │                        内置 Agents                                 │  │    │
│  │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐  │  │    │
│  │  │  │  build  │ │  plan   │ │ general │ │ explore │ │  compaction │  │  │    │
│  │  │  │ 默认开发 │ │ 只读分析 │ │ 子代理  │ │ 代码探索 │ │  上下文压缩  │  │  │    │
│  │  │  │ 全权限   │ │ 规划模式 │ │ 多任务  │ │ 快速搜索 │ │             │  │  │    │
│  │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────────┘  │  │    │
│  │  └───────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                         │    │
│  │  • 权限控制 (PermissionNext)    • 模型配置 (model/providerID)           │    │
│  │  • 自定义提示词 (prompt)         • 温度/TopP 参数                        │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                       │                                         │
│              ┌────────────────────────┼────────────────────────┐                │
│              ▼                        ▼                        ▼                │
│  ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────────┐      │
│  │  Provider (模型)   │   │   Tool (工具)      │   │    MCP (扩展协议)      │      │
│  │                   │   │                   │   │                       │      │
│  │ ┌───────────────┐ │   │ ┌───────────────┐ │   │ ┌───────────────────┐ │      │
│  │ │   Anthropic   │ │   │ │     bash      │ │   │ │  Local (stdio)    │ │      │
│  │ │    OpenAI     │ │   │ │     read      │ │   │ │  Remote (HTTP)    │ │      │
│  │ │    Google     │ │   │ │     edit      │ │   │ │  OAuth 支持        │ │      │
│  │ │   Bedrock     │ │   │ │     write     │ │   │ └───────────────────┘ │      │
│  │ │   OpenRouter  │ │   │ │     grep      │ │   │                       │      │
│  │ │    Azure      │ │   │ │     glob      │ │   │ • 动态工具注册         │      │
│  │ │   Vertex      │ │   │ │     task      │ │   │ • Prompts 支持        │      │
│  │ │   Groq        │ │   │ │   websearch   │ │   │                       │      │
│  │ │   xAI         │ │   │ │   webfetch    │ │   └───────────────────────┘      │
│  │ │   Mistral     │ │   │ │   codesearch  │ │                                  │
│  │ │   Cerebras    │ │   │ │     lsp       │ │                                  │
│  │ │   ...更多     │ │   │ │     todo      │ │                                  │
│  │ └───────────────┘ │   │ │    skill      │ │                                  │
│  │                   │   │ │   multiedit   │ │                                  │
│  │ • 模型能力检测    │   │ │     batch     │ │                                  │
│  │ • 成本计算        │   │ └───────────────┘ │                                  │
│  │ • 自动认证        │   │                   │                                  │
│  │ • 区域路由        │   │ • 权限检查        │                                  │
│  └───────────────────┘   │ • 参数验证        │                                  │
│                          │ • 插件扩展        │                                  │
│                          └───────────────────┘                                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 数据流

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              请求处理流程                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   用户输入                                                                       │
│      │                                                                          │
│      ▼                                                                          │
│  ┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐   │
│  │ Session │───▶│   Agent     │───▶│   LLM.ts    │───▶│    Provider         │   │
│  │ 创建/获取│    │  选择/配置   │    │  流式处理    │    │   API 调用          │   │
│  └─────────┘    └─────────────┘    └─────────────┘    └─────────────────────┘   │
│                                           │                                     │
│                                           ▼                                     │
│                                    ┌─────────────┐                              │
│                                    │  AI Model   │                              │
│                                    │  (Claude等) │                              │
│                                    └─────────────┘                              │
│                                           │                                     │
│                                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         Tool Execution (工具执行)                        │   │
│  │                                                                         │   │
│  │   AI 返回 tool_call  ──▶  ToolRegistry 查找  ──▶  权限检查  ──▶  执行    │   │
│  │                                                                         │   │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐      │   │
│  │   │  bash   │  │  edit   │  │  read   │  │  grep   │  │  MCP    │      │   │
│  │   │ 执行命令 │  │ 编辑文件 │  │ 读取文件 │  │ 搜索代码 │  │ 外部工具 │      │   │
│  │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                           │                                     │
│                                           ▼                                     │
│                                    ┌─────────────┐                              │
│                                    │  Message    │                              │
│                                    │   存储响应   │                              │
│                                    └─────────────┘                              │
│                                           │                                     │
│                                           ▼                                     │
│                                      输出给用户                                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 支撑模块

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              支撑模块                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   Config    │  │   Storage   │  │    Auth     │  │  Permission │            │
│  │   配置管理   │  │   数据持久化 │  │   认证管理   │  │   权限控制   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │     LSP     │  │   Snapshot  │  │   Plugin    │  │     Bus     │            │
│  │  语言服务    │  │   快照/回滚  │  │   插件系统   │  │   事件总线   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │    File     │  │   Project   │  │    Shell    │  │     PTY     │            │
│  │   文件操作   │  │   项目管理   │  │   Shell集成  │  │  伪终端     │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 关键设计特点

1. **多 Agent 架构**: 内置 build/plan/general/explore 等多个专用 Agent，可通过配置扩展
2. **Provider 无关**: 支持 20+ AI 提供商，通过统一接口调用
3. **工具系统**: 内置丰富工具 + MCP 协议扩展 + 插件系统
4. **权限控制**: 细粒度的工具和文件访问权限管理
5. **客户端/服务器分离**: 支持 TUI、Desktop、Web 等多种前端
6. **流式处理**: 基于 Vercel AI SDK 的流式响应
